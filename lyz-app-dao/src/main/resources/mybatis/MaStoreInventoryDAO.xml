<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.MaStoreInventoryDAO">

    <select id="findStoreInventoryByStoreIdAndGoodsId"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.MaStoreInventory">
        SELECT
        id,
        city_id,
        city_name,
        city_code,
        store_id,
        store_name,
        store_code,
        gid,
        sku,
        sku_name,
        available_ity,
        real_ity,
        last_update_time
        FROM st_inventory
        WHERE store_id = #{storeId} AND gid = #{goodsId}
    </select>


    <update id="updateStoreInventory">
        UPDATE st_inventory
        <if test="null != goodsQty">
            SET real_ity = #{goodsQty}
        </if>
        WHERE
        gid = #{goodsId}
        AND
        store_id = #{storeId}
        AND
        last_update_time = #{date}
    </update>


    <update id="updateStoreInventoryAndAvailableIty">
        UPDATE st_inventory
        <set>
            <if test="null != goodsQty">
                 real_ity = #{goodsQty},
            </if>
            <if test="null != goodsAvailableIty">
                 available_ity = #{goodsAvailableIty}
            </if>
        </set>
        WHERE
        gid = #{goodsId}
        AND
        store_id = #{storeId}
        AND
        last_update_time = #{date}
    </update>

    <insert id="addInventoryChangeLog"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.management.store.MaStoreInventoryChange">
        INSERT st_inventory_available_qty_change_log
        (city_id,city_name,store_id,store_name,store_code,gid,sku,sku_name,change_time,change_qty,after_change_qty,reference_number,change_type,change_type_desc)
        VALUES
        (#{cityId},#{cityName},#{storeId},#{storeName},#{storeCode},#{gid},#{sku},#{skuName},#{changeTime},#{changeQty},#{afterChangeQty},#{referenceNumber},#{changeType},#{changeTypeDesc})
    </insert>


    <insert id="addRealInventoryChangeLog"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.management.store.MaStoreRealInventoryChange">
        INSERT st_inventory_real_qty_change_log
        (city_id,city_name,store_id,store_name,store_code,gid,sku,sku_name,change_time,change_qty,after_change_qty,reference_number,change_type,change_type_desc)
        VALUES
        (#{cityId},#{cityName},#{storeId},#{storeName},#{storeCode},#{gid},#{sku},#{skuName},#{changeTime},#{changeQty},#{afterChangeQty},#{referenceNumber},#{changeType},#{changeTypeDesc})
    </insert>


    <insert id="saveStoreInventory"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.management.store.MaStoreInventory">
        INSERT st_inventory
        (create_time,last_update_time,city_id,city_code,city_name,store_id,store_code,store_name,gid,sku,sku_name,available_ity,real_ity)
        VALUES
        (#{createTime},#{lastUpdateTime},#{cityId},#{cityCode},#{cityName},#{storeId},#{storeCode},#{storeName},#{gid},#{sku},#{skuName},#{availableIty},#{realIty})
    </insert>


    <select id="queryStoresGoodRequirePageVO"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.StoreReturnAndRequireGoodsInf">
            SELECT
          a.trans_number,
          b.store_name,
          a.ship_date,
          a.item_code,
          c.sku_name,
          a.quantity
        FROM inter_eta_store_goods_trans_inf a
        LEFT JOIN  st_store b on a.diy_site_code =b.store_code
        LEFT JOIN  gds_goods c on a.item_code = c.sku
        WHERE trans_type ='门店要货'
        <if test="null != structureCode  and '-1'!= structureCode">
            AND  b.store_structure_code LIKE concat('%',#{structureCode},'%')
        </if>
        <if test="null != storeId and -1 != storeId">
            AND b.store_id = #{storeId}
        </if>
        <if test="null != queryInfo  and ''!= queryInfo">
            AND a.item_code LIKE concat('%',#{queryInfo},'%')
        </if>
        AND b.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>


    <select id="queryStoresGoodReturnPageVO"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.StoreReturnAndRequireGoodsInf">
        SELECT
          a.trans_number,
          b.store_name,
          a.ship_date,
          a.item_code,
          c.sku_name,
          a.quantity
        FROM inter_eta_store_goods_trans_inf a
        LEFT JOIN  st_store b on a.diy_site_code =b.store_code
        LEFT JOIN  gds_goods c on a.item_code = c.sku
        WHERE trans_type ='门店退货'
        <if test="null != structureCode  and '-1'!= structureCode">
            AND  b.store_structure_code LIKE concat('%',#{structureCode},'%')
        </if>
        <if test="null != storeId and  -1!= storeId">
            AND b.store_id = #{storeId}
        </if>
        <if test="null != queryInfo  and ''!= queryInfo">
            AND a.item_code LIKE concat('%',#{queryInfo},'%')
        </if>
        AND b.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

</mapper>