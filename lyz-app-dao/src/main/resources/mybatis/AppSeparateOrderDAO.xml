<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.AppSeparateOrderDAO">

    <select id="isOrderExist" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT exists(SELECT 1
                      FROM inter_ate_order_base_inf
                      WHERE main_order_number = #{orderNumber})
    </select>

    <insert id="saveOrderBaseInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderBaseInf"
            useGeneratedKeys="true" keyProperty="orderHeaderId">
        INSERT INTO inter_ate_order_base_inf (create_time, order_subject_type, send_flag, error_msg, send_time,
                                              main_order_number, order_number,
                                              sob_id, order_date, product_type, order_type_id, user_id, sales_consult_id,
                                              coupon_flag, invoice_flag, credit_flag, store_org_id, diy_site_code, delivery_type_title,
                                              order_amt, rec_amt, lebi_discount, store_subvention_discount, promotion_discount,
                                              member_discount, cash_coupon_discount, product_coupon_discount)
        VALUES (
            #{createTime}, #{orderSubjectType}, #{sendFlag}, #{errorMsg}, #{sendTime}, #{mainOrderNumber},
                           #{orderNumber}, #{sobId},
                           #{orderDate}, #{productType},
                           #{orderTypeId}, #{userId}, #{salesConsultId}, #{couponFlag}, #{invoiceFlag}, #{creditFlag},
                                           #{storeOrgId}, #{diySiteCode}, #{deliveryTypeTitle},
                                           #{orderAmt}, #{recAmt}, #{lebiDiscount},
            #{storeSubventionDiscount}, #{promotionDiscount}, #{memberDiscount}, #{cashCouponDiscount},
            #{productCouponDiscount}
        )
    </insert>

    <insert id="saveOrderGoodsInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderGoodsInf">
        INSERT INTO inter_ate_order_goods_inf (order_header_id, create_time, send_flag, error_msg, send_time, main_order_line_id, main_order_number, order_number,
                                               sku, goods_title, quantity, ls_price,
                                               hy_price, jx_price, settlement_price, return_price, lebi_discount, subvention_discount,
                                               cash_coupon_discount, promotion_discount, discount_total_price, gift_flag, promotion_id, product_type)
        VALUES
            (#{orderHeaderId}, #{createTime}, #{sendFlag}, #{errorMsg}, #{sendTime}, #{mainOrderLineId},
                               #{mainOrderNumber},
                               #{orderNumber},
                               #{sku}, #{goodsTitle}, #{quantity}, #{lsPrice}, #{hyPrice},
                                                                   #{jxPrice}, #{settlementPrice},
                                                                   #{returnPrice}, #{lebiDiscount},
                                                                   #{subventionDiscount},
                                                                   #{cashCouponDiscount},
                                                                   #{promotionDiscount},
                                                                   #{discountTotalPrice}, #{giftFlag},
             #{promotionId}, #{productType})
    </insert>

    <insert id="saveOrderCouponInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderCouponInf">
        INSERT INTO inter_ate_order_coupon_inf (main_order_number, create_time, send_flag, error_msg, send_time, history_flag,
                                                get_type, product_type, buy_price, cost_price, coupon_id, sku, quantity, coupon_type_id,
                                                sob_id, promotion, attribute1, attribute2, attribute3, attribute4)
        VALUES (#{mainOrderNumber}, #{createTime}, #{sendFlag}, #{errorMsg}, #{sendTime}, #{historyFlag}, #{getType},
                                    #{productType}, #{buyPrice},
                                    #{costPrice}, #{couponId}, #{sku}, #{quantity}, #{couponTypeId}, #{sobId},
                #{promotion},
                #{attribute1}, #{attribute2}, #{attribute3}, #{attribute4})
    </insert>

    <insert id="saveOrderReceiptInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderReceiptInf">
        INSERT INTO inter_ate_order_receipt_inf (create_time, send_flag, error_msg, send_time, main_order_number, receipt_number,
                                                 receipt_type, store_org_id, diy_site_code, receipt_date, amount, description,
                                                 sob_id, user_id, username, user_phone, guide_id, attribute1, attribute2, attribute3, attribute4, attribute5)
            SELECT
                #{createTime},
                #{sendFlag},
                #{errorMsg},
                #{sendTime},
                #{mainOrderNumber},
                #{receiptNumber},
                #{receiptType},
                #{storeOrgId},
                #{diySiteCode},
                #{receiptDate},
                #{amount},
                #{description},
                #{sobId},
                #{userId},
                #{username},
                #{userPhone},
                #{guideId},
                #{attribute1},
                #{attribute2},
                #{attribute3},
                #{attribute4},
                #{attribute5}
            FROM dual
            WHERE NOT exists(SELECT 1
                             FROM inter_ate_order_receipt_inf
                             WHERE receipt_number = #{receiptNumber})
    </insert>

    <select id="getPendingSendOrderBaseInf" parameterType="java.lang.String" resultType=
            "cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderBaseInf">
        SELECT
            order_header_id,
            create_time,
            send_flag,
            error_msg,
            send_time,
            main_order_number,
            order_number,
            sob_id,
            order_date,
            order_subject_type,
            product_type,
            order_type_id,
            user_id,
            sales_consult_id,
            decorate_manager_id,
            coupon_flag,
            invoice_flag,
            credit_flag,
            store_org_id,
            diy_site_code,
            delivery_type_title,
            order_amt,
            rec_amt,
            lebi_discount,
            store_subvention_discount,
            promotion_discount,
            member_discount,
            cash_coupon_discount,
            product_coupon_discount,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            attribute6,
            attribute7
        FROM inter_ate_order_base_inf
        WHERE main_order_number = #{orderNumber}
    </select>

    <select id="getOrderGoodsInfByOrderNumber" parameterType="java.lang.String" resultType=
            "cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderGoodsInf">
        SELECT
            order_line_id,
            order_header_id,
            create_time,
            send_flag,
            send_time,
            error_msg,
            main_order_line_id,
            main_order_number,
            order_number,
            sku,
            goods_title,
            quantity,
            ls_price,
            hy_price,
            jx_price,
            settlement_price,
            return_price,
            lebi_discount,
            subvention_discount,
            cash_coupon_discount,
            promotion_discount,
            discount_total_price,
            gift_flag,
            promotion_id,
            product_type,
            attribute1,
            attribute2,
            attribute3,
            attribute4
        FROM inter_ate_order_goods_inf
        WHERE order_number = #{orderNumber}
    </select>

    <update id="updateOrderBaseInfoSendFlagAndErrorMessageAndSendTime">
        UPDATE inter_ate_order_base_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != errorMsg">
                error_msg = #{errorMsg},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime}
            </if>
        </set>
        WHERE order_number = #{orderNumber}
    </update>

    <update id="updateOrderGoodsInfoSendFlagAndErrorMessageAndSendTime">
        UPDATE inter_ate_order_goods_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != errorMsg">
                error_msg = #{errorMsg},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime}
            </if>
        </set>
        WHERE order_line_id = #{orderLineId}
    </update>

    <select id="getOrderBillingPaymentDetailsByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        SELECT
            id,
            oid    order_id,
            ord_no order_number,
            create_time,
            pay_time,
            pay_type,
            pay_type_desc,
            payment_subject_type,
            payment_subject_type_desc,
            amount,
            reply_code,
            receipt_number
        FROM ord_billing_payment_details
        WHERE ord_no = #{orderNumber}
    </select>

    <select id="getOrderReceiptInf" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderReceiptInf">
        SELECT
            receipt_id,
            create_time,
            send_flag,
            error_msg,
            send_time,
            main_order_number,
            receipt_number,
            receipt_type,
            store_org_id,
            diy_site_code,
            receipt_date,
            amount,
            description,
            sob_id,
            user_id,
            username,
            user_phone,
            guide_id,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5
        FROM inter_ate_order_receipt_inf
        WHERE main_order_number = #{orderNumber}
    </select>

    <select id="getOrderCouponInf" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderCouponInf">
        SELECT
            id,
            main_order_number,
            create_time,
            send_flag,
            error_msg,
            send_time,
            history_flag,
            get_type,
            product_type,
            buy_price,
            cost_price,
            coupon_id,
            sob_id,
            sku,
            quantity,
            coupon_type_id,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            promotion
        FROM inter_ate_order_coupon_inf
        WHERE main_order_number = #{orderNumber}
    </select>

    <update id="updateOrderCouponFlagAndSendTimeAndErrorMsg">
        UPDATE inter_ate_order_coupon_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime},
            </if>
            <if test="null != msg">
                error_msg = #{msg}
            </if>
        </set>
        WHERE id in
        <foreach collection="couponInfIds" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <update id="updateOrderGoodsInfByOrderNumber">
        UPDATE inter_ate_order_goods_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != errorMsg">
                error_msg = #{errorMsg},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime}
            </if>
        </set>
        WHERE order_number = #{orderNumber}
    </update>

    <update id="updateOrderReceiptFlagAndSendTimeAndErrorMsg">
        UPDATE inter_ate_order_receipt_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime},
            </if>
            <if test="null != errorMsg">
                error_msg = #{errorMsg}
            </if>
        </set>
        WHERE receipt_id in
        <foreach collection="receiptInfIds" open="(" close=")" separator="," item="id" index="index">
            #{id}
        </foreach>
    </update>

    <select id="isRechargeReceiptExist" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT exists(SELECT 1
                      FROM inter_ate_recharge_receipt_inf
                      WHERE charge_number = #{rechargeNo})
    </select>

    <insert id="saveRechargeReceiptInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.RechargeReceiptInf">
        INSERT INTO inter_ate_recharge_receipt_inf (charge_number, sob_id, charge_obj, charge_type, receiptType,
                                                    userid, store_org_code, diy_site_code, receipt_date, amount, description, attribute1,
                                                    attribute2, attribute3, attribute4, attribute5, create_time, send_flag, error_msg, send_time,
                                                    receipt_number)
            SELECT
                #{chargeNumber},
                #{sobId},
                #{chargeObj},
                #{chargeType},
                #{receiptType},
                #{userid},
                #{storeOrgCode},
                #{diySiteCode},
                #{receiptDate},
                #{amount},
                #{description},
                #{attribute1},
                #{attribute2},
                #{attribute3},
                #{attribute4},
                #{attribute5},
                #{createTime},
                #{sendFlag},
                #{errorMsg},
                #{sendTime},
                #{receiptNumber}
            FROM dual
            WHERE NOT exists(SELECT 1
                             FROM inter_ate_recharge_receipt_inf
                             WHERE charge_number = #{chargeNumber})
    </insert>

    <select id="getRechargeReceiptInfByRechargeNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.RechargeReceiptInf">
        SELECT
            receipt_id,
            charge_number,
            sob_id,
            charge_obj,
            charge_type,
            receiptType,
            userid,
            store_org_code,
            diy_site_code,
            receipt_date,
            amount,
            description,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            create_time,
            send_flag,
            error_msg,
            send_time,
            receipt_number
        FROM inter_ate_recharge_receipt_inf
        WHERE charge_number = #{rechargeNo}
    </select>

    <update id="updateRechargeReceiptFlagAndSendTimeAndErrorMsg">
        UPDATE inter_ate_recharge_receipt_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != msg">
                error_msg = #{msg},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime}
            </if>
        </set>
        WHERE receipt_id = #{receiptId}
    </update>

    <insert id="saveOrderJxPriceDifferenceReturnInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderJxPriceDifferenceReturnInf">
        INSERT INTO inter_ate_order_jx_price_difference_return_inf (main_order_number, sob_id, store_org_code, diy_site_code, receipt_date, sku,
                                                                    amount, description, attribute1, attribute2, attribute3, attribute4, attribute5,
                                                                    create_time, send_flag, error_msg, send_time, receipt_number)
            SELECT
                #{mainOrderNumber},
                #{sobId},
                #{storeOrgCode},
                #{diySiteCode},
                #{receiptDate},
                #{sku},
                #{amount},
                #{description},
                #{attribute1},
                #{attribute2},
                #{attribute3},
                #{attribute4},
                #{attribute5},
                #{createTime},
                #{sendFlag},
                #{errorMsg},
                #{sendTime},
                #{receiptNumber}
            FROM dual
            WHERE NOT exists(SELECT 1
                             FROM inter_ate_order_jx_price_difference_return_inf
                             WHERE main_order_number = #{mainOrderNumber}
                                   AND sku = #{sku})

    </insert>

    <insert id="saveOrderJxPriceDifferenceRefundInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderJxPriceDifferenceRefundInf">
        INSERT INTO inter_ate_order_jx_price_difference_refund_inf (main_order_number, return_number, sob_id, store_org_code, diy_site_code, refund_date, sku,
                                                                    amount, description, attribute1, attribute2, attribute3, attribute4, attribute5,
                                                                    create_time, send_flag, error_msg, send_time, refund_number)
            SELECT
                #{mainOrderNumber},
                #{sobId},
                #{storeOrgCode},
                #{diySiteCode},
                #{refundDate},
                #{sku},
                #{amount},
                #{description},
                #{attribute1},
                #{attribute2},
                #{attribute3},
                #{attribute4},
                #{attribute5},
                #{createTime},
                #{sendFlag},
                #{errorMsg},
                #{sendTime},
                #{refundNumber},
                #{returnNumber}
            FROM dual
            WHERE NOT exists(SELECT 1
                             FROM inter_ate_order_jx_price_difference_refund_inf
                             WHERE return_number = #{returnNumber}
                                   AND sku = #{sku})

    </insert>

    <select id="getOrderJxPriceDifferenceReturnInf" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderJxPriceDifferenceReturnInf">
        SELECT
            receipt_id,
            main_order_number,
            sob_id,
            store_org_code,
            diy_site_code,
            receipt_date,
            sku,
            amount,
            description,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            create_time,
            send_flag,
            error_msg,
            send_time,
            receipt_number
        FROM inter_ate_order_jx_price_difference_return_inf
        WHERE main_order_number = #{orderNumber}
    </select>

    <select id="getOrderJxPriceDifferenceRefundInf" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderJxPriceDifferenceRefundInf">
        SELECT *
        FROM inter_ate_order_jx_price_difference_refund_inf
        WHERE return_number = #{returnNumber}
    </select>

    <update id="updateOrderJxPriceDifferenceReturnInf">
        UPDATE inter_ate_order_jx_price_difference_return_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != msg">
                error_msg = #{msg},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime}
            </if>
        </set>
        WHERE receipt_id in
        <foreach collection="returnInfIds" open="(" close=")" separator="," item="id" index="index">
            #{id}
        </foreach>
    </update>

    <select id="isReturnOrderExist" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT exists(SELECT 1
                      FROM inter_ate_return_order_base_inf
                      WHERE main_return_number = #{returnNumber})
    </select>

    <update id="updateOrderJxPriceDifferenceRefundInf">
        UPDATE inter_ate_order_jx_price_difference_refund_inf
        <set>
            <if test="null != flag">
                send_flag = #{flag},
            </if>
            <if test="null != msg">
                error_msg = #{msg},
            </if>
            <if test="null != sendTime">
                send_time = #{sendTime}
            </if>
        </set>
        WHERE receipt_id in
        <foreach collection="refundInfIds" open="(" close=")" separator="," item="id" index="index">
            #{id}
        </foreach>
    </update>

    <select id="getOrderBaseInfByMainOrderNumberAndCompanFlag"
            resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderBaseInf">
        SELECT
            order_header_id,
            create_time,
            send_flag,
            error_msg,
            send_time,
            main_order_number,
            order_number,
            sob_id,
            order_date,
            order_subject_type,
            product_type,
            order_type_id,
            user_id,
            sales_consult_id,
            decorate_manager_id,
            coupon_flag,
            invoice_flag,
            credit_flag,
            store_org_id,
            diy_site_code,
            delivery_type_title,
            order_amt,
            rec_amt,
            lebi_discount,
            store_subvention_discount,
            promotion_discount,
            member_discount,
            cash_coupon_discount,
            product_coupon_discount,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            attribute6,
            attribute7
        FROM inter_ate_order_base_inf
        WHERE main_order_number = #{orderNumber} AND product_type = #{companyFlag}
    </select>
</mapper>