<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.MaReportDownloadDAO">
    <select id="findReceiptsReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.ReceiptsReportDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, obi.sales_consult_name
        sellerName, obpd.pay_time as payTime,null as returnPayTime,
        obpd.pay_type payTypes, obpd.pay_type payType, IFNULL(obpd.amount, 0) money, obi.ord_no as orderNumber,null as returnOrderNumber,
        IF(obpd.pay_type = 'POS',obd.store_pos_number,null) remarks, obpd.payment_subject_type paymentSubjectType ,
        pd.out_trade_no as outTradeNo, pd.trade_no as tradeNo,obi.customer_name
        FROM
        ord_billing_payment_details obpd
        INNER JOIN ord_base_info obi ON obi.ord_no = obpd.ord_no
        INNER JOIN st_store st ON st.store_id = obi.store_id
        INNER JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        LEFT JOIN (SELECT * from payment_data where payment_type in ("ORDER","REPAYMENT") and trade_status = "TRADE_SUCCESS") pd
        on pd.ord_no = obpd.ord_no and obpd.pay_type = pd.online_pay_type
        WHERE 1=1
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND obpd.pay_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND obpd.pay_time &lt;= #{endTime}
        </if>
        <if test="null != payType and payType != ''">
            AND obpd.pay_type = #{payType}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, obi.sales_consult_name
        sellerName,null as payTime, orbd.create_time as returnPayTime,
        orbd.return_pay_type payTypes, orbd.return_pay_type payType, (-1 * IFNULL(orbd.return_money, 0)) money,
        orbi.ord_no as orderNumber,orbi.return_no as returnOrderNumber,
        NULL remarks, null paymentSubjectType,pd.out_trade_no as outTradeNo, pd.trade_no as tradeNo,obi.customer_name
        FROM ord_return_billing_detail orbd
        INNER JOIN ord_return_base_info orbi ON orbi.return_no = orbd.return_no
        INNER JOIN st_store st ON st.store_id = orbi.store_id
        INNER JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        LEFT JOIN (SELECT * from payment_data where payment_type in ("ORDER") and trade_status = "REFUND_SUCCESS") pd
        on pd.ord_no = orbd.return_no and orbd.return_pay_type = pd.online_pay_type
        WHERE 1 = 1
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND orbd.create_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND orbd.create_time &lt;= #{endTime}
        </if>
        <if test="null != payType and payType != ''">
            AND orbd.return_pay_type = #{payType}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY payTime DESC
    </select>

    <select id="findNotPickGoodsReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.NotPickGoodsReportDO">
        SELECT
        obi.city_name cityName,
        st.store_name storeName,
        st.store_type storeType,
        obi.delivery_type pickType,
        obd.pay_up_time buyTime,
        obi.effective_end_time effectiveTime,
        obi.customer_id customerId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone,
        obi.customer_type customerType,
        obi.sales_consult_name sellerName,
        ogi.sku sku,
        ogi.sku_name skuName,
        g.brand_name,
        ogi.order_qty quantity,
        ifnull(ogi.retail_price,0) buyPrice,
        ifnull(ogi.wholesale_price,0) wholesalePrice,
        (ifnull(ogi.order_qty,0) * ifnull(ogi.retail_price,0)) totalBuyPrice,
        obi.ord_no referenceNumber
        FROM ord_billing_details obd
        INNER JOIN ord_base_info obi ON obd.oid = obi.oid
        INNER JOIN st_store st ON st.store_id = obi.store_id
        INNER JOIN ord_goods_info ogi ON obi.oid = ogi.oid
        left join gds_goods g on g.gid = ogi.gid
        WHERE obd.is_pay_up = 1 AND ((obi.delivery_type = 'HOUSE_DELIVERY' AND obi.status = 'PENDING_SHIPMENT')
        OR (obi.delivery_type = 'SELF_TAKE' AND obi.status = 'PENDING_RECEIVE'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND obd.pay_up_time &lt; #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND obd.pay_up_time &lt; #{endTime}
        </if>
        <if test="null != pickType and pickType != ''">
            AND obi.delivery_type = #{pickType}
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION ALL
        SELECT
        temp.cityName,
        temp.storeName,
        temp.storeType,
        temp.pickType,
        temp.buyTime,
        temp.effectiveTime,
        temp.customerId,
        temp.customerName,
        temp.customerPhone,
        temp.customerType,
        temp.sellerName,
        temp.sku,
        temp.skuName,
        temp.brandName,
        SUM( temp.quantity ),
        temp.buyPrice,
        temp.wholesalePrice,
        temp.totalBuyPrice,
        temp.referenceNumber
        FROM
        (
        SELECT
        city.name cityName,
        st.store_name storeName,
        st.store_type storeType,
        ccpc.get_type pickType,
        ccpc.get_time buyTime,
        ccpc.effective_end_time effectiveTime,
        c.cus_id customerId,
        c.name customerName,
        c.mobile customerPhone,
        c.customer_type customerType,
        e.name sellerName,
        g.sku sku,
        g.sku_name skuName,
        g.brand_name brandName,
        IFNULL(ccpc.quantity,0) quantity,
        IFNULL(ccpc.buy_price,0) buyPrice,
        IFNULL(p.wholesale_price, 0 ) wholesalePrice,
        (IFNULL(ccpc.quantity,0) * IFNULL(ccpc.buy_price,0)) totalBuyPrice,
        ccpc.get_ord_no referenceNumber
        FROM cus_customer_product_coupon ccpc
        INNER JOIN cus_customer c ON ccpc.cus_id = c.cus_id
        LEFT JOIN emp_employee e ON ccpc.seller_id = e.emp_id
        INNER JOIN st_store st ON st.store_id = ccpc.store_id
        INNER JOIN city ON c.city_id = city.city_id
        INNER JOIN gds_goods g ON ccpc.gid = g.gid
        INNER JOIN gds_goods_price p ON p.store_id = ccpc.store_id AND p.gid = g.gid
        WHERE ccpc.is_used = 0 AND (ccpc.effective_end_time > now() OR ccpc.effective_end_time IS NULL)
        <if test="null != cityId and cityId != -1">
            AND city.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND st.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ccpc.get_time &lt; #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ccpc.get_time &lt; #{endTime}
        </if>
        <if test="null != pickType and pickType != '' and pickType == 'PRODUCT_COUPON'">
            AND ccpc.get_type IN ('BUY','MANUAL_GRANT','CANCEL_ORDER','RETURN_ORDER','HISTORY_IMPORT','PRESENT')
        </if>
        AND c.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ) AS temp
        GROUP BY
        temp.pickType,
        temp.customerId,
        temp.sku
    </select>

    <!-- new未提货 -->
    <select id="findNotPickGoodsReportDOAllNEW"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.NotPickGoodsReportDO">
        SELECT
        obi.city_name cityName,
        st.store_name storeName,
        st.store_type storeType,
        obi.delivery_type pickType,
        obi.create_time buyTime,
        '' effectiveTime,
        obi.customer_id customerId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone,
        obi.customer_type customerType,
        obi.sales_consult_name sellerName,
        ogi.sku sku,
        ogi.sku_name skuName,
        g.company_flag as brandName,
        if(ogi.goods_line_type = "PRODUCT_COUPON",1,ogi.order_qty )quantity,
        if(ogi.goods_line_type = "PRODUCT_COUPON",oci.purchase_price,ogi.return_price) buyPrice,
        IFNULL(ogi.wholesale_price,0) wholesalePrice,
        if(ogi.goods_line_type = "PRODUCT_COUPON",oci.purchase_price,ogi.order_qty * ogi.return_price) totalBuyPrice,
        obi.ord_no referenceNumber,
        CASE obd.is_pay_up WHEN 0 THEN '欠款' WHEN 1 THEN '结清' end isPayUp,
        CASE ogi.goods_line_type WHEN 'PRODUCT_COUPON' THEN '已提产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END  goodsLineType,
        wa.end_dt shippingTime
        FROM ord_billing_details obd
        INNER JOIN ord_base_info obi ON obd.oid = obi.oid
        INNER JOIN st_store st ON st.store_id = obi.store_id
        INNER JOIN ord_goods_info ogi ON obi.oid = ogi.oid
        left join gds_goods g on g.gid = ogi.gid
        LEFT JOIN  inter_wta_order_shipping_header wa on wa.order_no = obi.ord_no
        LEFT JOIN ord_coupon_info oci on obi.oid = oci.oid and ogi.sku = oci.sku and ogi.goods_line_type = 'PRODUCT_COUPON'
        WHERE
        obi.delivery_type = 'HOUSE_DELIVERY' AND  obi.create_time &lt; #{endTime} AND (obi.status = 'PENDING_SHIPMENT' OR wa.end_dt &gt; #{endTime})
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != pickType and pickType != ''">
            AND obi.delivery_type = #{pickType}
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION  ALL

        SELECT
        obi.city_name cityName,
        st.store_name storeName,
        st.store_type storeType,
        obi.delivery_type pickType,
        obi.create_time buyTime,
        '' effectiveTime,
        obi.customer_id customerId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone,
        obi.customer_type customerType,
        obi.sales_consult_name sellerName,
        ogi.sku sku,
        ogi.sku_name skuName,
        g.company_flag as brandName,
        if(ogi.goods_line_type = "PRODUCT_COUPON",1,ogi.order_qty) quantity,
        if(ogi.goods_line_type = "PRODUCT_COUPON",oci.purchase_price,ogi.return_price) buyPrice,
        IFNULL(ogi.wholesale_price,0) wholesalePrice,
        if(ogi.goods_line_type = "PRODUCT_COUPON",oci.purchase_price,ogi.order_qty * ogi.return_price) totalBuyPrice,
        obi.ord_no referenceNumber,
        CASE obd.is_pay_up WHEN 0 THEN '欠款' WHEN 1 THEN '结清' end isPayUp,
        CASE ogi.goods_line_type WHEN 'PRODUCT_COUPON' THEN '已提产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END  goodsLineType,
        os.shipping_time shippingTime
        FROM ord_billing_details obd
        INNER JOIN ord_base_info obi ON obd.oid = obi.oid
        INNER JOIN st_store st ON st.store_id = obi.store_id
        INNER JOIN ord_goods_info ogi ON obi.oid = ogi.oid
        left join gds_goods g on g.gid = ogi.gid
        LEFT JOIN  ord_shipping os on os.ord_no = obi.ord_no
        LEFT JOIN ord_coupon_info oci on obi.oid = oci.oid and ogi.sku = oci.sku and ogi.goods_line_type = 'PRODUCT_COUPON'
        WHERE
        obi.delivery_type = 'SELF_TAKE' and obi.create_time &lt; #{endTime} AND (obi.status = 'PENDING_RECEIVE' OR os.shipping_time &gt; #{endTime})
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != pickType and pickType != ''">
            AND obi.delivery_type = #{pickType}
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION  ALL

        SELECT
        city.name cityName,
        st.store_name storeName,
        st.store_type storeType,
        ccpc.get_type pickType,
        ccpc.get_time buyTime,
        ccpc.effective_end_time effectiveTime,
        c.cus_id customerId,
        c.name customerName,
        c.mobile customerPhone,
        c.customer_type customerType,
        e.name sellerName,
        g.sku sku,
        g.sku_name skuName,
        g.company_flag brandName,
        IFNULL(ccpc.quantity,0) quantity,
        IFNULL(ccpc.buy_price,0) buyPrice,
        IFNULL(ogi.wholesale_price, 0 ) wholesalePrice,
        (IFNULL(ccpc.quantity,0) * IFNULL(ccpc.buy_price,0)) totalBuyPrice,
        ccpc.get_ord_no referenceNumber,
        '' isPayUp,
        '未提产品券' goodsLineType,
        ccpc.use_time shippingTime
        FROM cus_customer_product_coupon ccpc
        INNER JOIN cus_customer c ON ccpc.cus_id = c.cus_id
        LEFT JOIN emp_employee e ON ccpc.seller_id = e.emp_id
        INNER JOIN st_store st ON st.store_id = ccpc.store_id
        INNER JOIN city ON c.city_id = city.city_id
        LEFT JOIN ord_goods_info ogi on ogi.id = ccpc.goods_line_id
        LEFT JOIN gds_goods g on g.gid = ccpc.gid
        WHERE (ccpc.effective_end_time > now() OR ccpc.effective_end_time IS NULL) and ccpc.get_time &lt; #{endTime}
        and (ccpc.is_used = 0 OR ccpc.use_time &gt; #{endTime})
        <if test="null != cityId and cityId != -1">
            AND city.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND st.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != pickType and pickType != '' and pickType == 'PRODUCT_COUPON'">
            AND ccpc.get_type IN ('BUY','MANUAL_GRANT','CANCEL_ORDER','RETURN_ORDER','HISTORY_IMPORT','PRESENT')
        </if>
        <if test="null != pickType and pickType != '' and pickType != 'PRODUCT_COUPON'">
            AND ccpc.get_type = "-1"
        </if>
        AND c.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

    </select>
    
    <select id="findStorePredepositReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.StorePredepositReportDO">
        SELECT
        c.name cityName,
        s.store_name storeName,
        s.store_type storeType,
        pl.create_time changeTime,
        pl.change_type changeType,
        pl.change_money changeMoney,
        pl.balance balance,
        pl.order_number referenceNumber,
        pl.remarks remarks
        FROM st_pre_deposit_log pl
        INNER JOIN st_store s ON pl.store_id = s.store_id
        INNER JOIN city c ON c.city_id = s.city_id
        WHERE TRUE
        <if test="null != cityId and cityId != -1">
            AND c.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND pl.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND s.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND pl.create_time &gt; #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND pl.create_time &lt; #{endTime}
        </if>
        AND pl.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY changeTime DESC
    </select>

    <!-- 查询门店预存款 区分正负 -->
    <select id="findStorePredepositReportDOAllNEW"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.StorePredepositReportDO">
        SELECT
        ua.id,
        c.name cityName,
        st.store_name storeName,
        st.store_type storeType,
        ua.create_time as changeTime,
        ua.change_type as changeType,
        ua.change_money as changeMoney ,
        ua.balance as balance,
        if(orbi.roid is not NULL ,orbi.ord_no,ua.order_number) referenceNumber,
        if(orbi.roid is not NULL , orbi.return_no,'') as returnNo,
        ua.remarks as remarks
         from
        (
            SELECT
            spdl.id,
            spdl.store_id,
            spdl.create_time,
            spdl.change_type,
            spdl.operator_id,
            spdl.operator_type,
            spdl.order_number ,
            -ABS(spdl.change_money) as change_money,
            spdl.balance,
            spdl.remarks
        FROM
            st_pre_deposit_log spdl
        WHERE
            spdl.change_type IN (
                'PLACE_ORDER',
                'JX_PRICE_DIFFERENCE_DEDUCTION',
                'WITHDRAW'
            )
        UNION ALL
        SELECT
            spdl.id,
            spdl.store_id,
            spdl.create_time,
            spdl.change_type,
            spdl.operator_id,
            spdl.operator_type,
            spdl.order_number ,
            spdl.change_money,
            spdl.balance,
            spdl.remarks
        FROM
            st_pre_deposit_log spdl
        WHERE
            spdl.change_type NOT IN (
                'PLACE_ORDER',
                'JX_PRICE_DIFFERENCE_DEDUCTION',
                'WITHDRAW'
            )
        ) ua
        LEFT JOIN st_store st on st.store_id = ua.store_id
        LEFT JOIN ord_billing_details obd on obd.ord_no = ua.order_number
        LEFT JOIN ord_return_base_info orbi ON orbi.return_no = ua.order_number
        INNER JOIN city c ON c.city_id = st.city_id
        WHERE TRUE
        <if test="null != cityId and cityId != -1">
            AND c.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND ua.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ua.create_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ua.create_time &lt;= #{endTime}
        </if>
        AND ua.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY ua.id DESC
    </select>

    <select id="findEmployeeCreditMoneyReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.EmpCreditMoneyChangeReportDO">
        SELECT
        ac.id,
        c.name cityName,
        st.store_name storeName,
        st.store_type storeType,
        ecmcl.create_time changeTime,
        e.name employeeName,
        ac.credit_limit_available_change_amount changeMoney,
        ac.credit_limit_available_after_change balance,
        ac.change_type changeType,
        ac.change_type_desc changeTypeDesc,
        if(orbi.roid is not NULL ,orbi.ord_no,ecmcl.reference_number) orderNumber,
        if(orbi.roid is not NULL , orbi.return_no,'') as returnNumber
        FROM
        (
        select
        eaccl.id,
        -ABS(eaccl.credit_limit_available_change_amount) as credit_limit_available_change_amount,
        eaccl.credit_limit_available_after_change,
        eaccl.change_type,
        eaccl.change_type_desc
        from
        emp_available_credit_change_log eaccl
        where change_type in (
        'PLACE_ORDER',
        'TEMPORARY_CLEAR'
        )
        union all
        select
        eaccl.id,
        eaccl.credit_limit_available_change_amount,
        eaccl.credit_limit_available_after_change,
        eaccl.change_type,
        eaccl.change_type_desc
        from
        emp_available_credit_change_log eaccl
        where change_type not in (
        'PLACE_ORDER',
        'TEMPORARY_CLEAR'
        )
        ) ac
        INNER JOIN emp_credit_money_change_log ecmcl ON ac.id = ecmcl.available_credit_change_id
        LEFT JOIN ord_return_base_info orbi on orbi.ord_no = ecmcl.reference_number
        LEFT JOIN emp_employee e ON e.emp_id = ecmcl.emp_id
        LEFT JOIN st_store st on st.store_id = e.store_id
        LEFT JOIN city c ON c.city_id = st.city_id
        WHERE TRUE
        <if test="null != cityId and cityId != -1">
            AND c.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND st.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ecmcl.create_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ecmcl.create_time &lt;= #{endTime}
        </if>
        AND st.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY ac.id DESC
    </select>
    <!-- 逻辑 下单时间 和 反配时间 为节点 -->
    <select id="findAccountGoodsItemsDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AccountGoodsItemsDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, ol.operation_time
        orderTime,'' as createTime, obi.ord_no orderNumber, st.store_type storeTypes,
        null returnNumber, obi.customer_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType, oli.receiver receiver, oli.receiver_phone receiverPhone,
        (CASE WHEN obi.`status` = 'FINISHED' OR obi.`status` = 'CLOSED' OR obi.`status` = 'REJECTED'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'HOUSE_DELIVERY')THEN '已出货'
        WHEN obi.`status` = 'CANCELED' OR obi.`status` = 'CANCELING' OR obi.`status` = 'PENDING_SHIPMENT'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'SELF_TAKE') THEN '未出货' ELSE '未知'
        END)deliveryStatus,
        oli.shipping_address, og.sku sku, og.sku_name skuName, (CASE WHEN og.company_flag = 'HR' THEN '华润'
        WHEN og.company_flag = 'LYZ' THEN '乐易装' WHEN og.company_flag = 'YR' THEN '莹润' ELSE '其他' END)companyFlag,
        og.goods_line_type goodsLineType, IFNULL(og.order_qty, 0) quantity,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku)/og.order_qty,0),
        IFNULL(og.settlement_price, 0)) settlementPrice,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku),0),
        (IFNULL(og.order_qty, 0) * IFNULL(og.settlement_price, 0))) settlementTotlePrice,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku)/og.order_qty,0),
        IFNULL(og.return_price, 0)) promotionSharePrice,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku),0),
        (IFNULL(og.order_qty, 0) * IFNULL(og.return_price, 0))) promotionShareTotlePrice,
        og.wholesale_price as jxPrice,
        og.wholesale_price * og.order_qty as totalJxPrice,
        obi.creator_name as creatorName,
        gg.goods_unit as goodsUnit,
        oli.estate_info as estateInfo,
        obi.remark as remark,
        CASE obd.is_pay_up when 0 then '未结清' when 1 then '结清' end as isPayUp
        FROM
        ord_base_info obi
        INNER JOIN st_store st ON st.store_id = obi.store_id
        LEFT JOIN (SELECT DISTINCT ord_no,post_status,operation_time from ord_lifecycle) ol ON obi.ord_no = ol.ord_no
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        LEFT JOIN ord_goods_info og ON og.ord_no = oli.ord_no
        LEFT JOIN gds_goods gg on og.gid = gg.gid
        LEFT JOIN ord_billing_details obd on obd.oid = obi.oid
        WHERE obi.`status` != 'UNPAID' AND  obi.`status` != 'CANCELED'
        AND (ol.post_status = 'PENDING_SHIPMENT' OR (ol.post_status = 'PENDING_RECEIVE' AND obi.delivery_type =
        'SELF_TAKE'))
        AND (obi.delivery_type = 'HOUSE_DELIVERY' OR (obi.delivery_type = 'SELF_TAKE' AND st.store_type != 'JM'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ol.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ol.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType,orbi.return_time createTime, rl.operation_time
        orderTime, obi.ord_no orderNumber, st.store_type storeTypes,
        orbi.return_no returnNumber, orbi.cus_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType, orli.rejecter receiver, orli.rejecter_phone receiverPhone,
        (CASE WHEN orbi.return_type = 'REFUSED_RETURN' OR orbi.return_type = 'NORMAL_RETURN' THEN '已取货'
        WHEN orbi.return_type = 'CANCEL_RETURN' THEN '订单取消' ELSE '未知' END) deliveryStatus,
        orli.return_full_address, org.sku sku, org.sku_name skuName, (CASE WHEN org.company_flag = 'HR' THEN '华润'
        WHEN org.company_flag = 'LYZ' THEN '乐易装' WHEN org.company_flag = 'YR' THEN '莹润' ELSE '其他' END) companyFlag,
        org.goods_line_type goodsLineType, (-1 * IFNULL(org.return_qty,0)) quantity,
        if(org.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku)/org.return_qty,0),
        IFNULL(org.settlement_price, 0)) settlementPrice,
        if(org.goods_line_type = "PRODUCT_COUPON",-1 * IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku),0),
        (-1 * IFNULL(org.return_qty, 0) * IFNULL(org.settlement_price, 0))) settlementTotlePrice,
        if(org.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku)/org.return_qty,0),
        IFNULL(org.return_price, 0)) promotionSharePrice,
        if(org.goods_line_type = "PRODUCT_COUPON",-1 * IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku),0),
        (-1 * IFNULL(org.return_qty, 0) * IFNULL(org.return_price, 0))) promotionShareTotlePrice,
        org.wholesale_price as jxPrice,
        org.wholesale_price * org.return_qty as totalJxPrice,
        orbi.creator_name as creatorName,
        gg.goods_unit as goodsUnit,
        orbi.remarks_info as remark,
        '' as estateInfo,
        CASE obd.is_pay_up when 0 then '未结清（退）' when 1 then '结清（退）' end as isPayUp
        FROM ord_return_base_info orbi
        LEFT JOIN (SELECT DISTINCT return_no,post_status,operation_time from ord_return_lifecycle) rl ON orbi.return_no = rl.return_no
        LEFT JOIN st_store st ON st.store_id = orbi.store_id
        LEFT JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        LEFT JOIN ord_return_logistic_info orli ON orli.return_no = orbi.return_no
        LEFT JOIN ord_return_goods_info org ON org.return_no = orbi.return_no
        LEFT JOIN gds_goods gg on gg.gid = org.gid
        LEFT JOIN ord_billing_details obd on obd.oid = obi.oid
        WHERE orbi.return_status = 'FINISHED' AND rl.post_status = 'FINISHED' AND orbi.return_type != 'CANCEL_RETURN'
        AND (obi.delivery_type = 'HOUSE_DELIVERY' OR (obi.delivery_type = 'SELF_TAKE' AND st.store_type != 'JM'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND rl.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND rl.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>

    <select id="findBillingItemsDOAll" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.BillingItemsDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, ol.operation_time
        orderTime, obi.ord_no orderNumber,
        null returnNumber, obi.customer_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType,
        (CASE WHEN obi.`status` = 'FINISHED' OR obi.`status` = 'CLOSED' OR obi.`status` = 'REJECTED'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'HOUSE_DELIVERY')THEN '已出货'
        WHEN obi.`status` = 'CANCELED' OR obi.`status` = 'CANCELING' OR obi.`status` = 'PENDING_SHIPMENT'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'SELF_TAKE') THEN '未出货' ELSE '未知'
        END)deliveryStatus,
        oli.shipping_address, IFNULL(obd.total_goods_price,0) totalGoodsPrice, IFNULL(obd.member_discount,0)
        memberDiscount,
        IFNULL(obd.promotion_discount,0) promotionDiscount, IFNULL(obd.freight,0) freight,
        IFNULL(obd.cash_coupon_discount,0) cashCouponDiscount,
        IFNULL(obd.product_coupon_discount,0) productCouponDiscount,
        IFNULL(obd.order_amount_subtotal,0)-IFNULL(obd.freight,0) amountPayable,
        (CASE WHEN obd.online_pay_type = 'WE_CHAT' THEN IFNULL(obd.online_pay_amount,0) ELSE 0 END) weChat,
        (CASE WHEN obd.online_pay_type = 'ALIPAY' THEN IFNULL(obd.online_pay_amount,0) ELSE 0 END) alipay,
        (CASE WHEN obd.online_pay_type = 'UNION_PAY' THEN IFNULL(obd.online_pay_amount,0) ELSE 0 END) unionPay,
        IFNULL(obd.store_cash,0) storeCash, IFNULL(obd.store_pos_money,0) storePosMoney, IFNULL(obd.delivery_cash,0)
        deliveryCash, IFNULL(obd.delivery_pos,0) deliveryPos,
        IFNULL(obd.store_other_money,0) storeOtherMoney, IFNULL(obd.st_pre_deposit,0) stPreDeposit,
        IFNULL(obd.cus_pre_deposit,0) cusPreDeposit,
        (IFNULL(obd.online_pay_amount,0) + IFNULL(obd.store_cash,0) + IFNULL(obd.store_pos_money,0)
        + IFNULL(obd.delivery_cash,0) + IFNULL(obd.delivery_pos,0) + IFNULL(obd.store_other_money,0)
        + IFNULL(obd.st_pre_deposit,0) + IFNULL(obd.cus_pre_deposit,0)) totalPay
        FROM
        ord_base_info obi
        INNER JOIN st_store st ON st.store_id = obi.store_id
        LEFT JOIN ord_lifecycle ol ON obi.ord_no = ol.ord_no
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        LEFT JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        WHERE obi.`status` != 'UNPAID'
        AND (ol.post_status = 'PENDING_SHIPMENT' OR (ol.post_status = 'PENDING_RECEIVE' AND obi.delivery_type =
        'SELF_TAKE'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ol.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ol.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, rl.operation_time
        orderTime, obi.ord_no orderNumber,
        orbi.return_no returnNumber, orbi.cus_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType,
        (CASE WHEN orbi.return_type = 'REFUSED_RETURN' OR orbi.return_type = 'NORMAL_RETURN' THEN '已取货'
        WHEN orbi.return_type = 'CANCEL_RETURN' THEN '订单取消' ELSE '未知' END) deliveryStatus,
        orli.return_full_address, (CASE WHEN orbi.return_type = 'CANCEL_RETURN' THEN (-1 *
        IFNULL(obd.total_goods_price,0)) ELSE (-1 * IFNULL(orbi.return_price,0)) END) totalGoodsPrice,
        (CASE WHEN orbi.return_type = 'CANCEL_RETURN' THEN IFNULL(obd.member_discount,0) ELSE 0 END) memberDiscount,
        0 promotionDiscount, 0 freight, 0 cashCouponDiscount,
        0 productCouponDiscount, (-1 * IFNULL(orbi.return_price,0)) amountPayable,
        (CASE WHEN orb.online_pay_type = 'WE_CHAT' THEN (-1 * IFNULL(orb.online_pay,0)) ELSE 0 END) weChat,
        (CASE WHEN orb.online_pay_type = 'ALIPAY' THEN (-1 * IFNULL(orb.online_pay,0)) ELSE 0 END) alipay,
        (CASE WHEN orb.online_pay_type = 'UNION_PAY' THEN (-1 * IFNULL(orb.online_pay,0)) ELSE 0 END) unionPay,
        (-1 * IFNULL(orb.cash,0)) storeCash, 0, 0 deliveryCash, 0 deliveryPos,
        0 storeOtherMoney, (-1 * IFNULL(orb.st_pre_deposit,0)) stPreDeposit, (-1 * IFNULL(orb.pre_deposit,0))
        cusPreDeposit,
        (-1 * (IFNULL(orb.online_pay,0) + IFNULL(orb.cash,0) + IFNULL(orb.st_pre_deposit,0) +
        IFNULL(orb.pre_deposit,0))) totalPay
        FROM ord_return_base_info orbi
        LEFT JOIN ord_return_lifecycle rl ON orbi.return_no = rl.return_no
        LEFT JOIN st_store st ON st.store_id = orbi.store_id
        LEFT JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        LEFT JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        LEFT JOIN ord_return_logistic_info orli ON orli.return_no = orbi.return_no
        LEFT JOIN ord_return_billing orb ON orb.return_no = orbi.return_no
        WHERE orbi.return_status = 'FINISHED' AND rl.post_status = 'FINISHED'
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND rl.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND rl.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>

    <select id="findAgencyFundDOAll" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AgencyFundDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, od.create_time
        orderTime,
        obi.ord_no orderNumber, w.wh_name warehouse, obi.sales_consult_name sellerName,
        oli.shipping_address, oli.delivery_clerk_name deliveryName, IFNULL(obd.collection_amount,0) agencyMoney,
        IFNULL(oaf.cash_money,0) + IFNULL(obd.delivery_cash,0) cashMoney, IFNULL(oaf.pos_money,0) +
        IFNULL(obd.delivery_pos,0) posMoney,
        oaf.remarks remarks, IFNULL(oaf.return_money,0) returnMoney, IFNULL(obd.delivery_cash,0) +
        IFNULL(obd.delivery_pos,0) realMoney, obi.remark orderRemark
        FROM
        ord_agency_fund oaf
        INNER JOIN ord_base_info obi ON obi.ord_no = oaf.ord_no
        INNER JOIN st_store st ON st.store_id = obi.store_id
        LEFT JOIN ord_delivery_info_details od ON od.order_no = obi.ord_no AND od.logistic_status = 'SEALED_CAR'
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        LEFT JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        LEFT JOIN warehouse w ON w.wh_no = oli.warehouse
        WHERE 1=1
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND od.create_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND od.create_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>


    <select id="findStoreInventorys" resultType="cn.com.leyizhuang.app.foundation.pojo.inventory.StoreInventory">
        select
        store_name,
        sku_name,
        sku,
        available_ity,
        real_ity
        from st_inventory
        where
        1=1
        <if test="null !=storeId">
            AND
            store_id =#{storeId}
        </if>
        AND store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        real_ity
        DESC
    </select>

    <select id="queryGoodsShipmentAndReturnOrder"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.ShipmentAndReturnGoods">
        select
        DISTINCT
        ss.city as cityName,
        orbi.store_id as store_id,
        ss.store_name as storeName ,
        ss.store_type as storeType,
        orbi.ord_no as ordNo,
        ordd.create_time as operationTime,
        orbi.order_time as createTime,
        obi.customer_id as customerId,
        obi.customer_phone as customerPhone,
        obi.customer_name as customerName,
        obi.customer_type as customerType,
        obi.sales_consult_name as salesConsultName,
        orgi.company_flag as companyFlag,
        orgi.sku as sku,
        orgi.sku_name as skuName,
        orgi.goods_line_type as goodsLineType,
        orgi.return_qty as orderQty,
        orgi.return_price as returnPrice,
        orpc.purchase_price as purchasePrice,
        orpc.qty as couponQty,
        orbi.return_no as referenceNumber,
        wh.wh_name as wareHouse
        from ord_return_base_info orbi
        LEFT JOIN ord_return_goods_info orgi ON orgi.return_no =orbi.return_no
        LEFT JOIN ord_base_info obi ON orbi.ord_no=obi.ord_no
        LEFT JOIN ord_return_delivery_detail ordd ON orbi.return_no = ordd.return_no
        LEFT JOIN st_store ss ON orbi.store_id = ss.store_id
        LEFT JOIN ord_return_logistic_info orli on orli.return_no = orbi.return_no
        LEFT JOIN (select return_no,purchase_price ,sum(qty) qty,sku from ord_return_product_coupon GROUP BY return_no,sku,purchase_price) orpc on orbi.return_no =orpc.return_no
        AND orpc.sku = orgi.sku  AND orgi.goods_line_type='PRODUCT_COUPON'
        LEFT JOIN warehouse wh on wh.wh_no = ordd.warehouse_no
        where
        orli.delivery_type='HOUSE_PICK'
        AND
        ordd.return_logistic_status='AGAIN_ON_SALE'
        <if test="null !=storeId">
            AND
            orbi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            ss.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime">
            AND
            ordd.create_time >= #{startTime}
        </if>
        <if test="null !=endTime  and ''!=endTime">
            AND
            <![CDATA[ordd.create_time<= #{endTime}]]>
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION ALL
        select
        DISTINCT
        ss.city as cityName,
        orbi.store_id as store_id,
        ss.store_name as storeName,
        ss.store_type as storeType,
        orbi.ord_no as ordNo,
        orl.operation_time as operationTime,
        orbi.order_time as createTime,
        orbi.cus_id as customerId,
        orbi.cus_phone as customerPhone,
        orbi.cus_name as customerName,
        orbi.cus_type as customerType,
        obi.sales_consult_name as salesConsultName,
        orgi.company_flag as companyFlag,
        orgi.sku as sku,
        orgi.sku_name as skuName,
        orgi.goods_line_type as goodsLineType,
        orgi.return_qty as orderQty,
        orgi.return_price as returnPrice,
        orpc.purchase_price as purchasePrice,
        orpc.qty as couponQty,
        orbi.return_no as referenceNumber,
        "" as wareHouse
        from ord_return_base_info orbi
        LEFT JOIN ord_return_goods_info orgi ON orgi.return_no =orbi.return_no
        LEFT JOIN ord_base_info obi ON orbi.ord_no=obi.ord_no
        LEFT JOIN st_store ss ON orbi.store_id = ss.store_id
        LEFT JOIN ord_return_lifecycle orl ON orbi.return_no = orl.return_no
        LEFT JOIN ord_return_logistic_info orli on orli.return_no = orbi.return_no
        LEFT JOIN (select return_no,purchase_price ,sum(qty) qty,sku from ord_return_product_coupon GROUP BY return_no,sku,purchase_price) orpc on orbi.return_no =orpc.return_no
        AND orpc.sku = orgi.sku  AND orgi.goods_line_type='PRODUCT_COUPON'
        where
        orli.delivery_type='RETURN_STORE'
        AND
        orbi.return_status ='FINISHED'
        AND
        orl.post_status = 'FINISHED'
        <if test="null !=storeId">
            AND
            orbi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            ss.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime">
            AND
            orl.operation_time >= #{startTime}
        </if>
        <if test="null !=endTime  and ''!=endTime">
            AND
            <![CDATA[orl.operation_time<= #{endTime}]]>
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION ALL
        select
        DISTINCT
        obi.city_name as cityName,
        obi.store_id as store_id,
        ss.store_name as storeName,
        ss.store_type as storeType,
        obi.ord_no as ordNo,
        odid.create_time as operationTime,
        obi.create_time as createTime,
        obi.customer_id as customerId,
        obi.customer_phone as customerPhone,
        obi.customer_name as customerName,
        obi.customer_type as customerType,
        obi.sales_consult_name as salesConsultName,
        ogi.company_flag as companyFlag,
        ogi.sku as sku,
        ogi.sku_name as skuName,
        ogi.goods_line_type as goodsLineType,
        ogi.order_qty as orderQty,
        ogi.return_price as returnPrice,
        oci.purchase_price as purchasePrice,
        oci.qty as couponQty ,
        obi.ord_no as referenceNumber,
        wh.wh_name as wareHouse
        from ord_base_info obi
        LEFT JOIN ord_goods_info ogi ON obi.ord_no =ogi.ord_no
        LEFT JOIN ord_delivery_info_details odid ON obi.ord_no = odid.order_no
        LEFT JOIN st_store ss ON obi.store_id = ss.store_id
        LEFT JOIN (select ord_no,purchase_price ,count(*) as qty,sku from ord_coupon_info GROUP BY sku,purchase_price,ord_no) oci ON obi.ord_no= oci.ord_no
        AND oci.sku = ogi.sku  AND ogi.goods_line_type='PRODUCT_COUPON'
        LEFT JOIN warehouse wh on wh.wh_no = odid.warehouse_no
        where
        obi.delivery_type ='HOUSE_DELIVERY'
        AND
        odid.logistic_status='SEALED_CAR'
        <if test="null !=storeId">
            AND
            obi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            obi.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime">
            AND
            odid.create_time >= #{startTime}
        </if>
        <if test="null !=endTime  and ''!=endTime">
            AND
            <![CDATA[odid.create_time<= #{endTime}]]>
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION ALL

        select
        DISTINCT
        obi.city_name as cityName,
        obi.store_id as store_id,
        ss.store_name as storeName,
        ss.store_type as storeType,
        obi.ord_no as ordNo,
        ol.operation_time as operationTime,
        obi.create_time as createTime,
        obi.customer_id as customerId,
        obi.customer_phone as customerPhone,
        obi.customer_name as customerName ,
        obi.customer_type as customerType,
        obi.sales_consult_name as salesConsultName,
        ogi.company_flag as companyFlag,
        ogi.sku as sku,
        ogi.sku_name as skuName,
        ogi.goods_line_type as goodsLineType,
        ogi.order_qty as orderQty,
        ogi.return_price as returnPrice,
        oci.purchase_price as purchasePrice,
        oci.qty as couponQty,
        obi.ord_no as referenceNumber,
        "" as wareHouse
        from ord_base_info obi
        LEFT JOIN ord_goods_info ogi ON ogi.ord_no =obi.ord_no
        LEFT JOIN st_store ss ON obi.store_id = ss.store_id
        LEFT JOIN ord_lifecycle ol ON obi.ord_no = ol.ord_no
        LEFT JOIN (select ord_no,purchase_price ,count(*) as qty,sku from ord_coupon_info GROUP BY sku,purchase_price,ord_no) oci ON obi.ord_no= oci.ord_no
        AND oci.sku = ogi.sku  AND ogi.goods_line_type='PRODUCT_COUPON'
        where
        obi.delivery_type ='SELF_TAKE'
        AND
        obi.status ='FINISHED'
        AND
        ol.post_status = 'FINISHED'
        <if test="null !=storeId">
            AND
            obi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            obi.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime ">
            AND
            ol.operation_time >= #{startTime}
        </if>
        <if test="null !=endTime and ''!=endTime">
            AND
            <![CDATA[ol.operation_time<= #{endTime} ]]>
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="getJxPriceByOrderNoAndSku"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AccountGoodsItemsDO">
        SELECT
        IFNULL(unit_price, 0) wholesalePrice, IFNULL(unit_price, 0) * IFNULL(quantity, 0) wholesaleTotlePrice
        FROM
        ord_jx_price_difference_return_details
        WHERE ord_no = #{orderNumber} AND sku = #{sku}
        GROUP BY sku
        UNION
        SELECT
        IFNULL(unit_price, 0) wholesalePrice, IFNULL(unit_price, 0) * IFNULL(return_qty, 0) wholesaleTotlePrice
        FROM
        ord_return_jx_price_difference_return_details
        WHERE return_no = #{orderNumber} AND sku = #{sku}
        GROUP BY sku
    </select>

    <select id="findNoProductSalesList" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.SalesReportDO">
        (SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '配送' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE wa.end_dt WHEN null THEN '一代数据' ELSE wa.end_dt END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END
        as'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price) from ord_coupon_info where ord_no =
        ob.ord_no and og.sku = sku) , (og.order_qty ) * og.return_price ) as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price - (sog.settlement_price -
        sog.wholesale_price)) from ord_coupon_info soc LEFT JOIN ord_goods_info sog ON soc.oid = sog.oid where
        soc.ord_no = ob.ord_no and og.sku = soc.sku and soc.purchase_price != 0) , (og.order_qty ) * (og.return_price -
        (og.settlement_price - og.wholesale_price)) ) as 'distributionSales',
        og.wholesale_price as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        og.order_qty as 'orderQty'
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON ob.ord_no = wa.order_no

        WHERE
        ob.`status` IN (
        'PENDING_RECEIVE',
        'FINISHED'
        )
        <if test="null !=startTime and ''!=startTime">
            AND obd.pay_up_time >= #{startTime}
        </if>
        <if test=" null != endTime and ''!=endTime">
            and
            <![CDATA[ obd.pay_up_time<= #{endTime}]]> and wa.end_dt &lt; #{endTime}
        </if>
        and ob.delivery_type = 'HOUSE_DELIVERY'
        and obd.is_pay_up = 1
        <!--<if test="null!=companyCode and ''!=companyCode">
                and s.store_structure_code like concat('%',#{companyCode},'%')
            </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and (s.store_type in ('ZS') or s.store_structure_code like concat("%|JZC001|%") )
            </when>
            <when test="'FX'==storeType">
                and s.store_type  in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL

        (SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '自提' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        os.shipping_time as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE os.shipping_time WHEN null THEN '一代数据' ELSE os.shipping_time END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END
        as'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price) from ord_coupon_info where ord_no =
        ob.ord_no and og.sku = sku) , (og.order_qty ) * og.return_price ) as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price - (sog.settlement_price -
        sog.wholesale_price)) from ord_coupon_info soc LEFT JOIN ord_goods_info sog ON soc.oid = sog.oid where
        soc.ord_no = ob.ord_no and og.sku = soc.sku and soc.purchase_price != 0) , (og.order_qty ) * (og.return_price -
        (og.settlement_price - og.wholesale_price)) ) as 'distributionSales',
        og.wholesale_price as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        og.order_qty as 'orderQty'
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_shipping os on ob.oid = os.oid
        WHERE
        ob.`status` IN (
        'FINISHED'
        )
        <if test="null != startTime and ''!=startTime">
            AND obd.pay_up_time >= #{startTime}
        </if>
        <if test=" null!=endTime and ''!=endTime">
            and
            <![CDATA[ obd.pay_up_time<= #{endTime}]]> and os.shipping_time &lt; #{endTime}
        </if>
        AND ob.delivery_type = 'SELF_TAKE'
        and obd.is_pay_up = 1
        <!--      <if test="null !=companyCode and ''!=companyCode">
                  and s.store_structure_code like concat('%',#{companyCode},'%')
              </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and (s.store_type in ('ZS') or s.store_structure_code like concat("%|JZC001|%") )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL

        (SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '配送' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE wa.end_dt WHEN null THEN '一代数据' ELSE wa.end_dt END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price) from ord_coupon_info where ord_no =
        ob.ord_no and og.sku = sku) , (og.order_qty ) * og.return_price ) as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price - (sog.settlement_price -
        sog.wholesale_price)) from ord_coupon_info soc LEFT JOIN ord_goods_info sog ON soc.oid = sog.oid where
        soc.ord_no = ob.ord_no and og.sku = soc.sku and soc.purchase_price != 0) , (og.order_qty ) * (og.return_price -
        (og.settlement_price - og.wholesale_price)) ) as 'distributionSales',
        og.wholesale_price as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        og.order_qty as 'orderQty'
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON ob.ord_no = wa.order_no
        WHERE
        ob.`status` IN (
        'PENDING_RECEIVE',
        'FINISHED'
        )
        <if test="null !=startTime and ''!=startTime">
            AND wa.end_dt >= #{startTime}
        </if>
        <if test="null !=endTime and ''!=endTime">
            and
            <![CDATA[  wa.end_dt<= #{endTime} ]]>
        </if>

        <if test="null !=startTime and ''!=startTime">
            and
            <![CDATA[ obd.pay_up_time<= #{startTime} ]]>
        </if>
        and ob.delivery_type = 'HOUSE_DELIVERY'
        and obd.is_pay_up = 1
        <!-- <if test="null !=companyCode and ''!=companyCode">
             and s.store_structure_code like concat('%',#{companyCode},'%')
         </if>-->

        <choose>
            <when test="'ZS'==storeType">
                and (s.store_type in ('ZS') or s.store_structure_code like concat("%|JZC001|%") )
            </when>
            <when test="'FX'==storeType">
                and s.store_type  in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL
        (SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '自提' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        os.shipping_time as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE os.shipping_time WHEN null THEN '一代数据' ELSE os.shipping_time END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price) from ord_coupon_info where ord_no =
        ob.ord_no and og.sku = sku) , (og.order_qty ) * og.return_price ) as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,(SELECT SUM(purchase_price - (sog.settlement_price -
        sog.wholesale_price)) from ord_coupon_info soc LEFT JOIN ord_goods_info sog ON soc.oid = sog.oid where
        soc.ord_no = ob.ord_no and og.sku = soc.sku and soc.purchase_price != 0) , (og.order_qty ) * (og.return_price -
        (og.settlement_price - og.wholesale_price)) ) as 'distributionSales',
        og.wholesale_price as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        og.order_qty as 'orderQty'
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_shipping os on ob.oid = os.oid
        WHERE
        ob.`status` IN (
        'FINISHED'
        )
        <if test="null!=startTime and ''!=startTime">
            AND
            <![CDATA[  os.shipping_time >= #{startTime} ]]>
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ os.shipping_time<= #{endTime} ]]>
        </if>

        <if test="null!=startTime and ''!=startTime">
            and
            <![CDATA[  obd.pay_up_time<= #{startTime} ]]>
        </if>
        AND ob.delivery_type = 'SELF_TAKE'
        and obd.is_pay_up = 1
        <!--    <if test="null !=companyCode and ''!=companyCode">
                and s.store_structure_code like concat('%',#{companyCode},'%')
            </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and (s.store_type in ('ZS') or s.store_structure_code like concat("%|JZC001|%") )
            </when>
            <when test="'FX'==storeType">
                and s.store_type  in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL
        (SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        CASE ob.delivery_type when 'HOUSE_DELIVERY' then '配送' WHEN 'SELF_TAKE' THEN '自提' end as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        '' as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        org.sku as 'sku',
        org.sku_name as 'skuName',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        org.company_flag as 'companyFlag',
        -ABS(org.return_price * org.return_qty) as 'financialSales',
        -ABS(org.wholesale_price * org.return_qty) as 'distributionSales',
        -ABS(org.wholesale_price) as 'wholesalePrice',
        0 as 'retailPrice',
        0 as 'settlementPrice',
        0 as 'memberDiscount',
        0 as 'promotionSharePrice',
        0 as 'cashCouponSharePrice',
        -ABS(org.return_qty) as 'orderQty'
        FROM
        ord_return_base_info orb
        LEFT JOIN ord_base_info ob on orb.oid = ob.oid
        LEFT JOIN ord_return_goods_info org on orb.roid = org.roid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN inter_wta_return_order_back_header wro ON wro.po_no = orb.return_no
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        where
        1=1
        and ob.`status` IN ('FINISHED')
        <if test="null !=startTime and ''!=startTime">
            AND
            wro.c_end_dt >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ wro.c_end_dt <= #{endTime} ]]>
        </if>
        <!--   <if test="null!=companyCode and ''!=companyCode">
               and s.store_structure_code like concat('%',#{companyCode},'%')
           </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and (s.store_type in ('ZS') or s.store_structure_code like concat("%|JZC001|%") )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in  ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        )
        UNION ALL
        (SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        CASE ob.delivery_type when 'HOUSE_DELIVERY' then '配送' WHEN 'SELF_TAKE' THEN '自提' end as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        '' as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        org.sku as 'sku',
        org.sku_name as 'skuName',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        org.company_flag as 'companyFlag',
        -ABS(org.return_price * org.return_qty) as 'financialSales',
        -ABS(org.wholesale_price * org.return_qty) as 'distributionSales',
        -ABS(org.wholesale_price) as 'wholesalePrice',
        0 as 'retailPrice',
        0 as 'settlementPrice',
        0 as 'memberDiscount',
        0 as 'promotionSharePrice',
        0 as 'cashCouponSharePrice',
        -ABS(org.return_qty) as 'orderQty'
        FROM
        ord_return_base_info orb
        LEFT JOIN ord_base_info ob on orb.oid = ob.oid
        LEFT JOIN ord_return_goods_info org on orb.roid = org.roid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        where
        1=1
        AND ob.delivery_type = 'SELF_TAKE' and orb.return_type = 'NORMAL_RETURN' and orb.return_status = 'FINISHED'
        <if test="null !=startTime and ''!=startTime">
            AND
            orb.return_time >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ orb.return_time <= #{endTime} ]]>
        </if>
        <!--   <if test="null!=companyCode and ''!=companyCode">
               and s.store_structure_code like concat('%',#{companyCode},'%')
           </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and (s.store_type in ('ZS') or s.store_structure_code like concat("%|JZC001|%") )
            </when>
            <when test="'FX'==storeType">
                and s.store_type  in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        )
    </select>



    <select id="findProductSalesList" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.SalesReportDO">
        <!-- 配送 -->
        (SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '配送' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE wa.end_dt WHEN null THEN '一代数据' ELSE wa.end_dt END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,oci.purchase_price , (og.order_qty ) * og.return_price ) as
        'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,if(og2.goods_line_type = "GOODS",(oci.purchase_price - (og.settlement_price - og.wholesale_price)),oci.purchase_price)) ,
        IF(og.goods_line_type = "GOODS" , (og.wholesale_price * og.order_qty) , 0) ) as 'distributionSales',
        if(og.goods_line_type = "GOODS", og.wholesale_price , if((og.goods_line_type = "PRESENT" OR oci.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,og.wholesale_price)) as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN 1 ELSE og.order_qty END as 'orderQty',
        if(og.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        '' as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        -- LEFT JOIN gds_goods_grade gp on og.sku = gp.sku
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON ob.ord_no = wa.order_no
        LEFT JOIN ord_coupon_info oci on ob.oid = oci.oid and og.sku = oci.sku  and og.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.coupon_id
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        WHERE
        ob.`status` IN (
        'PENDING_RECEIVE',
        'FINISHED'
        )
        <if test="null!=startTime and ''!=startTime">
            AND obd.pay_up_time >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[obd.pay_up_time<= #{endTime}]]> and wa.end_dt &lt; #{endTime}
        </if>
        and obd.is_pay_up = 1
        and ob.delivery_type = 'HOUSE_DELIVERY'
        <!--       <if test="null!=companyCode and ''!=companyCode">
                   and s.store_structure_code like concat('%',#{companyCode},'%')
               </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and ((s.store_type in ('ZS') and s.fit_compay_type = "MONTHLY") or (s.store_structure_code like concat("%|JZC001|%") and s.store_type = 'ZY' ) )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        <if test="productType != null and productType == 'HR'">
            and og.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and og.company_flag in ('LYZ','YR')
        </if>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL
        <!-- 自提 -->
        (SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '自提' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as
        'orderStatus',
        os.shipping_time as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE os.shipping_time WHEN null THEN '一代数据' ELSE os.shipping_time END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT'
        THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',

        if(og.goods_line_type = "PRODUCT_COUPON" ,purchase_price , (og.order_qty ) * og.return_price )
        as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,if(og2.goods_line_type = "GOODS",(oci.purchase_price - (og.settlement_price - og.wholesale_price)),oci.purchase_price)),
        IF(og.goods_line_type = "GOODS" , (og.wholesale_price * og.order_qty) , 0) ) as
        'distributionSales',
        if(og.goods_line_type = "GOODS", og.wholesale_price , if((og.goods_line_type = "PRESENT" OR oci.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,og.wholesale_price)) as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN 1 ELSE og.order_qty END as 'orderQty',
        if(og.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        '' as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_shipping os on ob.oid = os.oid
        LEFT JOIN ord_coupon_info oci on ob.oid = oci.oid and og.sku = oci.sku  and og.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.coupon_id
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        WHERE
        ob.`status` IN (
        'FINISHED'
        )
        <if test="null!=startTime and ''!=startTime">
            AND obd.pay_up_time >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and   <![CDATA[ obd.pay_up_time <= #{endTime}]]> and os.shipping_time &lt; #{endTime}
        </if>
        AND ob.delivery_type = 'SELF_TAKE'
        and obd.is_pay_up = 1
        <!--        <if test="null!=companyCode and ''!=companyCode">
                    and s.store_structure_code like concat('%',#{companyCode},'%')
                </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and ((s.store_type in ('ZS') and s.fit_compay_type = "MONTHLY") or (s.store_structure_code like concat("%|JZC001|%") and s.store_type = 'ZY' ) )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>

        <if test="productType != null and productType == 'HR'">
            and og.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and og.company_flag in ('LYZ','YR')
        </if>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL

        <!-- 配送 之前结清本月出货 -->
        (SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '配送' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成'
        end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE wa.end_dt WHEN null THEN '一代数据' ELSE wa.end_dt END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as
        'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品'
        WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,purchase_price , (og.order_qty ) *
        og.return_price ) as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,if(og2.goods_line_type = "GOODS",(oci.purchase_price - (og.settlement_price - og.wholesale_price)),oci.purchase_price)),
        IF(og.goods_line_type = "GOODS" , (og.wholesale_price * og.order_qty) , 0)
        ) as 'distributionSales',
        if(og.goods_line_type = "GOODS", og.wholesale_price , if((og.goods_line_type = "PRESENT" OR oci.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,og.wholesale_price)) as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN 1 ELSE og.order_qty END as 'orderQty',
        if(og.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        '' as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON ob.ord_no = wa.order_no
        LEFT JOIN ord_coupon_info oci on ob.oid = oci.oid and og.sku = oci.sku  and og.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.coupon_id
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        WHERE
        ob.`status` IN (
        'PENDING_RECEIVE',
        'FINISHED'
        )
        <if test="null!=startTime and ''!=startTime">
            AND wa.end_dt >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[wa.end_dt <= #{endTime} ]]>
        </if>

        <if test="null!=startTime and ''!=startTime">
            and
            <![CDATA[ obd.pay_up_time < #{startTime} ]]>
        </if>
        and ob.delivery_type = 'HOUSE_DELIVERY'
        and obd.is_pay_up = 1
        <!--        <if test="null!=companyCode and ''!=companyCode">
                    and s.store_structure_code like concat('%',#{companyCode},'%')
                </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and ((s.store_type in ('ZS') and s.fit_compay_type = "MONTHLY") or (s.store_structure_code like concat("%|JZC001|%") and s.store_type = 'ZY' ) )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in  ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>

        <if test="productType != null and productType == 'HR'">
            and og.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and og.company_flag in ('LYZ','YR')
        </if>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL

        <!-- 自提 之前结清本月出货 -->
        (SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '自提' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN
        'FINISHED' THEN '已完成' end as 'orderStatus',
        os.shipping_time as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE os.shipping_time WHEN null THEN '一代数据' ELSE
        os.shipping_time END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as
        'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time
        end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN
        'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',

        if(og.goods_line_type = "PRODUCT_COUPON" ,purchase_price ,
        (og.order_qty ) * og.return_price ) as 'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,if(og2.goods_line_type = "GOODS",(oci.purchase_price - (og.settlement_price - og.wholesale_price)),oci.purchase_price)),
        IF(og.goods_line_type = "GOODS" , (og.wholesale_price * og.order_qty) , 0)
         ) as 'distributionSales',
        if(og.goods_line_type = "GOODS", og.wholesale_price , if((og.goods_line_type = "PRESENT" OR oci.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,og.wholesale_price)) as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN 1 ELSE
        og.order_qty END as 'orderQty',
        if(og.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        '' as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_shipping os on ob.oid = os.oid
        LEFT JOIN ord_coupon_info oci on ob.oid = oci.oid and og.sku =oci.sku  and og.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.coupon_id
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        WHERE
        ob.`status` IN (
        'FINISHED'
        )
        <if test="null!=startTime and ''!=startTime">
            AND os.shipping_time >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ os.shipping_time <= #{endTime} ]]>
        </if>
        <if test="null!=startTime and ''!=startTime">
            and  <![CDATA[ obd.pay_up_time < #{startTime}]]>
        </if>
        AND ob.delivery_type = 'SELF_TAKE'
        and obd.is_pay_up = 1
        <!--  <if test="null!=companyCode and ''!=companyCode">
              and s.store_structure_code like concat('%',#{companyCode},'%')
          </if>-->

        <choose>
            <when test="'ZS'==storeType">
                and ((s.store_type in ('ZS') and s.fit_compay_type = "MONTHLY") or (s.store_structure_code like concat("%|JZC001|%") and s.store_type = 'ZY' ) )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in  ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        <if test="productType != null and productType == 'HR'">
            and og.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and og.company_flag in ('LYZ','YR')
        </if>
        order by ob.store_id,ob.sales_consult_id,ob.create_time)

        UNION ALL

        <!-- 配送 退货 -->
        (SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        CASE ob.delivery_type when 'HOUSE_DELIVERY' then '配送' WHEN 'SELF_TAKE' THEN '自提' end as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        '' as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        org.sku as 'sku',
        org.sku_name as 'skuName',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        org.company_flag as 'companyFlag',
        if(org.goods_line_type = "PRODUCT_COUPON" ,-ABS(oci.purchase_price),-ABS(org.return_price * org.return_qty)) as 'financialSales',
        if(org.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,-ABS(if(og2.goods_line_type = "GOODS",(oci.purchase_price - (org.settlement_price - org.wholesale_price)),oci.purchase_price) * org.return_qty)) ,
        -ABS(IF(org.goods_line_type = "GOODS" , (org.wholesale_price * org.return_qty) , 0))) as 'distributionSales',
        -ABS(if(org.goods_line_type = "GOODS", org.wholesale_price , if((org.goods_line_type = "PRESENT" OR ccpc.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,org.wholesale_price))) as 'wholesalePrice',
        0 as 'retailPrice',
        0 as 'settlementPrice',
        0 as 'memberDiscount',
        0 as 'promotionSharePrice',
        0 as 'cashCouponSharePrice',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN -1 ELSE -ABS(org.return_qty) END as 'orderQty',
        if(org.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        orb.return_no as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_return_base_info orb
        LEFT JOIN ord_base_info ob on orb.oid = ob.oid
        LEFT JOIN ord_return_goods_info org on orb.roid = org.roid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN inter_wta_return_order_back_header wro ON wro.po_no = orb.return_no
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_return_product_coupon oci on orb.roid = oci.roid and org.sku = oci.sku and org.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.pcid
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        where
        1=1
        and ob.`status` IN ('FINISHED')
        <if test="null!=startTime and ''!=startTime">
            AND
            wro.c_end_dt > #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ wro.c_end_dt <= #{endTime} ]]>
        </if>
        <!--   <if test="null!=companyCode and ''!=companyCode">
               and s.store_structure_code like concat('%',#{companyCode},'%')
           </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and ((s.store_type in ('ZS') and s.fit_compay_type = "MONTHLY") or (s.store_structure_code like concat("%|JZC001|%") and s.store_type = 'ZY' ) )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        <if test="productType != null and productType == 'HR'">
            and org.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and org.company_flag in ('LYZ','YR')
        </if>
        )

        UNION  ALL

        <!-- 自提 退货 -->
        (SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        CASE ob.delivery_type when 'HOUSE_DELIVERY' then '配送' WHEN 'SELF_TAKE' THEN '自提' end as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        '' as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        org.sku as 'sku',
        org.sku_name as 'skuName',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        org.company_flag as 'companyFlag',
        if(org.goods_line_type = "PRODUCT_COUPON" ,-ABS(oci.purchase_price),-ABS(org.return_price * org.return_qty)) as 'financialSales',
        if(org.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,-ABS(if(og2.goods_line_type = "GOODS",(oci.purchase_price - (org.settlement_price - org.wholesale_price)),oci.purchase_price) * org.return_qty)) ,
        -ABS(IF(org.goods_line_type = "GOODS" , (org.wholesale_price * org.return_qty) , 0))) as 'distributionSales',
        -ABS(if(org.goods_line_type = "GOODS", org.wholesale_price , if((org.goods_line_type = "PRESENT" OR ccpc.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,org.wholesale_price))) as 'wholesalePrice',
        0 as 'retailPrice',
        0 as 'settlementPrice',
        0 as 'memberDiscount',
        0 as 'promotionSharePrice',
        0 as 'cashCouponSharePrice',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN -1 ELSE -ABS(org.return_qty) END as 'orderQty',
        if(org.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        orb.return_no as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_return_base_info orb
        LEFT JOIN ord_base_info ob on orb.oid = ob.oid
        LEFT JOIN ord_return_goods_info org on orb.roid = org.roid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id

        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_return_product_coupon oci on orb.roid = oci.roid and org.sku = oci.sku and org.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.pcid
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        LEFT JOIN ord_return_lifecycle orl on orl.return_no = orb.return_no and orl.operation = "NORMAL_RETURN" and orl.post_status = "FINISHED"
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        where
        1=1
        AND ob.delivery_type = 'SELF_TAKE' and orb.return_type = 'NORMAL_RETURN'
        and orb.return_status = 'FINISHED'
        <if test="null!=startTime and ''!=startTime">
            AND
            orl.operation_time > #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ orl.operation_time <= #{endTime} ]]>
        </if>
        <!--   <if test="null!=companyCode and ''!=companyCode">
               and s.store_structure_code like concat('%',#{companyCode},'%')
           </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and ((s.store_type in ('ZS') and s.fit_compay_type = "MONTHLY") or (s.store_structure_code like concat("%|JZC001|%") and s.store_type = 'ZY' ) )
            </when>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and s.store_type =#{storeType}
                </if>
                AND ob.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        <if test="productType != null and productType == 'HR'">
            and org.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and org.company_flag in ('LYZ','YR')
        </if>
        )

        <!-- 配送 现结装饰公司销量 -->

        UNION ALL
        (
        SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e2.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        '配送' as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        CASE wa.end_dt WHEN null THEN '一代数据' ELSE wa.end_dt END as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        og.sku as 'sku',
        og.sku_name as 'skuName',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        og.company_flag as 'companyFlag',
        if(og.goods_line_type = "PRODUCT_COUPON" ,oci.purchase_price , (og.order_qty ) * og.return_price ) as
        'financialSales',
        if(og.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,if(og2.goods_line_type = "GOODS",(oci.purchase_price - (og.settlement_price - og.wholesale_price)),oci.purchase_price)) ,
        IF(og.goods_line_type = "GOODS" , (og.wholesale_price * og.order_qty) , 0)) as 'distributionSales',
        if(og.goods_line_type = "GOODS", og.wholesale_price , if((og.goods_line_type = "PRESENT" OR oci.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,og.wholesale_price)) as 'wholesalePrice',
        og.retail_price as 'retailPrice',
        og.settlement_price as 'settlementPrice',
        (og.retail_price - og.settlement_price) as 'memberDiscount',
        og.promotion_share_price as 'promotionSharePrice',
        og.cash_coupon_share_price as 'cashCouponSharePrice',
        CASE og.goods_line_type WHEN 'PRODUCT_COUPON' THEN 1 ELSE og.order_qty END as 'orderQty',
        if(og.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        '' as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og on og.oid = ob.oid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        -- LEFT JOIN gds_goods_grade gp on og.sku = gp.sku
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON ob.ord_no = wa.order_no
        LEFT JOIN ord_coupon_info oci on ob.oid = oci.oid and og.sku = oci.sku  and og.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.coupon_id
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        LEFT JOIN emp_employee e2 on e2.emp_id = s.sales_manager
        LEFT JOIN st_store st2 on st2.store_id = e2.store_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        WHERE
        ob.`status` IN (
        'PENDING_RECEIVE',
        'FINISHED'
        )
        <if test="null!=startTime and ''!=startTime">
            AND obd.pay_up_time >= #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[obd.pay_up_time<= #{endTime}]]> and wa.end_dt &lt; #{endTime}
        </if>
        and obd.is_pay_up = 1
        and ob.delivery_type = 'HOUSE_DELIVERY'
        <!--       <if test="null!=companyCode and ''!=companyCode">
                   and s.store_structure_code like concat('%',#{companyCode},'%')
               </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and s.store_type = -1
            </when>
            <when test="'FX'==storeType">
                and s.store_type = -1
            </when>
            <otherwise>

                and s.store_type in ('ZS') and s.fit_compay_type = "CASH"
                and st2.store_id in
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        <if test="productType != null and productType == 'HR'">
            and og.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and og.company_flag in ('LYZ','YR')
        </if>
        order by ob.store_id,ob.sales_consult_id,ob.create_time
        )

        <!-- 配送 现结装饰公司退货-->

        UNION ALL

        (
        SELECT
        s.store_type as 'storeType',
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        e2.`name` as 'name',
        ob.customer_name as 'customerName',
        ob.ord_no as 'ordNo',
        CASE ob.delivery_type when 'HOUSE_DELIVERY' then '配送' WHEN 'SELF_TAKE' THEN '自提' end as 'orderType',
        CASE ob.`status` WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' end as 'orderStatus',
        '' as 'selfTakeOrderTime',
        ob.create_time as 'createTime',
        '' as 'shippingDate',
        CASE obd.is_pay_up WHEN 0 THEN '未结清' WHEN 1 THEN '结清' end as 'isPayUp',
        CASE obd.is_pay_up WHEN 0 THEN null WHEN 1 THEN obd.pay_up_time end as 'payUpTime',
        org.sku as 'sku',
        org.sku_name as 'skuName',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN '产品券' WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品' END as
        'goodsType',
        org.company_flag as 'companyFlag',
        if(org.goods_line_type = "PRODUCT_COUPON" ,-ABS(oci.purchase_price),-ABS(org.return_price * org.return_qty)) as 'financialSales',
        if(org.goods_line_type = "PRODUCT_COUPON" ,
        if(oci.purchase_price = 0,0,
        -ABS(if(og2.goods_line_type = "GOODS",(oci.purchase_price - (org.settlement_price - org.wholesale_price)),oci.purchase_price) * org.return_qty)) ,
        -ABS(IF(org.goods_line_type = "GOODS" , (org.wholesale_price * org.return_qty) , 0))) as 'distributionSales',
        -ABS(if(org.goods_line_type = "GOODS", org.wholesale_price , if((org.goods_line_type = "PRESENT" OR ccpc.get_type = 'MANUAL_GRANT' or oci.purchase_price = 0),0,org.wholesale_price))) as 'wholesalePrice',
        0 as 'retailPrice',
        0 as 'settlementPrice',
        0 as 'memberDiscount',
        0 as 'promotionSharePrice',
        0 as 'cashCouponSharePrice',
        CASE org.goods_line_type WHEN 'PRODUCT_COUPON' THEN -1 ELSE -ABS(org.return_qty) END as 'orderQty',
        if(org.goods_line_type = "PRODUCT_COUPON",CASE og2.goods_line_type WHEN 'GOODS' THEN '本品' WHEN 'PRESENT' THEN '赠品'  ELSE '后台发放' END,'')  as 'couponType',
        orb.return_no as 'returnNo',
        CASE s.store_type WHEN 'FX' THEN s.store_code WHEN 'FXCK' THEN cu.fx_store_code END as 'fxStoreCode',
        ob.customer_id as cusId
        FROM
        ord_return_base_info orb
        LEFT JOIN ord_base_info ob on orb.oid = ob.oid
        LEFT JOIN ord_return_goods_info org on orb.roid = org.roid
        LEFT JOIN st_store s on ob.store_id = s.store_id
        LEFT JOIN emp_employee e on ob.sales_consult_id = e.emp_id
        LEFT JOIN inter_wta_return_order_back_header wro ON wro.po_no = orb.return_no
        LEFT JOIN ord_billing_details obd on ob.oid = obd.oid
        LEFT JOIN ord_return_product_coupon oci on orb.roid = oci.roid and org.sku = oci.sku and org.goods_line_type = 'PRODUCT_COUPON'
        LEFT JOIN cus_customer_product_coupon ccpc on ccpc.id = oci.pcid
        LEFT JOIN ord_goods_info og2 on og2.id = ccpc.goods_line_id
        LEFT JOIN emp_employee e2 on e2.emp_id = s.sales_manager
        LEFT JOIN st_store st2 on st2.store_id = e2.store_id
        left JOIN cus_customer_fx_store_relation cu on ob.customer_id = cu.cus_id
        where
        1=1
        and ob.`status` IN ('FINISHED')
        <if test="null!=startTime and ''!=startTime">
            AND
            wro.c_end_dt > #{startTime}
        </if>
        <if test="null!=endTime and ''!=endTime">
            and
            <![CDATA[ wro.c_end_dt <= #{endTime} ]]>
        </if>
        <!--   <if test="null!=companyCode and ''!=companyCode">
               and s.store_structure_code like concat('%',#{companyCode},'%')
           </if>-->
        <choose>
            <when test="'ZS'==storeType">
                and s.store_type = -1
            </when>
            <when test="'FX'==storeType">
                and s.store_type = -1
            </when>
            <otherwise>

                and s.store_type in ('ZS') and s.fit_compay_type = "CASH"
                and st2.store_id in
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        <if test="productType != null and productType == 'HR'">
            and org.company_flag = #{productType}
        </if>
        <if test="productType != null and productType == 'LYZ'">
            and org.company_flag in ('LYZ','YR')
        </if>
        )
    </select>

    <select id="findAccountZGGoodsItemsDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AccountGoodsItemsDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, ol.operation_time
        orderTime,'' as createTime, obi.ord_no orderNumber,
        null returnNumber, obi.customer_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType, oli.receiver receiver, oli.receiver_phone receiverPhone,
        (CASE WHEN obi.`status` = 'FINISHED' OR obi.`status` = 'CLOSED' OR obi.`status` = 'REJECTED'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'HOUSE_DELIVERY')THEN '已出货'
        WHEN obi.`status` = 'CANCELED' OR obi.`status` = 'CANCELING' OR obi.`status` = 'PENDING_SHIPMENT'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'SELF_TAKE') THEN '未出货' ELSE '未知'
        END)deliveryStatus,
        oli.shipping_address, og.sku sku, og.sku_name skuName, (CASE WHEN og.company_flag = 'HR' THEN '华润'
        WHEN og.company_flag = 'LYZ' THEN '乐易装' WHEN og.company_flag = 'YR' THEN '莹润' ELSE '其他' END)companyFlag,
        og.goods_line_type goodsLineType, IFNULL(og.order_qty, 0) quantity,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku)/og.order_qty,0),
        IFNULL(og.settlement_price, 0)) settlementPrice,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku),0),
        (IFNULL(og.order_qty, 0) * IFNULL(og.settlement_price, 0))) settlementTotlePrice,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku)/og.order_qty,0),
        IFNULL(og.return_price, 0)) promotionSharePrice,
        if(og.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = obi.ord_no and og.sku = sku),0),
        (IFNULL(og.order_qty, 0) * IFNULL(og.return_price, 0))) promotionShareTotlePrice,
        obi.customer_phone customerPhone, st.company_name companyName
        FROM
        ord_base_info obi
        /*INNER JOIN st_store st ON st.store_id = obi.store_id*/
        LEFT JOIN ord_goods_info og ON og.ord_no = obi.ord_no
        /*AND og.goods_sign != 'COMMON'*/
        INNER JOIN rank_store st ON st.store_id = obi.store_id
        INNER JOIN rank_goods rg ON rg.gid = og.gid
        LEFT JOIN (SELECT DISTINCT ord_no,post_status,operation_time from ord_lifecycle) ol ON obi.ord_no = ol.ord_no
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        WHERE obi.`status` != 'UNPAID'
        AND (ol.post_status = 'PENDING_SHIPMENT' OR (ol.post_status = 'PENDING_RECEIVE' AND obi.delivery_type =
        'SELF_TAKE'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ol.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ol.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, orbi.return_time createTime, rl.operation_time
        orderTime, obi.ord_no orderNumber, orbi.return_no returnNumber, orbi.cus_name customerName, obi.sales_consult_name sellerName,
        obi.delivery_type deliveryType, orli.rejecter receiver, orli.rejecter_phone receiverPhone,
        (CASE WHEN orbi.return_type = 'REFUSED_RETURN' OR orbi.return_type = 'NORMAL_RETURN' THEN '已取货'
        WHEN orbi.return_type = 'CANCEL_RETURN' THEN '订单取消' ELSE '未知' END) deliveryStatus,
        orli.return_full_address, org.sku sku, org.sku_name skuName, (CASE WHEN org.company_flag = 'HR' THEN '华润'
        WHEN org.company_flag = 'LYZ' THEN '乐易装' WHEN org.company_flag = 'YR' THEN '莹润' ELSE '其他' END) companyFlag,
        org.goods_line_type goodsLineType, (-1 * IFNULL(org.return_qty,0)) quantity,
        if(org.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku)/org.return_qty,0),
        IFNULL(org.settlement_price, 0)) settlementPrice,
        if(org.goods_line_type = "PRODUCT_COUPON",-1 * IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku),0),
        (-1 * IFNULL(org.return_qty, 0) * IFNULL(org.settlement_price, 0))) settlementTotlePrice,
        if(org.goods_line_type = "PRODUCT_COUPON",IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku)/org.return_qty,0),
        IFNULL(org.return_price, 0)) promotionSharePrice,
        if(org.goods_line_type = "PRODUCT_COUPON",-1 * IFNULL((SELECT SUM(purchase_price) from ord_coupon_info where ord_no = orbi.ord_no and org.sku = sku),0),
        (-1 * IFNULL(org.return_qty, 0) * IFNULL(org.return_price, 0))) promotionShareTotlePrice,
        obi.customer_phone customerPhone, st.company_name companyName
        FROM ord_return_base_info orbi
        /*LEFT JOIN st_store st ON st.store_id = orbi.store_id*/
        LEFT JOIN (SELECT DISTINCT return_no,post_status,operation_time from ord_return_lifecycle) rl ON orbi.return_no = rl.return_no
        LEFT JOIN ord_return_goods_info org ON org.return_no = orbi.return_no
        /*AND org.goods_sign != 'COMMON'*/
        INNER JOIN rank_goods rg ON rg.sku = org.sku
        INNER JOIN rank_store st ON st.store_id = orbi.store_id
        LEFT JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        LEFT JOIN ord_return_logistic_info orli ON orli.return_no = orbi.return_no
        WHERE orbi.return_status = 'FINISHED' AND rl.post_status = 'FINISHED'
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != startTime and startTime != ''">
            AND rl.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND rl.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>



    <select id="findArrearsList" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.ArrearsReportDO">

      (
        SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        o.sales_consult_name as 'name',
        o.customer_name as 'customerName',
        o.create_time as 'createTime',
        o.ord_no as 'ordNo',
        if(o.delivery_type='SELF_TAKE','门店自提','送货上门')as 'orderType',
        CASE  o.`status`  WHEN 'CANCELING' THEN '取消中' WHEN 'REJECTED' THEN '拒签' WHEN 'PENDING_SHIPMENT' THEN '待发货'
        WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' WHEN 'CANCELED' THEN '已取消'   END  as orderStatus,
        os.shipping_time as 'selfTakeOrderTime',
        wa.end_dt as 'shippingDate',
        b.order_amount_subtotal as 'orderAmount',
        b.emp_credit_money as 'orderCreditMoney',
        b.arrearage as 'orderArrearage',
        IFNULL(a.order_money,b.arrearage) as 'orderArrearageBefore',
        IFNULL(p.amount,0) as 'payUpMoney',
        IF(b.is_pay_up = TRUE,'是','否') as 'isPayUp',
        IF(b.is_pay_up = TRUE, b.pay_up_time,null) as 'payUpTime',
        CASE  d.status WHEN 'AUDITING' THEN '审核中' WHEN 'AUDIT_NO' THEN '审核不通过' WHEN 'AUDIT_PASSED' THEN '审核通过' END as auditStatus
        FROM ord_base_info o
        LEFT JOIN ord_billing_details b ON b.ord_no = o.ord_no
        LEFT JOIN (SELECT SUM(amount) amount,ord_no FROM ord_billing_payment_details GROUP BY ord_no) p ON o.ord_no = p.ord_no
        LEFT JOIN (SELECT * FROM ord_arrears_audit WHERE status = 'AUDIT_PASSED' GROUP BY ord_no) a ON a.ord_no = o.ord_no
        LEFT JOIN st_store s ON s.store_id = o.store_id
        LEFT JOIN ord_shipping os on o.oid = os.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON o.ord_no = wa.order_no
        LEFT JOIN  (SELECT * FROM (SELECT * FROM ord_arrears_audit  ORDER BY create_time DESC) c GROUP BY  c.ord_no) d ON  d.ord_no = o.ord_no
        where 1=1
        and
        o.`status` != 'REJECTED'
        AND
        o.`status` != 'CANCELED'
        AND
        o.`status` != 'UNPAID'
        AND
        b.is_pay_up = 0
        <choose>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
                <!-- AND o.store_id IN
                 <foreach collection="list" item="item" open="(" close=")" separator=",">
                     #{item}
                 </foreach>-->
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and  ( s.store_type =#{storeType}
                    OR  s.store_type = 'ZS')
                </if>
                AND o.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        GROUP BY o.ord_no
        ORDER BY storeName, name, createTime
        )
        UNION ALL

        (
        SELECT
        s.city as 'cityName',
        s.store_code as 'storeCode',
        s.store_name as 'storeName',
        o.sales_consult_name as 'name',
        o.customer_name as 'customerName',
        o.create_time as 'createTime',
        o.ord_no as 'ordNo',
        if(o.delivery_type='SELF_TAKE','门店自提','送货上门')as 'orderType',
        CASE  o.`status`  WHEN 'CANCELING' THEN '取消中' WHEN 'REJECTED' THEN '拒签' WHEN 'PENDING_SHIPMENT' THEN '待发货'
        WHEN 'PENDING_RECEIVE' THEN '待收货' WHEN 'FINISHED' THEN '已完成' WHEN 'CANCELED' THEN '已取消'   END  as orderStatus,
        os.shipping_time as 'selfTakeOrderTime',
        wa.end_dt as 'shippingDate',
        b.order_amount_subtotal as 'orderAmount',
        b.emp_credit_money as 'orderCreditMoney',
        b.arrearage as 'orderArrearage',
        IFNULL(a.order_money,b.arrearage) as 'orderArrearageBefore',
        IFNULL(p.amount,0) as 'payUpMoney',
        IF(b.is_pay_up = TRUE,'是','否') as 'isPayUp',
        IF(b.is_pay_up = TRUE, b.pay_up_time,null) as 'payUpTime',
        CASE  d.status WHEN 'AUDITING' THEN '审核中' WHEN 'AUDIT_NO' THEN '审核不通过' WHEN 'AUDIT_PASSED' THEN '审核通过' END as auditStatus
        FROM ord_base_info o
        LEFT JOIN ord_billing_details b ON b.ord_no = o.ord_no
        LEFT JOIN (SELECT SUM(amount) amount,ord_no FROM ord_billing_payment_details GROUP BY ord_no) p ON o.ord_no = p.ord_no
        LEFT JOIN (SELECT * FROM ord_arrears_audit WHERE status = 'AUDIT_PASSED' GROUP BY ord_no) a ON a.ord_no = o.ord_no
        LEFT JOIN st_store s ON s.store_id = o.store_id
        LEFT JOIN ord_shipping os on o.oid = os.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON o.ord_no = wa.order_no
        LEFT JOIN  (SELECT * FROM (SELECT * FROM ord_arrears_audit  ORDER BY create_time DESC) c GROUP BY  c.ord_no) d ON  d.ord_no = o.ord_no
        LEFT  JOIN ord_return_base_info orbi ON o.ord_no = orbi.ord_no
        LEFT JOIN  inter_wta_return_order_back_header iwr ON orbi.return_no = iwr.po_no
        where 1=1
        and
        o.`status` = 'REJECTED'
        AND
        iwr.id is NULL
        AND
        b.is_pay_up = 0
        <choose>
            <when test="'FX'==storeType">
                and s.store_type in ('FX','FXCK')
                <!-- AND o.store_id IN
                 <foreach collection="list" item="item" open="(" close=")" separator=",">
                     #{item}
                 </foreach>-->
            </when>
            <otherwise>
                <if test="null!=storeType and ''!=storeType">
                    and  ( s.store_type =#{storeType}
                    OR  s.store_type = 'ZS')
                </if>
                AND o.store_id IN
                <foreach collection="list" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </otherwise>
        </choose>
        GROUP BY o.ord_no
        ORDER BY storeName, name, createTime
        )

    </select>

    <select id="findDistributionDOAll" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.DistributionDO">
        SELECT
        wh.wh_name as whName,
        oli.delivery_clerk_name as deliveryClerkName,
        oli.delivery_clerk_phone as deliveryClerkPhone,
        s.city as city,
        s.store_name as storeName,
        e.`name` as sellerName,
        ob.customer_name as customerName,
        ob.ord_no as orderNo,
        '' as returnNo,
        CASE ob.delivery_status WHEN 'PENDING_RECEIVE' THEN '已封车' WHEN 'SENDING' THEN '未投妥'
        WHEN 'CONFIRM_ARRIVAL' THEN '已签收' WHEN 'REJECT' THEN '拒签' end as status,
        ob.create_time as orderTime,
        CASE wa.end_dt WHEN null THEN '一代数据' ELSE wa.end_dt END as shipmentsTime,
        d.create_time as finishTime,
        '' as returnTime,
        '' as pickupTime,
        '' as reverseTime,
        oli.shipping_address as shippingAddress,
        ob.remark as remark
        FROM
        ord_base_info ob LEFT JOIN ord_goods_info og ON og.oid = ob.oid
        LEFT JOIN st_store s ON ob.store_id = s.store_id
        LEFT JOIN emp_employee e ON ob.sales_consult_id = e.emp_id
        LEFT JOIN inter_wta_order_shipping_header wa ON ob.ord_no = wa.order_no
        LEFT JOIN ord_logistics_info oli ON ob.oid = oli.oid
        LEFT JOIN warehouse wh ON wh.wh_no = oli.warehouse
        LEFT JOIN ord_delivery_info_details d ON d.order_no = ob.ord_no AND d.logistic_status IN ('REJECTED','CONFIRM_ARRIVAL')
        WHERE
        ob.`status` IN (
        'PENDING_RECEIVE','FINISHED','REJECTED','CLOSED'
        )
        AND ob.delivery_status IN ('PENDING_RECEIVE','SENDING','CONFIRM_ARRIVAL','REJECT')
        AND ob.delivery_type = 'HOUSE_DELIVERY'
        AND wa.end_dt > '2018-05-19 00:00:00' AND wa.end_dt < '2018-05-30 23:59:59'
        AND wh.wh_no is not NULL
        GROUP BY orderNo,returnNo
        UNION ALL
        SELECT
        wh.wh_name as whName,
        oli.delivery_clerk_name as deliveryClerkName,
        oli.delivery_clerk_phone as deliveryClerkPhone,
        s.city as city,
        s.store_name as storeName,
        e.`name` as sellerName,
        ob.customer_name as customerName,
        ob.ord_no as orderNo,
        orb.return_no as returnNo,
        CASE orb.return_status WHEN 'FINISHED' THEN '已反配' WHEN 'PENDING_REFUND' THEN '待退款' END as status,
        '' as orderTime,
        '' as shipmentsTime,
        '' as finishTime,
        orb.return_time as returnTime,
        rd.create_time as pickupTime,
        wro.c_end_dt as reverseTime,
        oli.return_full_address as shippingAddress,
        orb.remarks_info as remark
        FROM
        ord_return_base_info orb
        LEFT JOIN ord_base_info ob ON orb.oid = ob.oid
        LEFT JOIN st_store s ON ob.store_id = s.store_id
        LEFT JOIN emp_employee e ON ob.sales_consult_id = e.emp_id
        LEFT JOIN inter_wta_return_order_back_header wro ON wro.po_no = orb.return_no
        LEFT JOIN ord_return_logistic_info oli ON orb.roid = oli.roid
        LEFT JOIN warehouse wh ON wh.wh_no = wro.wh_no
        LEFT JOIN ord_return_delivery_detail rd ON orb.return_no = rd.return_no AND rd.return_logistic_status = 'PICKUP_COMPLETE'
        WHERE
        orb.return_status IN ('FINISHED','PENDING_REFUND')
        AND
        ob.delivery_type = 'HOUSE_DELIVERY'
        AND wro.c_end_dt > '2018-05-19 00:00:00' AND wro.c_end_dt < '2018-05-30 23:59:59'
        GROUP BY orderNo,returnNo
        -- AND oli.delivery_clerk_name IS NOT NULL
        ORDER BY whName,deliveryClerkName,storeName,sellerName
    </select>


</mapper>