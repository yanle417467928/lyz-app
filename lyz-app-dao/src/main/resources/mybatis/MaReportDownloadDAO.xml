<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.MaReportDownloadDAO">
    <select id="findReceiptsReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.ReceiptsReportDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, obi.sales_consult_name sellerName, obpd.pay_time payTime,
        obpd.pay_type payTypes, obpd.pay_type payType, IFNULL(obpd.amount, 0) money, obi.ord_no orderNumber,
        IF(obpd.pay_type = 'POS',obd.store_pos_number,null) remarks, obpd.payment_subject_type paymentSubjectType
        FROM
        ord_billing_payment_details obpd
        INNER JOIN ord_base_info obi ON obi.ord_no = obpd.ord_no
        INNER JOIN st_store st ON st.store_id = obi.store_id
        INNER JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        WHERE 1=1
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND obpd.pay_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND obpd.pay_time &lt;= #{endTime}
        </if>
        <if test="null != payType and payType != ''">
            AND obpd.pay_type = #{payType}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, obi.sales_consult_name sellerName, orbd.create_time
        payTime,
        orbd.return_pay_type payTypes, orbd.return_pay_type payType, (-1 * IFNULL(orbd.return_money, 0)) money,
        orbi.return_no orderNumber,
        NULL remarks, null paymentSubjectType
        FROM ord_return_billing_detail orbd
        INNER JOIN ord_return_base_info orbi ON orbi.return_no = orbd.return_no
        INNER JOIN st_store st ON st.store_id = orbi.store_id
        INNER JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        WHERE 1 = 1
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND orbd.create_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND orbd.create_time &lt;= #{endTime}
        </if>
        <if test="null != payType and payType != ''">
            AND orbd.return_pay_type = #{payType}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY payTime DESC
    </select>

    <select id="findNotPickGoodsReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.NotPickGoodsReportDO">
        SELECT
        obi.city_name cityName,
        st.store_name storeName,
        st.store_type storeType,
        obi.delivery_type pickType,
        obd.pay_up_time buyTime,
        obi.effective_end_time effectiveTime,
        obi.customer_id customerId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone,
        obi.customer_type customerType,
        obi.sales_consult_name sellerName,
        ogi.sku sku,
        ogi.sku_name skuName,
        ogi.order_qty quantity,
        ogi.retail_price buyPrice,
        (ogi.order_qty * ogi.retail_price) totalBuyPrice,
        obi.ord_no referenceNumber
        FROM ord_billing_details obd
        INNER JOIN ord_base_info obi ON obd.oid = obi.oid
        INNER JOIN st_store st ON st.store_id = obi.store_id
        INNER JOIN ord_goods_info ogi ON obi.oid = ogi.oid
        WHERE obd.is_pay_up = 1 AND ((obi.delivery_type = 'HOUSE_DELIVERY' AND obi.status = 'PENDING_SHIPMENT')
        OR (obi.delivery_type = 'SELF_TAKE' AND obi.status = 'PENDING_RECEIVE'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND obd.pay_up_time &gt; #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND obd.pay_up_time &lt; #{endTime}
        </if>
        <if test="null != pickType and pickType != ''">
            AND obi.delivery_type = #{pickType}
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT
        city.name cityName,
        st.store_name storeName,
        st.store_type storeType,
        'PRODUCT_COUPON' pickType,
        ccpc.get_time buyTime,
        ccpc.effective_end_time effectiveTime,
        c.cus_id customerId,
        c.name customerName,
        c.mobile customerPhone,
        c.customer_type customerType,
        e.name sellerName,
        g.sku sku,
        g.sku_name skuName,
        ccpc.quantity quantity,
        ccpc.buy_price buyPrice,
        (ccpc.quantity * ccpc.buy_price) totalBuyPrice,
        ccpc.use_ord_no referenceNumber
        FROM cus_customer_product_coupon ccpc
        INNER JOIN cus_customer c ON ccpc.cus_id = c.cus_id
        LEFT JOIN emp_employee e ON ccpc.seller_id = e.emp_id
        INNER JOIN st_store st ON st.store_id = ccpc.store_id
        INNER JOIN city ON c.city_id = city.city_id
        INNER JOIN gds_goods g ON ccpc.gid = g.gid
        WHERE ccpc.is_used = 0 AND (ccpc.effective_end_time > now() OR ccpc.effective_end_time IS NULL)
        <if test="null != cityId and cityId != -1">
            AND city.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND st.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ccpc.get_time &gt; #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ccpc.get_time &lt; #{endTime}
        </if>
        <if test="null != pickType and pickType != ''">
            AND 'PRODUCT_COUPON' = #{pickType}
        </if>
        AND c.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY buyTime
    </select>

    <select id="findStorePredepositReportDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.StorePredepositReportDO">
        SELECT
        c.name cityName,
        s.store_name storeName,
        s.store_type storeType,
        pl.create_time changeTime,
        pl.change_type changeType,
        pl.change_money changeMoney,
        pl.balance balance,
        pl.order_number referenceNumber,
        pl.remarks remarks
        FROM st_pre_deposit_log pl
        INNER JOIN st_store s ON pl.store_id = s.store_id
        INNER JOIN city c ON c.city_id = s.city_id
        WHERE TRUE
        <if test="null != cityId and cityId != -1">
            AND city.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND pl.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND s.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND pl.create_time &gt; #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND pl.create_time &lt; #{endTime}
        </if>
        AND pl.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY changeTime DESC
    </select>

    <select id="findAccountGoodsItemsDOAll"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AccountGoodsItemsDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, ol.operation_time
        orderTime, obi.ord_no orderNumber, st.store_type storeTypes,
        null returnNumber, obi.customer_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType, oli.receiver receiver, oli.receiver_phone receiverPhone,
        (CASE WHEN obi.`status` = 'FINISHED' OR obi.`status` = 'CLOSED' OR obi.`status` = 'REJECTED'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'HOUSE_DELIVERY')THEN '已出货'
        WHEN obi.`status` = 'CANCELED' OR obi.`status` = 'CANCELING' OR obi.`status` = 'PENDING_SHIPMENT'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'SELF_TAKE') THEN '未出货' ELSE '未知'
        END)deliveryStatus,
        oli.shipping_address, og.sku sku, og.sku_name skuName, (CASE WHEN og.company_flag = 'HR' THEN '华润'
        WHEN og.company_flag = 'LYZ' THEN '乐意装' WHEN og.company_flag = 'YR' THEN '莹润' ELSE '其他' END)companyFlag,
        og.goods_line_type goodsLineType, IFNULL(og.order_qty, 0) quantity, IFNULL(og.settlement_price, 0)
        settlementPrice,
        (IFNULL(og.order_qty, 0) * IFNULL(og.settlement_price, 0)) settlementTotlePrice,
        IFNULL(og.return_price, 0) promotionSharePrice,(IFNULL(og.order_qty, 0) * IFNULL(og.return_price, 0))
        promotionShareTotlePrice
        FROM
        ord_base_info obi
        INNER JOIN st_store st ON st.store_id = obi.store_id
        LEFT JOIN ord_lifecycle ol ON obi.ord_no = ol.ord_no
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        LEFT JOIN ord_goods_info og ON og.ord_no = oli.ord_no
        WHERE obi.`status` != 'UNPAID'
        AND (ol.post_status = 'PENDING_SHIPMENT' OR (ol.post_status = 'PENDING_RECEIVE' AND obi.delivery_type =
        'SELF_TAKE'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ol.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ol.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, rl.operation_time
        orderTime, obi.ord_no orderNumber, st.store_type storeTypes,
        orbi.return_no returnNumber, orbi.cus_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType, orli.rejecter receiver, orli.rejecter_phone receiverPhone,
        (CASE WHEN orbi.return_type = 'REFUSED_RETURN' OR orbi.return_type = 'NORMAL_RETURN' THEN '已取货'
        WHEN orbi.return_type = 'CANCEL_RETURN' THEN '订单取消' ELSE '未知' END) deliveryStatus,
        orli.return_full_address, org.sku sku, org.sku_name skuName, (CASE WHEN org.company_flag = 'HR' THEN '华润'
        WHEN org.company_flag = 'LYZ' THEN '乐意装' WHEN org.company_flag = 'YR' THEN '莹润' ELSE '其他' END) companyFlag,
        org.goods_line_type goodsLineType, (-1 * IFNULL(org.return_qty,0)) quantity, IFNULL(org.settlement_price, 0)
        settlementPrice,
        (-1 * IFNULL(org.return_qty, 0) * IFNULL(org.settlement_price, 0)) settlementTotlePrice,
        IFNULL(org.return_price, 0) promotionSharePrice, (-1 * IFNULL(org.return_qty, 0) * IFNULL(org.return_price, 0))
        promotionShareTotlePrice
        FROM ord_return_base_info orbi
        LEFT JOIN ord_return_lifecycle rl ON orbi.return_no = rl.return_no
        LEFT JOIN st_store st ON st.store_id = orbi.store_id
        LEFT JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        LEFT JOIN ord_return_logistic_info orli ON orli.return_no = orbi.return_no
        LEFT JOIN ord_return_goods_info org ON org.return_no = orbi.return_no
        WHERE orbi.return_status = 'FINISHED' AND rl.post_status = 'FINISHED'
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND rl.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND rl.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>

    <select id="findBillingItemsDOAll" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.BillingItemsDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, ol.operation_time
        orderTime, obi.ord_no orderNumber,
        null returnNumber, obi.customer_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType,
        (CASE WHEN obi.`status` = 'FINISHED' OR obi.`status` = 'CLOSED' OR obi.`status` = 'REJECTED'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'HOUSE_DELIVERY')THEN '已出货'
        WHEN obi.`status` = 'CANCELED' OR obi.`status` = 'CANCELING' OR obi.`status` = 'PENDING_SHIPMENT'
        OR (obi.`status` = 'PENDING_RECEIVE' AND obi.delivery_type = 'SELF_TAKE') THEN '未出货' ELSE '未知'
        END)deliveryStatus,
        oli.shipping_address, IFNULL(obd.total_goods_price,0) totalGoodsPrice, IFNULL(obd.member_discount,0)
        memberDiscount,
        IFNULL(obd.promotion_discount,0) promotionDiscount, IFNULL(obd.freight,0) freight,
        IFNULL(obd.cash_coupon_discount,0) cashCouponDiscount,
        IFNULL(obd.product_coupon_discount,0) productCouponDiscount, IFNULL(obd.order_amount_subtotal,0)-IFNULL(obd.freight,0) amountPayable,
        (CASE WHEN obd.online_pay_type = 'WE_CHAT' THEN IFNULL(obd.online_pay_amount,0) ELSE 0 END) weChat,
        (CASE WHEN obd.online_pay_type = 'ALIPAY' THEN IFNULL(obd.online_pay_amount,0) ELSE 0 END) alipay,
        (CASE WHEN obd.online_pay_type = 'UNION_PAY' THEN IFNULL(obd.online_pay_amount,0) ELSE 0 END) unionPay,
        IFNULL(obd.store_cash,0) storeCash, IFNULL(obd.store_pos_money,0) storePosMoney, IFNULL(obd.delivery_cash,0)
        deliveryCash, IFNULL(obd.delivery_pos,0) deliveryPos,
        IFNULL(obd.store_other_money,0) storeOtherMoney, IFNULL(obd.st_pre_deposit,0) stPreDeposit,
        IFNULL(obd.cus_pre_deposit,0) cusPreDeposit,
        (IFNULL(obd.online_pay_amount,0) + IFNULL(obd.store_cash,0) + IFNULL(obd.store_pos_money,0)
        + IFNULL(obd.delivery_cash,0) + IFNULL(obd.delivery_pos,0) + IFNULL(obd.store_other_money,0)
        + IFNULL(obd.st_pre_deposit,0) + IFNULL(obd.cus_pre_deposit,0)) totalPay
        FROM
        ord_base_info obi
        INNER JOIN st_store st ON st.store_id = obi.store_id
        LEFT JOIN ord_lifecycle ol ON obi.ord_no = ol.ord_no
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        LEFT JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        WHERE obi.`status` != 'UNPAID'
        AND (ol.post_status = 'PENDING_SHIPMENT' OR (ol.post_status = 'PENDING_RECEIVE' AND obi.delivery_type =
        'SELF_TAKE'))
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND ol.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND ol.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        UNION
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, rl.operation_time
        orderTime, obi.ord_no orderNumber,
        orbi.return_no returnNumber, orbi.cus_name customerName, obi.sales_consult_name sellerName, obi.delivery_type
        deliveryType,
        (CASE WHEN orbi.return_type = 'REFUSED_RETURN' OR orbi.return_type = 'NORMAL_RETURN' THEN '已取货'
        WHEN orbi.return_type = 'CANCEL_RETURN' THEN '订单取消' ELSE '未知' END) deliveryStatus,
        orli.return_full_address, (CASE WHEN orbi.return_type = 'CANCEL_RETURN' THEN (-1 * IFNULL(obd.total_goods_price,0)) ELSE (-1 * IFNULL(orbi.return_price,0)) END) totalGoodsPrice,
        (CASE WHEN orbi.return_type = 'CANCEL_RETURN' THEN IFNULL(obd.member_discount,0) ELSE 0 END) memberDiscount,
        0 promotionDiscount, 0 freight, 0 cashCouponDiscount,
        0 productCouponDiscount, (-1 * IFNULL(orbi.return_price,0)) amountPayable,
        (CASE WHEN orb.online_pay_type = 'WE_CHAT' THEN (-1 * IFNULL(orb.online_pay,0)) ELSE 0 END) weChat,
        (CASE WHEN orb.online_pay_type = 'ALIPAY' THEN (-1 * IFNULL(orb.online_pay,0)) ELSE 0 END) alipay,
        (CASE WHEN orb.online_pay_type = 'UNION_PAY' THEN (-1 * IFNULL(orb.online_pay,0)) ELSE 0 END) unionPay,
        (-1 * IFNULL(orb.cash,0)) storeCash, 0, 0 deliveryCash, 0 deliveryPos,
        0 storeOtherMoney, (-1 * IFNULL(orb.st_pre_deposit,0)) stPreDeposit, (-1 * IFNULL(orb.pre_deposit,0))
        cusPreDeposit,
        (-1 * (IFNULL(orb.online_pay,0) + IFNULL(orb.cash,0) + IFNULL(orb.st_pre_deposit,0) +
        IFNULL(orb.pre_deposit,0))) totalPay
        FROM ord_return_base_info orbi
        LEFT JOIN ord_return_lifecycle rl ON orbi.return_no = rl.return_no
        LEFT JOIN st_store st ON st.store_id = orbi.store_id
        LEFT JOIN ord_base_info obi ON obi.ord_no = orbi.ord_no
        LEFT JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        LEFT JOIN ord_return_logistic_info orli ON orli.return_no = orbi.return_no
        LEFT JOIN ord_return_billing orb ON orb.return_no = orbi.return_no
        WHERE orbi.return_status = 'FINISHED' AND rl.post_status = 'FINISHED'
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND orbi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND rl.operation_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND rl.operation_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND orbi.return_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>

    <select id="findAgencyFundDOAll" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AgencyFundDO">
        SELECT DISTINCT obi.city_name cityName, st.store_name storeName, st.store_type storeType, od.create_time
        orderTime,
        obi.ord_no orderNumber, w.wh_name warehouse, obi.sales_consult_name sellerName,
        oli.shipping_address, oli.delivery_clerk_name deliveryName, IFNULL(obd.collection_amount,0) agencyMoney,
        IFNULL(oaf.cash_money,0) + IFNULL(obd.delivery_cash,0) cashMoney, IFNULL(oaf.pos_money,0) +
        IFNULL(obd.delivery_pos,0) posMoney,
        oaf.remarks remarks, IFNULL(oaf.return_money,0) returnMoney, IFNULL(obd.delivery_cash,0) +
        IFNULL(obd.delivery_pos,0) realMoney, obi.remark orderRemark
        FROM
        ord_agency_fund oaf
        INNER JOIN ord_base_info obi ON obi.ord_no = oaf.ord_no
        INNER JOIN st_store st ON st.store_id = obi.store_id
        LEFT JOIN ord_delivery_info_details od ON od.order_no = obi.ord_no AND od.logistic_status = 'SEALED_CAR'
        LEFT JOIN ord_logistics_info oli ON oli.ord_no = obi.ord_no
        LEFT JOIN ord_billing_details obd ON obd.ord_no = obi.ord_no
        LEFT JOIN warehouse w ON w.wh_no = oli.warehouse
        WHERE 1=1
        <if test="null != cityId and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="null != storeId and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="null != storeType and storeType != ''">
            AND st.store_type = #{storeType}
        </if>
        <if test="null != startTime and startTime != ''">
            AND od.create_time &gt;= #{startTime}
        </if>
        <if test="null != endTime and endTime != ''">
            AND od.create_time &lt;= #{endTime}
        </if>
        <if test="null != keywords and keywords != ''">
            AND obi.ord_no LIKE concat(concat('%',#{keywords}),'%')
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY orderTime DESC
    </select>


    <select id="findStoreInventorys" resultType="cn.com.leyizhuang.app.foundation.pojo.inventory.StoreInventory">
        select
        store_name,
        sku_name,
        sku,
        available_ity,
        real_ity
        from st_inventory
        where
        1=1
        <if test="null !=storeId">
            AND
            store_id =#{storeId}
        </if>
        AND store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        real_ity
        DESC
    </select>


    <select id="queryGoodsShipmentAndReturnOrder"
            resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.ShipmentAndReturnGoods">
        select
        DISTINCT
        ss.city as cityName,
        ss.store_name as storeName ,
        ss.store_type as storeType,
        orbi.ord_no as ordNo,
        orbi.order_time as createTime,
        orbi.store_id as store_id,
        obi.customer_id as customerId,
        obi.customer_phone as customerPhone,
        obi.customer_name as customerName,
        obi.customer_type as customerType,
        obi.sales_consult_name as salesConsultName,
        orgi.company_flag as companyFlag,
        orgi.sku as sku,
        orgi.sku_name as skuName,
        orgi.goods_line_type as goodsLineType,
        orgi.return_qty as orderQty,
        orgi.return_price as returnPrice,
        ordd.create_time as operationTime,
        orpc.purchase_price as purchasePrice
        from ord_return_base_info orbi
        LEFT JOIN ord_return_goods_info orgi ON orgi.return_no =orbi.return_no
        LEFT JOIN ord_base_info obi ON orbi.ord_no=obi.ord_no
        LEFT JOIN ord_return_delivery_detail ordd ON orbi.return_no = ordd.return_no
        LEFT JOIN st_store ss ON orbi.store_id = ss.store_id
        LEFT JOIN ord_return_logistic_info orli on orli.return_no = orbi.return_no
        LEFT JOIN  ord_return_product_coupon orpc on orbi.return_no =orpc.return_no
        where
        orli.delivery_type='HOUSE_PICK'
        AND
        ordd.return_logistic_status='AGAIN_ON_SALE'
        <if test="null !=storeId">
            AND
            orbi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            ss.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime">
            AND
            ordd.create_time >= #{startTime}
        </if>
        <if test="null !=endTime  and ''!=endTime">
            AND
            <![CDATA[ordd.create_time<= #{endTime}]]>
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION
        select
        DISTINCT
        ss.city as cityName,
        ss.store_name as storeName,
        ss.store_type as storeType,
        orbi.ord_no as ordNo,
        orbi.store_id as store_id,
        orl.operation_time as operationTime,
        orbi.order_time as createTime,
        orbi.cus_id as customerId,
        orbi.cus_phone as customerPhone,
        orbi.cus_name as customerName,
        orbi.cus_type as customerType,
        obi.sales_consult_name as salesConsultName,
        orgi.company_flag as companyFlag,
        orgi.sku as sku,
        orgi.sku_name as skuName,
        orgi.goods_line_type as goodsLineType,
        orgi.return_qty as orderQty,
        orgi.return_price as returnPrice,
        orpc.purchase_price as purchasePrice
        from ord_return_base_info orbi
        LEFT JOIN ord_return_goods_info orgi ON orgi.return_no =orbi.return_no
        LEFT JOIN ord_base_info obi ON orbi.ord_no=obi.ord_no
        LEFT JOIN st_store ss ON orbi.store_id = ss.store_id
        LEFT JOIN ord_return_lifecycle orl ON orbi.return_no = orl.return_no
        LEFT JOIN ord_return_logistic_info orli on orli.return_no = orbi.return_no
        LEFT JOIN  ord_return_product_coupon orpc on orbi.return_no =orpc.return_no
        where
        orli.delivery_type='RETURN_STORE'
        AND
        orbi.return_status ='FINISHED'
        AND
        orl.post_status = 'FINISHED'
        <if test="null !=storeId">
            AND
            orbi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            ss.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime">
            AND
            orl.operation_time >= #{startTime}
        </if>
        <if test="null !=endTime  and ''!=endTime">
            AND
            <![CDATA[orl.operation_time<= #{endTime}]]>
        </if>
        AND orbi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION
        select
        DISTINCT
        obi.city_name as cityName,
        obi.store_id as store_id,
        ss.store_name as storeName,
        ss.store_type as storeType,
        obi.ord_no as ordNo,
        odid.create_time as operationTime,
        obi.create_time as createTime,
        obi.customer_id as customerId,
        obi.customer_phone as customerPhone,
        obi.customer_name as customerName,
        obi.customer_type as customerType,
        obi.sales_consult_name as salesConsultName,
        ogi.company_flag as companyFlag,
        ogi.sku as sku,
        ogi.sku_name as skuName,
        ogi.goods_line_type as goodsLineType,
        ogi.order_qty as orderQty,
        ogi.return_price as returnPrice,
        oci.purchase_price as purchasePrice
        from ord_base_info obi
        LEFT JOIN ord_goods_info ogi ON obi.ord_no =ogi.ord_no
        LEFT JOIN ord_delivery_info_details odid ON obi.ord_no = odid.order_no
        LEFT JOIN st_store ss ON obi.store_id = ss.store_id
        LEFT JOIN ord_coupon_info oci ON obi.ord_no= oci.ord_no
        where
        obi.delivery_type ='HOUSE_DELIVERY'
        AND
        odid.logistic_status='SEALED_CAR'
        <if test="null !=storeId">
            AND
            obi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            obi.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime">
            AND
            odid.create_time >= #{startTime}
        </if>
        <if test="null !=endTime  and ''!=endTime">
            AND
            <![CDATA[odid.create_time<= #{endTime}]]>
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        UNION

        select
        DISTINCT
        obi.city_name as cityName,
        obi.store_id as store_id,
        ss.store_name as storeName,
        ss.store_type as storeType,
        obi.ord_no as ordNo,
        ol.operation_time as operationTime,
        obi.create_time as createTime,
        obi.customer_id as customerId,
        obi.customer_phone as customerPhone,
        obi.customer_name as customerName ,
        obi.customer_type as customerType,
        obi.sales_consult_name as salesConsultName,
        ogi.company_flag as companyFlag,
        ogi.sku as sku,
        ogi.sku_name as skuName,
        ogi.goods_line_type as goodsLineType,
        ogi.order_qty as orderQty,
        ogi.return_price as returnPrice,
        oci.purchase_price as purchasePrice
        from ord_base_info obi
        LEFT JOIN ord_goods_info ogi ON ogi.ord_no =obi.ord_no
        LEFT JOIN st_store ss ON obi.store_id = ss.store_id
        LEFT JOIN ord_lifecycle ol ON obi.ord_no = ol.ord_no
        LEFT JOIN ord_coupon_info oci ON obi.ord_no= oci.ord_no
        where
        obi.delivery_type ='SELF_TAKE'
        AND
        obi.status ='FINISHED'
        AND
        ol.post_status = 'FINISHED'
        <if test="null !=storeId">
            AND
            obi.store_id =#{storeId}
        </if>
        <if test="null !=cityId">
            AND
            obi.city_id =#{cityId}
        </if>
        <if test="null !=storeType and ''!=storeType">
            AND
            ss.store_type =#{storeType}
        </if>
        <if test="null !=startTime  and ''!=startTime ">
            AND
            ol.operation_time >= #{startTime}
        </if>
        <if test="null !=endTime and ''!=endTime">
            AND
            <![CDATA[ol.operation_time<= #{endTime} ]]>
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="getJxPriceByOrderNoAndSku" resultType="cn.com.leyizhuang.app.foundation.pojo.reportDownload.AccountGoodsItemsDO">
        SELECT
          IFNULL(unit_price, 0) wholesalePrice, IFNULL(unit_price, 0) * IFNULL(quantity, 0) wholesaleTotlePrice
        FROM
          ord_jx_price_difference_return_details
        WHERE ord_no = #{orderNumber} AND sku = #{sku}
          GROUP BY sku
        UNION
        SELECT
          IFNULL(unit_price, 0) wholesalePrice, IFNULL(unit_price, 0) * IFNULL(return_qty, 0) wholesaleTotlePrice
        FROM
          ord_return_jx_price_difference_return_details
        WHERE return_no = #{orderNumber} AND sku = #{sku}
          GROUP BY sku
    </select>


</mapper>