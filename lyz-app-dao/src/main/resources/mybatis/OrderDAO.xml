<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.OrderDAO">

    <sql id="All_FIELD">
        oid id, ord_no orderNumber, order_type, create_time, effective_end_time, status, delivery_status, pick_up_code,
        delivery_type,
        order_subject_type, creator_identity_type, creator_id, creator_name, creator_phone, store_id, store_code,
        store_structure_code, sales_consult_id, sales_consult_name, sales_consult_phone, customer_id, customer_name,
        customer_phone, customer_type, total_goods_price, is_evaluated, audit_no, remark, city_id, city_name
    </sql>

    <resultMap id="orderBeseInfoList" type="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        <result column="ord_no" property="orderNumber" jdbcType="VARCHAR"/>
        <result column="status" property="status" javaType="cn.com.leyizhuang.app.core.constant.AppOrderStatus"/>
        <result column="effective_end_time" property="effectiveEndTime" jdbcType="TIMESTAMP"/>
        <result column="delivery_type" property="deliveryType"
                javaType="cn.com.leyizhuang.app.core.constant.AppDeliveryType"/>
        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="customer_phone" property="customerPhone" jdbcType="VARCHAR"/>
    </resultMap>

    <select id="getGoodsInfoByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.MaterialListDO">
        SELECT DISTINCT
            g.gid,
            g.sku,
            g.sku_name,
            g.goods_specification,
            g.cover_image_uri,
            g.goods_unit,
            og.order_qty qty
        FROM ord_goods_info og
            LEFT JOIN gds_goods g ON g.sku = og.sku
        WHERE og.ord_no = #{orderNumber}
              AND (og.goods_line_type != 'PRESENT')
    </select>

    <select id="getOrderListByUserIDAndIdentityType" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.customer_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` = 'PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.creator_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` = 'PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info AS obi
            WHERE
            obi.sales_consult_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` = 'PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            ORDER BY obi.create_time DESC
        </if>
    </select>

    <select id="getFuzzyQuery" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.customer_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%'))
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.creator_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%'))
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.sales_consult_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%'))
        </if>
    </select>

    <select id="getOrderGoodsInfoByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
            id               id,
            oid              oid,
            ord_no           orderNumber,
            gid              gid,
            sku              sku,
            sku_name         skuName,
            retail_price     retailPrice,
            VIP_price        VIPPrice,
            wholesale_price  wholesalePrice,
            settlement_price settlementPrice,
            promotion_id     promotionId,
            is_price_share   isPriceShare,
            share_price      sharePrice,
            return_price     returnPrice,
            is_returnable    isReturnable,
            return_priority  returnPriority,
            order_qty        orderQuantity,
            shipping_qty    shippingQuantity,
            return_qty      returnQuantity,
            returnable_qty  returnableQuantity,
            goods_line_type goods_line_type,
            price_item_id   priceItemId,
            company_flag    companyFlag
        FROM
            ord_goods_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getAmountPayableByOrderNumber" resultType="java.lang.Double">
        SELECT amount_payable
        FROM
            ord_billing_details
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="querySumQtyByOrderNumber" resultType="java.lang.Integer">
        SELECT sum(order_qty)
        FROM ord_goods_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="findByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
        <include refid="All_FIELD"/>
        FROM
        ord_base_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getOrderDetail" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT *
        FROM
            ord_base_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getOrderLogistice" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLogisticsInfo">
        SELECT *
        FROM
            ord_logistics_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getOrderBillingDetail" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        SELECT
            create_time,
            oid,
            ord_no          order_number,
            total_goods_price,
            member_discount,
            promotion_discount,
            freight,
            upstairs_fee,
            lebi_quantity,
            lebi_cash_discount,
            cash_coupon_discount,
            product_coupon_discount,
            cus_pre_deposit,
            online_pay_type,
            online_pay_amount,
            online_pay_time,
            st_pre_deposit,
            emp_credit_money,
            st_credit_money store_credit_money,
            st_subvention   store_subvention,
            order_amount_subtotal,
            amount_payable,
            collection_amount,
            arrearage,
            is_owner_receiving,
            is_pay_up,
            pay_up_time
        FROM
            ord_billing_details
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getOrderBillingDetailListByOrderNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        SELECT
            id,
            oid    orderId,
            ord_no orderNumber,
            creatr_time,
            pay_time,
            pay_type,
            amount,
            reply_code,
            receipt_number
        FROM
            ord_billing_payment_details
        WHERE
            ord_no = #{orderNo}
    </select>

    <select id="getOrderGoodsDetails" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GiftListResponseGoods">
        SELECT
            ogi.order_qty       qty,
            ogi.retail_price,
            ogi.goods_line_type goods_type,
            gg.sku_name,
            gg.gid              goodsId,
            gg.goods_specification,
            gg.cover_image_uri,
            gg.goods_unit
        FROM
            ord_goods_info AS ogi
            INNER JOIN gds_goods AS gg ON ogi.sku = gg.sku
        WHERE
            ogi.ord_no = #{orderNumber}
    </select>

    <select id="getOrderGoodsList" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.OrderGoodsListResponse">
        SELECT
        ogi.order_qty       qty,
        ogi.retail_price,
        ogi.goods_line_type goods_type,
        gg.sku_name,
        gg.gid              goodsId,
        gg.goods_specification,
        gg.cover_image_uri,
            gg.goods_unit,
        ogi.is_evaluation
        FROM
        ord_goods_info AS ogi
        INNER JOIN gds_goods AS gg ON ogi.sku = gg.sku
        WHERE
        ogi.ord_no = #{orderNumber}
    </select>

    <select id="getOrderInfoByOrderNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderTempInfo">
        SELECT
            ob.ord_no              orderNo,
            ob.pick_up_code        pickUpCode,
            ob.status              orderStatus,
            ob.delivery_type       deliveryType,
            od.collection_amount   collectionAmount,
            od.arrearage           ownMoney,
            ob.customer_name       customerName,
            ob.customer_phone      customerPhone,
            ob.sales_consult_name  sellerName,
            ob.sales_consult_phone sellerPhone,
            ol.shipping_address    shippingAddress,
            ob.oid                 orderId,
            ol.delivery_clerk_no   operatorNo,
            ob.sales_consult_id    sellerId
        FROM ord_base_info ob
            LEFT JOIN ord_billing_details od ON od.ord_no = ob.ord_no
            LEFT JOIN ord_logistics_info ol ON ol.ord_no = ob.ord_no
        WHERE ob.ord_no = #{orderNo}

    </select>

    <insert id="savePaymentDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        INSERT INTO ord_billing_payment_details
        (oid, ord_no, creatr_time, pay_time, pay_type, amount, reply_code, receipt_number)
        VALUES
            (#{orderId}, #{orderNumber}, #{createTime}, #{payTime}, #{payType}, #{amount}, #{replyCode},
             #{receiptNumber})
    </insert>

    <update id="updateOwnMoneyByOrderNo"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        UPDATE ord_billing_details
        <set>
            <if test="null != arrearage">
                arrearage = #{arrearage},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

    <update id="updateOrderStatusByOrderNo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        UPDATE ord_base_info
        <set>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != deliveryStatus">
                delivery_status = #{deliveryStatus},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

    <insert id="saveOrderBaseInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ord_base_info
        (ord_no, order_type, create_time, effective_end_time, status, delivery_status, pick_up_code,
         delivery_type, order_subject_type, creator_identity_type, creator_id, creator_name, creator_phone,
         store_id, store_code, store_structure_code, sales_consult_id, sales_consult_name, sales_consult_phone,
         customer_id, customer_name, customer_phone, total_goods_price, is_evaluated, audit_no,
         remark,city_id,city_name
        )
        VALUES
            (
                #{orderNumber}, #{orderType}, #{createTime}, #{effectiveEndTime}, #{status}, #{deliveryStatus},
                                #{pickUpCode}, #{deliveryType}, #{orderSubjectType}, #{creatorIdentityType},
                                #{creatorId},
                #{creatorName},
                #{creatorPhone}, #{storeId}, #{storeCode}, #{storeStructureCode}, #{salesConsultId},
                #{salesConsultName},
                #{salesConsultPhone}, #{customerId}, #{customerName}, #{customerPhone}, #{totalGoodsPrice},
                #{isEvaluated}, #{auditNo}, #{remark}, #{cityId}, #{cityName}
            )
    </insert>

    <insert id="saveOrderLogisticsInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLogisticsInfo">
        INSERT INTO ord_logistics_info (oid, ord_no, delivery_type, booking_store_code, booking_store_name, booking_store_address, delivery_time,
                                        delivery_clerk_no, delivery_clerk_id, delivery_clerk_name, warehouse, is_owner_receiving, receiver,
                                        receiver_phone, shipping_address, residence_name, delivery_city, delivery_county, delivery_street,
                                        detailed_address)
        VALUES (#{oid}, #{ordNo}, #{deliveryType}, #{bookingStoreCode}, #{bookingStoreName},
                        #{bookingStoreAddress}, #{deliveryTime}, #{deliveryClerkNo}, #{deliveryClerkId},
                        #{deliveryClerkName}, #{warehouse}, #{isOwnerReceiving},
                #{receiver}, #{receiverPhone}, #{shippingAddress}, #{residenceName}, #{deliveryCity}, #{deliveryCounty},
                #{deliveryStreet}, #{detailedAddress})
    </insert>
    <insert id="saveOrderGoodsInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ord_goods_info
        (
            oid, ord_no, goods_line_type, gid, sku, sku_name, retail_price, VIP_price, wholesale_price, promotion_id,
            is_price_share, share_price, return_price, is_returnable, return_priority, order_qty, shipping_qty,
            return_qty, returnable_qty, settlement_price, price_item_id, company_flag
        )
        VALUES (#{oid}, #{orderNumber}, #{goodsLineType}, #{gid}, #{sku}, #{skuName}, #{retailPrice}, #{VIPPrice},
                        #{wholesalePrice}, #{promotionId},
                        #{isPriceShare}, #{sharePrice},
            #{returnPrice}, #{isReturnable}, #{returnPriority}, #{orderQuantity}, #{shippingQuantity},
            #{returnQuantity}, #{returnableQuantity}, #{settlementPrice},
            #{priceItemId}, #{companyFlag})

    </insert>

    <insert id="saveOrderBillingDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        INSERT INTO ord_billing_details (create_time, oid, ord_no, total_goods_price, member_discount, promotion_discount, freight, upstairs_fee,
                                         lebi_quantity, lebi_cash_discount, cash_coupon_discount, product_coupon_discount, cus_pre_deposit,
                                         online_pay_type, online_pay_amount, st_pre_deposit, emp_credit_money, st_credit_money,
                                         st_subvention, order_amount_subtotal, amount_payable, collection_amount, arrearage, is_owner_receiving,
                                         online_pay_time, pay_up_time, is_pay_up)
        VALUES
            (#{createTime}, #{oid}, #{orderNumber}, #{totalGoodsPrice}, #{memberDiscount}, #{promotionDiscount},
                            #{freight},
                            #{upstairsFee}, #{lebiQuantity}, #{lebiCashDiscount}, #{cashCouponDiscount},
                #{productCouponDiscount}, #{cusPreDeposit},
                #{onlinePayType}, #{onlinePayAmount}, #{stPreDeposit}, #{empCreditMoney}, #{storeCreditMoney},
                #{storeSubvention}, #{orderAmountSubtotal},
                #{amountPayable}, #{collectionAmount}, #{arrearage}, #{isOwnerReceiving}, #{onlinePayTime},
             #{payUpTime}, #{isPayUp}
            )
    </insert>

    <insert id="saveOrderBillingPaymentDetail"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        INSERT INTO ord_billing_payment_details (oid, ord_no, creatr_time, pay_time, pay_type, amount, reply_code, receipt_number)
        VALUES (#{orderId}, #{orderNumber}, #{createTime}, #{payTime}, #{payType}, #{amount}, #{replyCode},
                #{receiptNumber})
    </insert>

    <update id="updateOrderBaseInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        UPDATE ord_base_info
        <set>
            <if test="null != status ">
                status = #{status},
            </if>
            <if test="null != deliveryStatus ">
                delivery_status = #{deliveryStatus},
            </if>
            <if test="null != pickUpCode ">
                pick_up_code = #{pickUpCode},
            </if>
            <if test="null != isEvaluated ">
                is_evaluated = #{isEvaluated}
            </if>
        </set>
    </update>

    <update id="updateOrderBillingDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        UPDATE ord_billing_details
        <set>
            <if test="null != onlinePayType ">
                online_pay_type = #{onlinePayType},
            </if>
            <if test="null != onlinePayAmount ">
                online_pay_amount = #{onlinePayAmount},
            </if>
            <if test="null != arrearage ">
                arrearage = #{arrearage},
            </if>
            <if test="null != onlinePayType ">
                online_pay_type = #{onlinePayType},
            </if>
            <if test="null != payUpTime  ">
                pay_up_time = #{payUpTime},
            </if>
            <if test="null != isPayUp  ">
                is_pay_up = #{isPayUp}
            </if>
        </set>
    </update>


    <update id="updateOrderStatusAndDeliveryStatusByOrderNo">
        UPDATE ord_base_info
        <set>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != deliveryStatus">
                delivery_status = #{deliveryStatus}
            </if>
        </set>
        WHERE ord_no = #{orderNumber}

    </update>

    <update id="updateOrderGoodsInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo" >
        update ord_goods_info
        <set >
            <if test="oid != null" >
                oid = #{oid,jdbcType=BIGINT},
            </if>
            <if test="orderNumber != null" >
                ord_no = #{orderNumber,jdbcType=VARCHAR},
            </if>
            <if test="sku != null" >
                sku = #{sku,jdbcType=VARCHAR},
            </if>
            <if test="skuName != null" >
                sku_name = #{skuName,jdbcType=VARCHAR},
            </if>
            <if test="retailPrice != null" >
                retail_price = #{retailPrice,jdbcType=DECIMAL},
            </if>
            <if test="VIPPrice != null" >
                VIP_price = #{VIPPrice,jdbcType=DECIMAL},
            </if>
            <if test="wholesalePrice != null" >
                wholesale_price = #{wholesalePrice,jdbcType=DECIMAL},
            </if>
            <if test="promotionId != null" >
                promotion_id = #{promotionId,jdbcType=BIGINT},
            </if>
            <if test="isPriceShare != null" >
                is_price_share = #{isPriceShare,jdbcType=BIT},
            </if>
            <if test="sharePrice != null" >
                share_price = #{sharePrice,jdbcType=DECIMAL},
            </if>
            <if test="returnPrice != null" >
                return_price = #{returnPrice,jdbcType=DECIMAL},
            </if>
            <if test="isReturnable != null" >
                is_returnable = #{isReturnable,jdbcType=BIT},
            </if>
            <if test="returnPriority != null" >
                return_priority = #{returnPriority,jdbcType=INTEGER},
            </if>
            <if test="orderQuantity != null" >
                order_qty = #{orderQuantity,jdbcType=INTEGER},
            </if>
            <if test="shippingQuantity != null" >
                shipping_qty = #{shippingQuantity,jdbcType=INTEGER},
            </if>
            <if test="returnQuantity != null" >
                return_qty = #{returnQuantity,jdbcType=INTEGER},
            </if>
            <if test="returnableQuantity != null" >
                returnable_qty = #{returnableQuantity,jdbcType=INTEGER},
            </if>
            <if test="goodsLineType != null" >
                goods_line_type = #{goodsLineType,jdbcType=VARCHAR},
            </if>
            <if test="priceItemId != null" >
                price_item_id = #{priceItemId,jdbcType=BIGINT},
            </if>
            <if test="companyFlag != null" >
                company_flag = #{companyFlag,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <delete id="deleteOrderGoodsInfo" parameterType="java.lang.Long">
        DELETE FROM ord_goods_info
        WHERE ID = #{id}
    </delete>

    <select id="getOrderArrearageInfo" parameterType="java.lang.String" resultType="cn.com.leyizhuang.app.foundation.pojo.response.OrderArrearageInfoResponse">
        SELECT IFNULL(collection_amount, 0.00) arrearageMoney FROM ord_billing_details WHERE ord_no = #{orderNo}
    </select>

</mapper>