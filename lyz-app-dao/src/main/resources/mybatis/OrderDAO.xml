<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.OrderDAO">

    <sql id="All_FIELD">
        oid id, ord_no orderNumber, order_type, create_time, effective_end_time, status, delivery_status, pick_up_code,
        delivery_type,
        order_subject_type, creator_identity_type, creator_id, creator_name, creator_phone, store_id, store_code,
        store_structure_code, sales_consult_id, sales_consult_name, sales_consult_phone, customer_id, customer_name,
        customer_phone, customer_type, total_goods_price, is_evaluated, audit_no, remark, city_id, city_name, store_org_id,
        sob_id
    </sql>

    <resultMap id="orderBeseInfoList" type="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        <result column="ord_no" property="orderNumber" jdbcType="VARCHAR"/>
        <result column="status" property="status" javaType="cn.com.leyizhuang.app.core.constant.AppOrderStatus"/>
        <result column="effective_end_time" property="effectiveEndTime" jdbcType="TIMESTAMP"/>
        <result column="delivery_type" property="deliveryType"
                javaType="cn.com.leyizhuang.app.core.constant.AppDeliveryType"/>
        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="customer_phone" property="customerPhone" jdbcType="VARCHAR"/>
    </resultMap>

    <select id="getGoodsInfoByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.MaterialListDO">
        SELECT DISTINCT
            g.gid,
            g.sku,
            g.sku_name,
            g.goods_specification,
            g.cover_image_uri,
            g.goods_unit,
            SUM(og.order_qty) qty
        FROM ord_goods_info og
            LEFT JOIN gds_goods g ON g.sku = og.sku
        WHERE og.ord_no = #{orderNumber}
              AND (og.goods_line_type != 'PRESENT')
        GROUP BY g.sku
    </select>

    <select id="getOrderListByUserIDAndIdentityType" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.customer_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
                AND obi.effective_end_time > NOW()
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` ='PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
                AND <![CDATA[obi.create_time >= DATE_ADD(NOW(),INTERVAL -6 MONTH )]]>
            </if>
            <if test="null != showStatus and showStatus == 6">
                AND obi.`status` = 'PENDING_SHIPMENT'
            </if>
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.creator_id = #{userID}
            AND creator_identity_type != 'CUSTOMER'
            AND creator_identity_type != 'SELLER'
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
                AND obi.effective_end_time > NOW()
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` ='PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            <if test="null != showStatus and showStatus == 6">
                AND obi.`status` = 'PENDING_SHIPMENT'
            </if>
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info AS obi
            WHERE
            obi.creator_id = #{userID}
            AND creator_identity_type != 'CUSTOMER'
            AND creator_identity_type != 'DECORATE_MANAGER'
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
                AND obi.effective_end_time > NOW()
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` ='PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            <if test="null != showStatus and showStatus == 6">
                AND obi.`status` = 'PENDING_SHIPMENT'
            </if>
            ORDER BY obi.create_time DESC
        </if>
    </select>

    <select id="getFuzzyQuery" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info AS obi
            LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.customer_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%')
            OR obi.customer_name LIKE concat(concat('%',#{condition}),'%') OR obi.customer_phone LIKE concat(concat('%',#{condition}),'%')
            OR oli.receiver_phone LIKE concat(concat('%',#{condition}),'%'))
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            <choose>
                <when test="sellerType !=null and sellerType == 'SUPERVISOR'">
                    obi.store_id = #{storeId}
                </when>
                <otherwise>
                    obi.creator_id = #{userID}
                </otherwise>
            </choose>

            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%')
            OR obi.customer_name LIKE concat(concat('%',#{condition}),'%') OR obi.customer_phone LIKE concat(concat('%',#{condition}),'%')
            OR oli.receiver_phone LIKE concat(concat('%',#{condition}),'%'))
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.sales_consult_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%')
            OR obi.customer_name LIKE concat(concat('%',#{condition}),'%') OR obi.customer_phone LIKE concat(concat('%',#{condition}),'%')
            OR oli.receiver_phone LIKE concat(concat('%',#{condition}),'%'))
        </if>
    </select>

    <select id="getOrderGoodsInfoByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
            id                      id,
            oid                     oid,
            ord_no                  orderNumber,
            gid                     gid,
            sku                     sku,
            sku_name                skuName,
            retail_price            retailPrice,
            VIP_price               VIPPrice,
            wholesale_price         wholesalePrice,
            settlement_price        settlementPrice,
            promotion_id            promotionId,
            is_price_share          isPriceShare,
            promotion_share_price   promotionSharePrice,
            lb_share_price          lbSharePrice,
            cash_coupon_share_price cashCouponSharePrice,
            cash_return_share_price cashReturnSharePrice,
            return_price            returnPrice,
            is_returnable           isReturnable,
            return_priority         returnPriority,
            order_qty               orderQuantity,
            shipping_qty            shippingQuantity,
            return_qty              returnQuantity,
            returnable_qty          returnableQuantity,
            goods_line_type         goods_line_type,
            price_item_id           priceItemId,
            company_flag            companyFlag,
            cover_image_uri         coverImageUri
        FROM
            ord_goods_info
        WHERE
            ord_no = #{orderNumber}
    </select>


    <select id="getOrderGoodsInfoById" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
            id                      id,
            oid                     oid,
            ord_no                  orderNumber,
            gid                     gid,
            sku                     sku,
            sku_name                skuName,
            retail_price            retailPrice,
            VIP_price               VIPPrice,
            wholesale_price         wholesalePrice,
            settlement_price        settlementPrice,
            promotion_id            promotionId,
            is_price_share          isPriceShare,
            promotion_share_price   promotionSharePrice,
            lb_share_price          lbSharePrice,
            cash_coupon_share_price cashCouponSharePrice,
            cash_return_share_price cashReturnSharePrice,
            return_price            returnPrice,
            is_returnable           isReturnable,
            return_priority         returnPriority,
            order_qty               orderQuantity,
            shipping_qty            shippingQuantity,
            return_qty              returnQuantity,
            returnable_qty          returnableQuantity,
            goods_line_type         goods_line_type,
            price_item_id           priceItemId,
            company_flag            companyFlag
        FROM
            ord_goods_info
        WHERE
            id = #{id}
    </select>

    <select id="getAmountPayableByOrderNumber" resultType="java.lang.Double">
        SELECT amount_payable
        FROM
            ord_billing_details
        WHERE
            ord_no = #{orderNumber}
    </select>


    <select id="getTotalGoodsPriceByOrderNumber" resultType="java.lang.Double">
        SELECT total_goods_price
        FROM
            ord_billing_details
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="querySumQtyByOrderNumber" resultType="java.lang.Integer">
        SELECT sum(order_qty)
        FROM ord_goods_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="findByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
        <include refid="All_FIELD"/>
        FROM
        ord_base_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="findErrorOrderData" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
            ob.oid    id,
            ob.ord_no order_number,
            ob.order_type,
            ob.create_time,
            ob.effective_end_time,
            ob.status,
            ob.delivery_status,
            ob.pick_up_code,
            ob.delivery_type,
            ob.order_subject_type,
            ob.creator_identity_type,
            ob.creator_id,
            ob.creator_name,
            ob.creator_phone,
            ob.store_id,
            ob.store_code,
            ob.store_structure_code,
            ob.sales_consult_id,
            ob.sales_consult_name,
            ob.sales_consult_phone,
            ob.customer_id,
           ob.customer_name,
            ob.customer_phone,
            ob.customer_type,
            ob.total_goods_price,
            ob.is_evaluated,
            ob.audit_no,
            ob.remark,
            ob.city_id,
            ob.city_name,
            ob.sob_id,
            ob.store_org_id,
            ob.sales_number
         from
        ord_goods_info og LEFT JOIN ord_base_info ob on og.oid = ob.oid where
        settlement_price > retail_price and settlement_price > VIP_price
        GROUP BY og.ord_no
    </select>

    <select id="findOrderPromotionId" resultType="java.lang.Long">
        SELECT DISTINCT promotion_id from ord_goods_info where ord_no = #{ordNo};
    </select>

    <select id="findOrderGoodsInfByLineId" resultType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderGoodsInf">
        SELECT  * from inter_ate_order_goods_inf where main_order_line_id = #{lineId}
    </select>

    <select id="findOrderGoodsAndPresentLine" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
            id                      id,
            oid                     oid,
            ord_no                  orderNumber,
            gid                     gid,
            sku                     sku,
            sku_name                skuName,
            retail_price            retailPrice,
            VIP_price               VIPPrice,
            wholesale_price         wholesalePrice,
            settlement_price        settlementPrice,
            promotion_id            promotionId,
            is_price_share          isPriceShare,
            promotion_share_price   promotionSharePrice,
            lb_share_price          lbSharePrice,
            cash_coupon_share_price cashCouponSharePrice,
            cash_return_share_price cashReturnSharePrice,
            return_price            returnPrice,
            is_returnable           isReturnable,
            return_priority         returnPriority,
            order_qty               orderQuantity,
            shipping_qty            shippingQuantity,
            return_qty              returnQuantity,
            returnable_qty          returnableQuantity,
            goods_line_type         goods_line_type,
            price_item_id           priceItemId,
            company_flag            companyFlag,
            cover_image_uri         coverImageUri
        from
        ord_goods_info
        where ord_no = #{ordNo} and promotion_id = #{actId}
    </select>

    <select id="getOrderDetail" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
            oid    id,
            ord_no order_number,
            order_type,
            create_time,
            effective_end_time,
            status,
            delivery_status,
            pick_up_code,
            delivery_type,
            order_subject_type,
            creator_identity_type,
            creator_id,
            creator_name,
            creator_phone,
            store_id,
            store_code,
            store_structure_code,
            sales_consult_id,
            sales_consult_name,
            sales_consult_phone,
            customer_id,
            customer_name,
            customer_phone,
            customer_type,
            total_goods_price,
            is_evaluated,
            audit_no,
            remark,
            city_id,
            city_name,
            sob_id,
            store_org_id,
            sales_number
        FROM
            ord_base_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getOrderLogistice" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLogisticsInfo">
        SELECT *
        FROM
            ord_logistics_info
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getOrderBillingDetail" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        SELECT
            create_time,
            oid,
            ord_no          order_number,
            total_goods_price,
            member_discount,
            promotion_discount,
            freight,
            upstairs_fee,
            lebi_quantity,
            lebi_cash_discount,
            cash_coupon_discount,
            product_coupon_discount,
            cus_pre_deposit,
            online_pay_type,
            online_pay_amount,
            online_pay_time,
            st_pre_deposit,
            emp_credit_money,
            st_credit_money store_credit_money,
            st_subvention   store_subvention,
            order_amount_subtotal,
            amount_payable,
            collection_amount,
            arrearage,
            is_owner_receiving,
            is_pay_up,
            pay_up_time,
            store_cash
        FROM
            ord_billing_details
        WHERE
            ord_no = #{orderNumber}
    </select>

    <select id="getOrderBillingDetailListByOrderNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        SELECT
            id,
            oid    orderId,
            ord_no orderNumber,
            create_time,
            pay_time,
            pay_type,
            pay_type_desc,
            payment_subject_type,
            payment_subject_type_desc,
            amount,
            reply_code,
            receipt_number
        FROM
            ord_billing_payment_details
        WHERE
            ord_no = #{orderNo}
    </select>

    <select id="getOrderGoodsDetails" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GiftListResponseGoods">
        SELECT
            ogi.order_qty       qty,
            ogi.retail_price,
            ogi.goods_line_type goods_type,
            gg.sku_name,
            gg.gid              goodsId,
            gg.goods_specification,
            gg.cover_image_uri,
            gg.goods_unit
        FROM
            ord_goods_info AS ogi
            INNER JOIN gds_goods AS gg ON ogi.sku = gg.sku
        WHERE
            ogi.ord_no = #{orderNumber}
    </select>

    <select id="getOrderGoodsList" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.OrderGoodsListResponse">
        SELECT
            ogi.order_qty       qty,
            ogi.retail_price,
            ogi.goods_line_type goods_type,
            gg.sku_name,
            gg.gid              goodsId,
            gg.goods_specification,
            gg.cover_image_uri,
            gg.goods_unit,
            ogi.is_evaluation
        FROM
            ord_goods_info AS ogi
            INNER JOIN gds_goods AS gg ON ogi.sku = gg.sku
        WHERE
            ogi.ord_no = #{orderNumber}
    </select>

    <select id="getOrderInfoByOrderNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderTempInfo">
        SELECT
            ob.ord_no              orderNo,
            ob.pick_up_code        pickUpCode,
            ob.status              orderStatus,
            ob.delivery_type       deliveryType,
            od.collection_amount   collectionAmount,
            od.arrearage           ownMoney,
            ob.customer_name       customerName,
            ob.customer_phone      customerPhone,
            ob.sales_consult_name  sellerName,
            ob.sales_consult_phone sellerPhone,
            ol.shipping_address    shippingAddress,
            ob.oid                 orderId,
            ol.delivery_clerk_no   operatorNo,
            ob.sales_consult_id    sellerId,
            ob.city_id             cityId
        FROM ord_base_info ob
            LEFT JOIN ord_billing_details od ON od.ord_no = ob.ord_no
            LEFT JOIN ord_logistics_info ol ON ol.ord_no = ob.ord_no
        WHERE ob.ord_no = #{orderNo}

    </select>

    <select id="getOrderGoodsZgInfoByUserId" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsZgInfo">
        SELECT
            id            id,
            user_id       userId,
            gid           gid,
            sku           sku,
            ord_no        orderNo,
            goods_line_id goodsLineId,
            create_time   createTime
        FROM ord_goods_zg_info
        WHERE user_id = #{userId}
    </select>

    <insert id="savePaymentDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        INSERT INTO ord_billing_payment_details
        (oid, ord_no, create_time, pay_time, pay_type, amount, reply_code, receipt_number,
         pay_type_desc, payment_subject_type, payment_subject_type_desc)
        VALUES
            (#{orderId}, #{orderNumber}, #{createTime}, #{payTime}, #{payType}, #{amount}, #{replyCode},
                         #{receiptNumber},
                         #{payTypeDesc}, #{paymentSubjectType}, #{paymentSubjectTypeDesc})
    </insert>

    <update id="updateOwnMoneyByOrderNo"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        UPDATE ord_billing_details
        <set>
            <if test="null != arrearage">
                arrearage = #{arrearage},
            </if>
            <if test="null != isPayUp">
                is_pay_up = #{isPayUp},
            </if>
            <if test="null != payUpTime">
                pay_up_time = #{payUpTime},
            </if>
            <if test="null != deliveryPos">
                delivery_pos = #{deliveryPos},
            </if>
            <if test="null != deliveryCash">
                delivery_cash = #{deliveryCash},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

    <update id="updateOrderStatusByOrderNo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        UPDATE ord_base_info
        <set>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != deliveryStatus">
                delivery_status = #{deliveryStatus},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

    <insert id="saveOrderBaseInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ord_base_info
        (ord_no, order_type, create_time, effective_end_time, status, delivery_status, pick_up_code,
         delivery_type, order_subject_type, creator_identity_type, creator_id, creator_name, creator_phone,
         store_id, store_code, store_structure_code, sales_consult_id, sales_consult_name, sales_consult_phone,
         customer_id, customer_name, customer_phone, total_goods_price, is_evaluated, audit_no,
         remark, city_id, city_name, customer_type, store_org_id, sob_id, sales_number, is_record_sales
        ) VALUES (
            #{orderNumber},
            #{orderType},
            #{createTime},
            #{effectiveEndTime},
            #{status},
            #{deliveryStatus},
            #{pickUpCode},
            #{deliveryType},
            #{orderSubjectType},
            #{creatorIdentityType},
            #{creatorId},
            #{creatorName},
            #{creatorPhone},
            #{storeId},
            #{storeCode},
            #{storeStructureCode},
            #{salesConsultId},
            #{salesConsultName},
            #{salesConsultPhone},
            #{customerId},
            #{customerName},
            #{customerPhone},
            #{totalGoodsPrice},
            #{isEvaluated},
            #{auditNo},
            #{remark},
            #{cityId},
            #{cityName},
            #{customerType},
            #{storeOrgId},
            #{sobId},
            #{salesNumber},
            #{isRecordSales})

    </insert>

    <insert id="saveOrderLogisticsInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLogisticsInfo">
        INSERT INTO ord_logistics_info (oid, ord_no, delivery_type, booking_store_code, booking_store_name, booking_store_address, delivery_time,
                                        delivery_clerk_no, delivery_clerk_id, delivery_clerk_name, warehouse, is_owner_receiving, receiver,
                                        receiver_phone, shipping_address, residence_name, delivery_province, delivery_city, delivery_county,
                                        delivery_street,
                                        detailed_address)
        VALUES (#{oid}, #{ordNo}, #{deliveryType}, #{bookingStoreCode}, #{bookingStoreName},
                        #{bookingStoreAddress}, #{deliveryTime}, #{deliveryClerkNo}, #{deliveryClerkId},
                        #{deliveryClerkName}, #{warehouse}, #{isOwnerReceiving},
                                                            #{receiver}, #{receiverPhone}, #{shippingAddress},
                                                            #{residenceName}, #{deliveryProvince}, #{deliveryCity},
                                                            #{deliveryCounty},
                                                            #{deliveryStreet}, #{detailedAddress})
    </insert>
    <insert id="saveOrderGoodsInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ord_goods_info
        (
            oid, ord_no, goods_line_type, gid, sku, sku_name, retail_price, VIP_price, wholesale_price, promotion_id,
            is_price_share, promotion_share_price, lb_share_price, cash_coupon_share_price, cash_return_share_price,
            return_price, is_returnable, return_priority, order_qty, shipping_qty, return_qty, returnable_qty, settlement_price,
            price_item_id, company_flag, cover_image_uri
        )
        VALUES (#{oid}, #{orderNumber}, #{goodsLineType}, #{gid}, #{sku}, #{skuName}, #{retailPrice}, #{VIPPrice},
                        #{wholesalePrice}, #{promotionId},
                        #{isPriceShare}, #{promotionSharePrice}, #{lbSharePrice}, #{cashCouponSharePrice},
                                         #{cashReturnSharePrice},
                                         #{returnPrice}, #{isReturnable}, #{returnPriority}, #{orderQuantity},
                                         #{shippingQuantity},
                                         #{returnQuantity}, #{returnableQuantity}, #{settlementPrice},
                #{priceItemId}, #{companyFlag}, #{coverImageUri})

    </insert>

    <insert id="saveOrderGoodsZgInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsZgInfo">
        INSERT INTO ord_goods_zg_info
        (
            user_id, gid, sku, ord_no, goods_line_id, create_time
        )
        VALUES
            (
                #{userId}, #{gid}, #{sku}, #{orderNo}, #{goodsLineId}, #{createTime}
            )

    </insert>

    <insert id="saveOrderBillingDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        INSERT INTO ord_billing_details (create_time, oid, ord_no, total_goods_price, member_discount, promotion_discount, freight, upstairs_fee,
                                         lebi_quantity, lebi_cash_discount, cash_coupon_discount, product_coupon_discount, cus_pre_deposit,
                                         online_pay_type, online_pay_amount, st_pre_deposit, emp_credit_money, st_credit_money,
                                         st_subvention, order_amount_subtotal, amount_payable, collection_amount, arrearage, is_owner_receiving,
                                         online_pay_time, pay_up_time, is_pay_up, store_cash, store_other_money, store_pos_money, store_pos_number, manage_receipt_time)
        VALUES
            (#{createTime}, #{oid}, #{orderNumber}, #{totalGoodsPrice}, #{memberDiscount}, #{promotionDiscount},
                            #{freight},
                            #{upstairsFee}, #{lebiQuantity}, #{lebiCashDiscount}, #{cashCouponDiscount},
                #{productCouponDiscount}, #{cusPreDeposit},
                #{onlinePayType}, #{onlinePayAmount}, #{stPreDeposit}, #{empCreditMoney}, #{storeCreditMoney},
                #{storeSubvention}, #{orderAmountSubtotal},
                #{amountPayable}, #{collectionAmount}, #{arrearage}, #{isOwnerReceiving}, #{onlinePayTime},
                                  #{payUpTime}, #{isPayUp}, #{storeCash}, #{storeOtherMoney}, #{storePosMoney},
                                  #{storePosNumber}, #{manageReceiptTime}
            )
    </insert>

    <insert id="saveOrderBillingPaymentDetail"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        INSERT INTO ord_billing_payment_details (oid, ord_no, create_time, pay_time, pay_type, pay_type_desc, payment_subject_type,
                                                 payment_subject_type_desc, amount, reply_code, receipt_number)
        VALUES
            (#{orderId}, #{orderNumber}, #{createTime}, #{payTime}, #{payType}, #{payTypeDesc}, #{paymentSubjectType},
                         #{paymentSubjectTypeDesc},
                         #{amount}, #{replyCode}, #{receiptNumber})
    </insert>

    <update id="updateOrderBaseInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        UPDATE ord_base_info
        <set>
            <if test="null != status ">
                status = #{status},
            </if>
            <if test="null != deliveryStatus ">
                delivery_status = #{deliveryStatus},
            </if>
            <if test="null != pickUpCode ">
                pick_up_code = #{pickUpCode},
            </if>
            <if test="null != isEvaluated ">
                is_evaluated = #{isEvaluated},
            </if>
            <if test="null != isRecordSales">
                is_record_sales = #{isRecordSales}
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

    <update id="updateOrderBillingDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        UPDATE ord_billing_details
        <set>
            <if test="null != onlinePayType ">
                online_pay_type = #{onlinePayType},
            </if>
            <if test="null != onlinePayAmount ">
                online_pay_amount = #{onlinePayAmount},
            </if>
            <if test="null != arrearage ">
                arrearage = #{arrearage},
            </if>
            <if test="null != onlinePayTime">
                online_pay_time = #{onlinePayTime},
            </if>
            <if test="null != payUpTime  ">
                pay_up_time = #{payUpTime},
            </if>
            <if test="null != collectionAmount">
                collection_amount = #{collectionAmount},
            </if>
            <if test="null != isPayUp  ">
                is_pay_up = #{isPayUp}
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>


    <update id="updateOrderStatusAndDeliveryStatusByOrderNo">
        UPDATE ord_base_info
        <set>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != deliveryStatus">
                delivery_status = #{deliveryStatus}
            </if>
        </set>
        WHERE ord_no = #{orderNumber}

    </update>

    <update id="updateOrderGoodsInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        update ord_goods_info
        <set>
            <if test="oid != null">
                oid = #{oid,jdbcType=BIGINT},
            </if>
            <if test="orderNumber != null">
                ord_no = #{orderNumber,jdbcType=VARCHAR},
            </if>
            <if test="sku != null">
                sku = #{sku,jdbcType=VARCHAR},
            </if>
            <if test="skuName != null">
                sku_name = #{skuName,jdbcType=VARCHAR},
            </if>
            <if test="retailPrice != null">
                retail_price = #{retailPrice,jdbcType=DECIMAL},
            </if>
            <if test="VIPPrice != null">
                VIP_price = #{VIPPrice,jdbcType=DECIMAL},
            </if>
            <if test="wholesalePrice != null">
                wholesale_price = #{wholesalePrice,jdbcType=DECIMAL},
            </if>
            <if test="promotionId != null">
                promotion_id = #{promotionId,jdbcType=BIGINT},
            </if>
            <if test="isPriceShare != null">
                is_price_share = #{isPriceShare,jdbcType=BIT},
            </if>
            <if test="promotionSharePrice != null">
                promotion_share_price = #{promotionSharePrice,jdbcType=DECIMAL},
            </if>
            <if test="lbSharePrice != null">
                lb_share_price = #{lbSharePrice,jdbcType=DECIMAL},
            </if>
            <if test="cashCouponSharePrice != null">
                cash_coupon_share_price = #{cashCouponSharePrice,jdbcType=DECIMAL},
            </if>
            <if test="cashReturnSharePrice != null">
                cash_return_share_price = #{cashReturnSharePrice,jdbcType=DECIMAL},
            </if>
            <if test="returnPrice != null">
                return_price = #{returnPrice,jdbcType=DECIMAL},
            </if>
            <if test="isReturnable != null">
                is_returnable = #{isReturnable,jdbcType=BIT},
            </if>
            <if test="returnPriority != null">
                return_priority = #{returnPriority,jdbcType=INTEGER},
            </if>
            <if test="orderQuantity != null">
                order_qty = #{orderQuantity,jdbcType=INTEGER},
            </if>
            <if test="shippingQuantity != null">
                shipping_qty = #{shippingQuantity,jdbcType=INTEGER},
            </if>
            <if test="returnQuantity != null">
                return_qty = #{returnQuantity,jdbcType=INTEGER},
            </if>
            <if test="returnableQuantity != null">
                returnable_qty = #{returnableQuantity,jdbcType=INTEGER},
            </if>
            <if test="goodsLineType != null">
                goods_line_type = #{goodsLineType,jdbcType=VARCHAR},
            </if>
            <if test="priceItemId != null">
                price_item_id = #{priceItemId,jdbcType=BIGINT},
            </if>
            <if test="companyFlag != null">
                company_flag = #{companyFlag,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <delete id="deleteOrderGoodsInfo" parameterType="java.lang.Long">
        DELETE FROM ord_goods_info
        WHERE ID = #{id}
    </delete>

    <select id="getOrderArrearageInfo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.OrderArrearageInfoResponse">
        SELECT IFNULL(collection_amount, 0.00) arrearageMoney
        FROM ord_billing_details
        WHERE ord_no = #{orderNo}
    </select>

    <insert id="saveOrderCouponInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderCouponInfo">
        INSERT INTO ord_coupon_info (oid, ord_no, coupon_type, coupon_id, purchase_price, cost_price, get_type, sku)
        VALUES (#{oid}, #{orderNumber}, #{couponType}, #{couponId}, #{purchasePrice}, #{costPrice}, #{getType}, #{sku});
    </insert>

    <select id="getPendingEvaluationOrderListByUserIDAndIdentityType" resultMap="pendingEvaluationOrder">
        SELECT
        o.status,
        o.is_evaluated,
        o.store_id,
        o.ord_no,
        o.effective_end_time,
        o.delivery_type,
        o.customer_id,
        o.customer_name,
        o.customer_phone,
        ob.total_goods_price,
        ob.amount_payable,
        ogi.cover_image_uri,
        oli.shipping_address
        FROM ord_base_info o
        INNER JOIN ord_billing_details ob ON
        o.oid = ob.oid
        INNER JOIN ord_logistics_info oli ON
        oli.oid =o.oid
        LEFT JOIN ord_goods_info ogi ON
        o.oid = ogi.oid
        WHERE
        o.oid = ogi.oid
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            AND (o.customer_id = #{userID}
            OR (o.creator_id =#{userID} AND o.creator_identity_type =#{identityType}))
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            AND o.creator_id = #{userID}
            AND o.creator_identity_type = #{identityType}
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            AND o.creator_id = #{userID}
            AND o.creator_identity_type = #{identityType}
        </if>
        AND o.status = 'FINISHED'
        AND o.is_evaluated =false
        ORDER BY o.create_time DESC
    </select>
    <resultMap id="pendingEvaluationOrder" type="cn.com.leyizhuang.app.foundation.pojo.response.OrderListResponse">
        <result column="ord_no" property="orderNo" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="store_id" property="storeId" jdbcType="BIGINT"/>
        <result column="total_goods_price" property="price" jdbcType="DECIMAL"/>
        <result column="effective_end_time" property="endTime" jdbcType="TIMESTAMP"/>
        <result column="is_evaluated" property="isEvaluated" jdbcType="BIT"/>
        <result column="delivery_type" property="deliveryType"
                jdbcType="VARCHAR"/>
        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="customer_phone" property="customerPhone" jdbcType="VARCHAR"/>
        <result column="shipping_address" property="shippingAddress" jdbcType="VARCHAR"/>
        <collection property="goodsImgList" ofType="java.lang.String" javaType="list">
            <result column="cover_image_uri"/>
        </collection>
    </resultMap>

    <select id="getOrderCouponInfoByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderCouponInfo">
        SELECT
            id,
            oid,
            ord_no orderNumber,
            coupon_type,
            coupon_id,
            purchase_price,
            cost_price,
            get_type,
            sku
        FROM ord_coupon_info
        WHERE ord_no = #{orderNumber}
    </select>


    <select id="getUnpaidOrderQuantityByEmpId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_base_info
        WHERE creator_id = #{id}
              AND creator_identity_type != 'CUSTOMER'
              AND status = 'UNPAID'
              AND effective_end_time &gt; NOW()
    </select>


    <select id="getUnpaidOrderQuantityByCusId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_base_info
        WHERE (customer_id = #{id}
               OR (creator_id = #{id} AND creator_identity_type = 'CUSTOMER'))
              AND status = 'UNPAID'
              AND effective_end_time &gt; NOW()
    </select>


    <select id="getPendingReceiveOrderQuantityByEmpId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_base_info
        WHERE creator_id = #{id}
              AND creator_identity_type != 'CUSTOMER'
              AND status = 'PENDING_RECEIVE'
    </select>


    <select id="getPendingReceiveOrderQuantityByCusId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_base_info
        WHERE (customer_id = #{id}
               OR (creator_id = #{id} AND creator_identity_type = 'CUSTOMER'))
              AND status = 'PENDING_RECEIVE'
    </select>


    <select id="getIsEvaluatedOrderQuantityByEmpId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_base_info
        WHERE creator_id = #{id}
              AND creator_identity_type != 'CUSTOMER'
              AND status = 'FINISHED'
              AND is_evaluated = FALSE
    </select>


    <select id="getIsEvaluatedOrderQuantityByCusId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_base_info
        WHERE (customer_id = #{id}
               OR (creator_id = #{id} AND creator_identity_type = 'CUSTOMER'))
              AND status = 'FINISHED'
              AND is_evaluated = FALSE
    </select>


    <select id="getReturningOrderQuantityByEmpId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_return_base_info
        WHERE creator_id = #{id}
              AND creator_identityType != 'CUSTOMER'
              AND return_status != 'FINISHED'
              AND return_status != 'CANCELED'
    </select>


    <select id="getReturningOrderQuantityByCusId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT count(1)
        FROM ord_return_base_info
        WHERE (cus_id = #{id}
               OR (creator_id = #{id} AND creator_identityType = 'CUSTOMER'))
              AND return_status != 'FINISHED'
              AND return_status != 'CANCELED'
    </select>

    <insert id="saveOrderJxPriceDifferenceReturnDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderJxPriceDifferenceReturnDetails">
        INSERT INTO ord_jx_price_difference_return_details (oid, ord_no, create_time, store_id, store_code, sku, unit_price, quantity, amount, receipt_number)
            SELECT
                #{oid},
                #{orderNumber},
                #{createTime},
                #{storeId},
                #{storeCode},
                #{sku},
                #{unitPrice},
                #{quantity},
                #{amount},
                #{receiptNumber}
            FROM dual
            WHERE NOT exists(SELECT 1
                             FROM ord_jx_price_difference_return_details
                             WHERE receipt_number = #{receiptNumber})
    </insert>


    <select id="getOrderJxPriceDifferenceReturnDetailsByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderJxPriceDifferenceReturnDetails">
        SELECT
            id,
            oid,
            ord_no order_number,
            create_time,
            store_id,
            store_code,
            sku,
            unit_price,
            quantity,
            amount,
            receipt_number
        FROM ord_jx_price_difference_return_details
        WHERE ord_no = #{orderNumber}
    </select>

    <update id="updateReturnableQuantityAndReturnQuantityById">
        UPDATE ord_goods_info
        SET return_qty     = return_qty - #{qty},
            returnable_qty = returnable_qty + #{qty}
        WHERE
            id = #{ogi}
    </update>

    <update id="updateOrderGoodsShippingQuantity">
        UPDATE ord_goods_info
        SET shipping_qty = #{qty}
        WHERE sku = #{sku}
              AND ord_no = #{orderNo}

    </update>

    <update id="updateOrderLogisticInfo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLogisticsInfo">
        UPDATE ord_logistics_info
        <set>
            <if test="deliveryClerkId != null">
                delivery_clerk_id = #{deliveryClerkId},
            </if>
            <if test="deliveryClerkNo != null">
                delivery_clerk_no = #{deliveryClerkNo},
            </if>
            <if test="deliveryClerkName != null">
                delivery_clerk_name = #{deliveryClerkName},
            </if>
            <if test="deliveryClerkPhone != null">
                delivery_clerk_Phone = #{deliveryClerkPhone},
            </if>
            <if test="warehouse != null">
                warehouse = #{warehouse},
            </if>
        </set>
        WHERE ord_no = #{ordNo}
    </update>

    <select id="getOrderBillingDetailListByReceiptNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        SELECT
            id,
            oid    orderId,
            ord_no orderNumber,
            create_time,
            pay_time,
            pay_type,
            pay_type_desc,
            payment_subject_type,
            payment_subject_type_desc,
            amount,
            reply_code,
            receipt_number
        FROM
            ord_billing_payment_details
        WHERE
            receipt_number = #{receiptNumber}
    </select>


    <select id="getPendingShipmentAndPendingReceive" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.customer_id = #{userId}
            AND (obi.`status` ='PENDING_RECEIVE' OR obi.`status` = 'PENDING_SHIPMENT')
            AND obi.delivery_type = 'HOUSE_DELIVERY'
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.creator_id = #{userId}
            AND creator_identity_type != 'CUSTOMER'
            AND creator_identity_type != 'SELLER'
            AND (obi.`status` ='PENDING_RECEIVE' OR obi.`status` = 'PENDING_SHIPMENT')
            AND obi.delivery_type = 'HOUSE_DELIVERY'
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info AS obi
            WHERE
            obi.creator_id = #{userId}
            AND creator_identity_type != 'CUSTOMER'
            AND creator_identity_type != 'DECORATE_MANAGER'
            AND (obi.`status` ='PENDING_RECEIVE' OR obi.`status` = 'PENDING_SHIPMENT')
            AND obi.delivery_type = 'HOUSE_DELIVERY'
            ORDER BY obi.create_time DESC
        </if>
    </select>

    <insert id="saveOrderLifecycle" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLifecycle">
        INSERT INTO ord_lifecycle (oid, ord_no, operation, post_status, operation_time)
        VALUES (
            #{oid}, #{orderNumber}, #{operation}, #{postStatus}, #{operationTime}
        )
    </insert>

    <select id="getOrderListPageInfoByUserIdAndIdentityType" resultMap="orderPageInfoListMap">

        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.oid,
            obi.ord_no,
            obi.`status`,
            obi.is_evaluated,
            obi.effective_end_time,
            obi.delivery_type,
            obd.total_goods_price price ,
            obd.amount_payable,
            CASE WHEN obi.delivery_type='HOUSE_DELIVERY'
            THEN oli.shipping_address
            ELSE oli.booking_store_name
            END AS shipping_address
            FROM
            ord_base_info obi LEFT JOIN ord_billing_details obd ON obi.oid = obd.oid
            LEFT JOIN ord_logistics_info oli ON obi.oid = oli.oid
            WHERE
            obi.customer_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
                AND obi.effective_end_time > NOW()
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` ='PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
                AND <![CDATA[obi.create_time >= DATE_ADD(NOW(),INTERVAL -6 MONTH )]]>
            </if>
            <if test="null != showStatus and showStatus == 6">
                AND obi.`status` = 'PENDING_SHIPMENT'
            </if>
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.oid,
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obd.total_goods_price price ,
            obd.amount_payable,
            CASE WHEN obi.delivery_type='HOUSE_DELIVERY'
            THEN oli.shipping_address
            ELSE oli.booking_store_name
            END AS shipping_address
            FROM
            ord_base_info obi LEFT JOIN ord_billing_details obd ON obi.oid = obd.oid
            LEFT JOIN ord_logistics_info oli ON obi.oid = oli.oid
            WHERE
            <choose>
                <when test="sellerType !=null and sellerType.toString() == 'SUPERVISOR'">
                    obi.store_id = #{storeId}
                </when>
                <otherwise>
                    obi.creator_id = #{userID}
                </otherwise>
            </choose>
            AND creator_identity_type != 'CUSTOMER'
            AND creator_identity_type != 'SELLER'
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
                AND obi.effective_end_time > NOW()
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` ='PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            <if test="null != showStatus and showStatus == 6">
                AND obi.`status` = 'PENDING_SHIPMENT'
            </if>
            ORDER BY obi.create_time DESC
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.oid,
            obi.`status`,
            obi.is_evaluated,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type,
            obd.total_goods_price price ,
            obd.amount_payable,
            CASE WHEN obi.delivery_type='HOUSE_DELIVERY'
            THEN oli.shipping_address
            ELSE oli.booking_store_name
            END AS shipping_address,
            obi.customer_id,
            obi.customer_name,
            obi.customer_phone
            FROM
            ord_base_info obi LEFT JOIN ord_billing_details obd ON obi.oid = obd.oid
            LEFT JOIN ord_logistics_info oli ON obi.oid = oli.oid
            WHERE
            obi.creator_id = #{userID}
            AND creator_identity_type != 'CUSTOMER'
            AND creator_identity_type != 'DECORATE_MANAGER'
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID'
                AND obi.effective_end_time > NOW()
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` ='PENDING_RECEIVE'
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED'
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED'
            </if>
            <if test="null != showStatus and showStatus == 5">
                AND obi.`status` = 'FINISHED'
                AND obi.is_evaluated is FALSE
            </if>
            <if test="null != showStatus and showStatus == 6">
                AND obi.`status` = 'PENDING_SHIPMENT'
            </if>
            ORDER BY obi.create_time DESC
        </if>
    </select>

    <resultMap id="orderPageInfoListMap" type="cn.com.leyizhuang.app.foundation.pojo.response.OrderPageInfoVO">
        <id column="oid" property="oid"/>
        <result column="ord_no" property="orderNo" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="effective_end_time" property="effectiveEndTime" jdbcType="TIMESTAMP"/>
        <result column="is_evaluated" property="isEvaluated" jdbcType="BIT"/>
        <result column="delivery_type" property="deliveryType" jdbcType="VARCHAR"/>

        <result column="price" property="price" jdbcType="DECIMAL"/>
        <result column="amount_payable" property="amountPayable" jdbcType="DECIMAL"/>
        <result column="shipping_address" property="shippingAddress" jdbcType="VARCHAR"/>

        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="customer_phone" property="customerPhone" jdbcType="VARCHAR"/>
        <collection property="orderGoodsInfoList" column="oid"
                    ofType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo"
                    select="getOrderGoodsInfoCollection">
        </collection>
    </resultMap>

    <select id="getOrderGoodsInfoCollection" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
            gid,
            order_qty order_quantity,
            cover_image_uri
        FROM ord_goods_info
        WHERE oid = #{oid}
    </select>

    <select id="getOrderGoodsByOrderNumberAndSkuAndGoodsLineType" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
            id                      id,
            oid                     oid,
            ord_no                  orderNumber,
            gid                     gid,
            sku                     sku,
            sku_name                skuName,
            retail_price            retailPrice,
            VIP_price               VIPPrice,
            wholesale_price         wholesalePrice,
            settlement_price        settlementPrice,
            promotion_id            promotionId,
            is_price_share          isPriceShare,
            promotion_share_price   promotionSharePrice,
            lb_share_price          lbSharePrice,
            cash_coupon_share_price cashCouponSharePrice,
            cash_return_share_price cashReturnSharePrice,
            return_price            returnPrice,
            is_returnable           isReturnable,
            return_priority         returnPriority,
            order_qty               orderQuantity,
            shipping_qty            shippingQuantity,
            return_qty              returnQuantity,
            returnable_qty          returnableQuantity,
            goods_line_type         goods_line_type,
            price_item_id           priceItemId,
            company_flag            companyFlag
        FROM
          ord_goods_info
        WHERE
        ord_no = #{ordNo}
        <if test="sku != null">
            and sku = #{sku}
        </if>
        <if test=" GoodsLineType != null">
            and goods_line_type = #{GoodsLineType}
        </if>
    </select>
    <select id="getSendToWMSFailedOrder" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
        <include refid="All_FIELD"/>
        FROM ord_base_info WHERE ord_no IN (
        'ZZ_XN20180410121039220757',
        'ZZ_XN20180410121424337446',
        'ZZ_XN20180410122412832577',
        'ZZ_XN20180410131103273766',
        'CD_XN20180410133713480915',
        'CD_XN20180410141842793222'
        )
    </select>

    <select id="getNotSellDetailsOrderNOs" resultType="java.lang.String">
        SELECT  o.ord_no from ord_base_info o
        LEFT JOIN ord_billing_details obd on o.oid = obd.oid
        and  o.delivery_type = 'HOUSE_DELIVERY'
        where o.status in ('PENDING_RECEIVE','FINISHED')
        and o.is_record_sales = #{flag}
        and obd.pay_up_time &gt; #{fristDay}
        and obd.is_pay_up = 1
        UNION
        SELECT  o.ord_no from ord_base_info o
        LEFT JOIN ord_billing_details obd on o.oid = obd.oid
        and  o.delivery_type = 'HOUSE_DELIVERY'
        where o.status in ('FINISHED')
        and o.is_record_sales = #{flag}
        and obd.pay_up_time &gt; #{fristDay}
        and obd.is_pay_up = 1
        UNION
        SELECT  o.ord_no from ord_base_info o
        LEFT JOIN ord_billing_details obd on o.oid = obd.oid
        LEFT JOIN inter_wta_order_shipping_header wa ON o.ord_no = wa.order_no
        and  o.delivery_type = 'HOUSE_DELIVERY'
        where o.status in ('PENDING_RECEIVE','FINISHED')
        and o.is_record_sales = #{flag}
        and wa.end_dt &gt; #{fristDay}
        and obd.pay_up_time &lt; #{fristDay}
        and obd.is_pay_up = 1
        UNION
        SELECT  o.ord_no from ord_base_info o
        LEFT JOIN ord_billing_details obd on o.oid = obd.oid
        LEFT JOIN ord_shipping os on o.oid = os.oid
        and  o.delivery_type = 'HOUSE_DELIVERY'
        where o.status in ('FINISHED')
        and o.is_record_sales = #{flag}
        and os.shipping_time &gt; #{fristDay}
        and obd.pay_up_time &lt; #{fristDay}
        and obd.is_pay_up = 1

    </select>


    <select id="getOrderGoodsQtyInfoByOrderNumber" parameterType="java.lang.String" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
        id                      id,
        oid                     oid,
        ord_no                  orderNumber,
        gid                     gid,
        sku                     sku,
        IFNULL(order_qty,0)     orderQuantity,
        IFNULL(shipping_qty,0)  shippingQuantity,
        goods_line_type         goods_line_type
        FROM
        ord_goods_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getCusProductCouponByOrderNumber" parameterType="cn.com.leyizhuang.app.foundation.pojo.CustomerProductCoupon">
        SELECT  cp.* from cus_customer_product_coupon cp
        LEFT JOIN  ord_coupon_info oc on cp.id = oc.coupon_id
        WHERE oc.ord_no = #{orderNO}
    </select>

    <update id="updateOrderGoodsPrice" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        UPDATE  ord_goods_info
        <set>
            <if test="settlementPrice != null">
                settlement_price = #{settlementPrice},
            </if>
            <if test="promotionSharePrice != null">
                promotion_share_price = #{promotionSharePrice},
            </if>
            <if test="returnPrice != null">
                return_price = #{returnPrice},
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <update id="updateOrderGoodsInfPrice" parameterType="cn.com.leyizhuang.app.foundation.pojo.remote.webservice.ebs.OrderGoodsInf">
        UPDATE  inter_ate_order_goods_inf
        <set>
            <if test="settlementPrice != null">
                settlement_price = #{settlementPrice},
            </if>
            <if test="promotionDiscount != null">
                promotion_discount = #{promotionDiscount},
            </if>
            <if test="returnPrice != null">
                return_price = #{returnPrice},
            </if>
            <if test="discountTotalPrice != null">
                discount_total_price = #{discountTotalPrice},
            </if>
        </set>
        where order_line_id = #{orderLineId}
    </update>

    <update id="updateOrdCouponPrice">
        UPDATE ord_coupon_info
        set purchase_price = #{price}
        where ord_no = #{ordNo} and sku = #{sku}
    </update>

    <update id="updateOrderGoodsShippingQuantityByid" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        UPDATE ord_goods_info
        SET shipping_qty = #{shippingQuantity}
        WHERE sku = #{sku}
              AND id = #{id}
    </update>

    <update id="updateOrderGoodsReturnableQuantityByid" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        UPDATE ord_goods_info
        SET returnable_qty = #{returnableQuantity}
        WHERE sku = #{sku}
        AND id = #{id}
    </update>

    <update id="updateOrderBaseInfoStatus" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        UPDATE ord_base_info
        <set>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != deliveryStatus">
                delivery_status = #{deliveryStatus}
            </if>
        </set>
        WHERE ord_no = #{orderNumber} AND delivery_status != 'SEALED_CAR'
        AND delivery_status != 'CONFIRM_ARRIVAL'
        AND delivery_status != 'REJECT'
    </update>

    <select id="getOrderProductCouponPurchasePrice" resultType="java.lang.Double">
        SELECT SUM(purchase_price) from ord_coupon_info where ord_no = #{ordNo} and sku = #{sku}
    </select>

    <select id="getOrderValidCouponQty" resultType="java.lang.Integer">
        SELECT * from ord_coupon_info oci LEFT JOIN cus_customer_product_coupon ccpc on oci.coupon_id = ccpc.id
    </select>

    <insert id="saveOrderShipping" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderShipping">
        INSERT
        ord_shipping(oid,ord_no,shipping_no,shipping_time)
        VALUES
        (#{oid},#{ordNo},#{shippingNo},#{shippingTime})
    </insert>



</mapper>