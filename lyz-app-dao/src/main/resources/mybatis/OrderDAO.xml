<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.OrderDAO">

    <sql id="All_FIELD">
        OID,ORDER_NO,ORDER_TYPE,CREATE_TIME,EFFECTIVE_END_TIME,STATUS,DELIVERY_STATUS,PICK_UP_CODE,DELIVERT_TYPE,
        ORDER_SUBJECT_TYPE,CREATOR_IDENTITY_TYPE,COMPANY_CODE,COMPANY_STRUCTURE_CODE,CREATOR_ID_FIT,CREATOR_NAME_FIT,
        CREATOR_PHONE_FIT,EMPLOYEE_ID,EMPLOYEE_NAME,MANAGER_ID,MANAGER_NAME,AUDITOR_ID,AUDITOR_NAME,AUDITOR_PHONE,
        AUDITING_TIME,STORE_CODE,STORE_STRUCTURE_CODE,CREATOR_ID_STORE,CREATOR_NAME_STORE,CREATOR_PHONE_STORE,
        SALES_CONSULT_ID,SALES_CONSULT_NAME,SALES_CONSULT_PHONE,CUSTOMER_ID,CUSTOMER_NAME,CUSTOMER_PHONE,
        TOTAL_GOODS_PRICE,IS_EVALUATED
    </sql>
    <resultMap id="orderBeseInfoList" type="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        <result column="ord_no" property="orderNumber" jdbcType="VARCHAR"/>
        <result column="status" property="status" javaType="cn.com.leyizhuang.app.core.constant.AppOrderStatus"/>
        <result column="effective_end_time" property="effectiveEndTime" jdbcType="TIMESTAMP"/>
        <result column="delivery_type" property="deliveryType"
                javaType="cn.com.leyizhuang.app.core.constant.AppDeliveryType"/>
    </resultMap>

    <select id="getGoodsInfoByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.MaterialListDO">
        SELECT DISTINCT g.gid, g.sku, g.sku_name, g.goods_specification, g.cover_image_uri, g.goods_unit,
        og.order_qty qty
        FROM ord_goods_info og
        LEFT JOIN gds_goods g ON g.sku = og.sku
        WHERE og.ord_no = #{orderNumber}
        AND (og.is_gift IS NULL OR og.is_gift = false)
    </select>

    <select id="getOrderListByUserIDAndIdentityType" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.customer_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
            AND obi.`status` = 'UNPAID';
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` = 'PENDING_RECEIVE';
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED';
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED';
            </if>
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.manager_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID';
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` = 'PENDING_RECEIVE';
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED';
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED';
            </if>
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            WHERE
            obi.sales_consult_id = #{userID}
            <if test="null != showStatus and showStatus == 1">
                AND obi.`status` = 'UNPAID';
            </if>
            <if test="null != showStatus and showStatus == 2">
                AND obi.`status` = 'PENDING_RECEIVE';
            </if>
            <if test="null != showStatus and showStatus == 3">
                AND obi.`status` = 'FINISHED';
            </if>
            <if test="null != showStatus and showStatus == 4">
                AND obi.`status` = 'CANCELED';
            </if>
        </if>
    </select>

    <select id="getFuzzyQuery" resultMap="orderBeseInfoList">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.customer_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%'))
        </if>
        <if test="null != identityType and identityType.toString() == 'DECORATE_MANAGER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.manager_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%'))
        </if>
        <if test="null != identityType and identityType.toString() == 'SELLER'">
            SELECT
            obi.`status`,
            obi.ord_no,
            obi.effective_end_time,
            obi.delivery_type
            FROM
            ord_base_info AS obi
            INNER JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
            WHERE
            obi.sales_consult_id = #{userID}
            AND
            (oli.ord_no LIKE concat(concat('%',#{condition}),'%') OR oli.shipping_address LIKE
            concat(concat('%',#{condition}),'%') OR oli.receiver LIKE concat(concat('%',#{condition}),'%'))
        </if>
    </select>

    <select id="getOrderGoodsInfoByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderGoodsInfo">
        SELECT
        *
        FROM
        ord_goods_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getAmountPayableByOrderNumber" resultType="java.lang.Double">
        SELECT
        amount_payable
        FROM
        ord_billing_details
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="querySumQtyByOrderNumber" resultType="java.lang.Integer">
        SELECT sum(order_qty)
        FROM ord_goods_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="findByOrderName" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
        <include refid="All_FIELD"/>
        FROM
        ord_base_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getOrderDetail" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
        *
        FROM
        ord_base_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getOrderLogistice" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderLogisticsInfo">
        SELECT
        *
        FROM
        ord_logistics_info
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getOrderBillingDetail" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        SELECT
        *
        FROM
        ord_billing_details
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getOrderGoodsDetails" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GiftListResponseGoods">
        SELECT
        ogi.order_qty qty,
        ogi.retail_price,
        ogi.is_gift,
        gg.sku_name,
        gg.gid goodsId,
        gg.goods_specification,
        gg.cover_image_uri ,
        gg.goods_unit
        FROM
        ord_goods_info AS ogi
        INNER JOIN gds_goods AS gg ON ogi.sku = gg.sku
        WHERE
        ogi.ord_no = #{orderNumber}
    </select>

    <select id="getOrderInfoByOrderNo" parameterType="java.lang.String" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderTempInfo">
        SELECT ob.ord_no orderNo, ob.pick_up_code pickUpCode, ob.status orderStatus, ob.delivery_type deliveryType,
          od.collection_amount collectionAmount, od.own_money ownMoney, ob.customer_name customerName,
          ob.customer_phone customerPhone, ob.sales_consult_name sellerName, ob.sales_consult_phone sellerPhone,
          ol.shipping_address shippingAddress, ob.oid orderId, ol.delivery_clerk_no operatorNo, ob.sales_consult_id sellerId
        FROM ord_base_info ob
        LEFT JOIN ord_billing_details od ON od.ord_no = ob.ord_no
        LEFT JOIN ord_logistics_info ol ON ol.ord_no = ob.ord_no
        WHERE ob.ord_no = #{orderNo}

    </select>
    
    <insert id="savePaymentDetails" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingPaymentDetails">
        INSERT INTO ord_billing_payment_details
        (oid,ord_no,currency_type,pay_time,pay_type,amount,reply_code,receipt_number)
        VALUES
        (#{orderId},#{orderNumber},#{currencyType},#{payTime},#{payType},#{amount},#{replyCode},#{receiptNumber})
    </insert>

    <update id="updateOwnMoneyByOrderNo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBillingDetails">
        UPDATE ord_billing_details
        <set>
            <if test="null != arrearage">
                own_money = #{arrearage},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

    <update id="updateOrderStatusByOrderNo" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        UPDATE ord_base_info
        <set>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != deliveryStatus">
                delivery_status = #{deliveryStatus},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>

</mapper>