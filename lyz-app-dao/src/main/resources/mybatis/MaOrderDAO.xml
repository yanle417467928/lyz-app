<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.MaOrderDAO">

    <select id="findMaOrderVOAll" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
            obi.ord_no orderNumber,
            obi.create_time createTime,
            obi.creator_phone meberNumber,
            obi.creator_name meberName,
            obi.`status` 'status',
            obi.delivery_type deliveryType,
            s.store_name storeName,
            obd.amount_payable orderPrice,
            s.store_id storeId,
			obi.customer_name customerName,
			obi.customer_phone customerPhone
        FROM
              ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
         WHERE
        obi.order_subject_type = 'STORE'
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
            obi.create_time DESC
    </select>


    <select id="findStoreAndSmallFitOrderVO" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.total_goods_price orderPrice,
        s.store_id storeId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        (s.fit_compay_type is null OR s.fit_compay_type !='MONTHLY' OR s.fit_compay_type ='')
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findMaOrderVOByCityId" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.total_goods_price orderPrice
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        obi.order_subject_type = 'STORE'
	    AND obi.city_id = #{cityId}
        AND s.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findMaOrderVOByStoreId" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        obi.order_subject_type = 'STORE'
        AND obi.store_id = #{storeId}
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findMaOrderVOByStoreIdAndCityIdAndDeliveryType"
            resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        obi.order_subject_type = 'STORE'
        <if test="deliveryType != null">
            AND obi.delivery_type = #{deliveryType}
        </if>
        <if test="cityId != null and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="storeId != null and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findMaOrderVOByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.total_goods_price orderPrice,
        s.store_id storeId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        (s.fit_compay_type is null OR s.fit_compay_type !='MONTHLY' OR s.fit_compay_type ='')
        AND obi.ord_no LIKE concat(concat('%',#{orderNumber}),'%')
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findMaOrderVOByCondition"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.request.management.MaOrderVORequest"
            resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.total_goods_price orderPrice,
        s.store_id storeId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        (s.fit_compay_type is null OR s.fit_compay_type !='MONTHLY' OR s.fit_compay_type ='')
        <if test="appDeliveryType != null">
            AND obi.delivery_type = #{appDeliveryType}
        </if>
        <if test="cityId != null and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="storeId != null and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="beginTime != null and beginTime != ''">
            AND obi.create_time &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND obi.create_time &lt;= #{endTime}
        </if>
        <if test="memberName != null and memberName != ''">
            AND obi.customer_name LIKE concat(concat('%',#{memberName}),'%')
        </if>
        <if test="shippingAddress != null and shippingAddress != ''">
            AND oli.shipping_address LIKE concat(concat('%',#{shippingAddress}),'%')
        </if>
        <if test="sellerName != null and sellerName != ''">
            AND obi.sales_consult_name LIKE concat(concat('%',#{sellerName}),'%')
        </if>
        <if test="memberPhone != null and memberPhone != ''">
            AND obi.customer_phone LIKE concat(concat('%',#{memberPhone}),'%')
        </if>
        <if test="receiverName != null and receiverName != ''">
            AND oli.receiver LIKE concat(concat('%',#{receiverName}),'%')
        </if>
        <if test="receiverPhone != null and receiverPhone != ''">
            AND oli.receiver_phone LIKE concat(concat('%',#{receiverPhone}),'%')
        </if>
        <if test="list != null">
            AND s.store_id IN
            <foreach collection="list" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>


        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findCompanyOrderAll" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice,
        s.store_id storeId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
             s.store_type='ZS'
        AND s.fit_compay_type != 'CASH'
        <if test="list != null">
            AND s.store_id IN
            <foreach collection="list" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findCompanyOrderByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice,
        s.store_id storeId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
         s.store_type='ZS'
        AND s.fit_compay_type != 'CASH'
        AND obi.ord_no LIKE concat(concat('%',#{orderNumber}),'%')
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findCompanyOrderByCondition"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.request.management.MaCompanyOrderVORequest"
            resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice,
        s.store_id storeId,
        obi.customer_name customerName,
        obi.customer_phone customerPhone
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
          s.store_type='ZS'
        AND
        s.fit_compay_type != 'CASH'
        <if test="cityId != null and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="storeId != null and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="beginTime != null and beginTime != ''">
            AND obi.create_time &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND obi.create_time &lt;= #{endTime}
        </if>
        <if test="creatorName != null and creatorName != ''">
            AND obi.creator_name LIKE concat(concat('%',#{creatorName}),'%')
        </if>
        <if test="shippingAddress != null and shippingAddress != ''">
            AND oli.shipping_address LIKE concat(concat('%',#{shippingAddress}),'%')
        </if>
        <if test="creatorPhone != null and creatorPhone != ''">
            AND obi.creator_phone LIKE concat(concat('%',#{creatorPhone}),'%')
        </if>
        <if test="receiverName != null and receiverName != ''">
            AND oli.receiver LIKE concat(concat('%',#{receiverName}),'%')
        </if>
        <if test="receiverPhone != null and receiverPhone != ''">
            AND oli.receiver_phone LIKE concat(concat('%',#{receiverPhone}),'%')
        </if>
        <if test="list != null">
            AND s.store_id IN
            <foreach collection="list" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findPendingShipmentOrder" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        	obi.`status` = 'PENDING_SHIPMENT'
        AND obi.delivery_type = 'SELF_TAKE'
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findPendingShipmentOrderByCondition"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.request.management.MaCompanyOrderVORequest"
            resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
        obi.`status` = 'PENDING_SHIPMENT'
        AND obi.delivery_type = 'SELF_TAKE'
        <if test="cityId != null and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="storeId != null and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="beginTime != null and beginTime != ''">
            AND obi.create_time &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND obi.create_time &lt;= #{endTime}
        </if>
        <if test="creatorName != null and creatorName != ''">
            AND obi.creator_name LIKE concat(concat('%',#{creatorName}),'%')
        </if>
        <if test="shippingAddress != null and shippingAddress != ''">
            AND oli.shipping_address LIKE concat(concat('%',#{shippingAddress}),'%')
        </if>
        <if test="creatorPhone != null and creatorPhone != ''">
            AND obi.creator_phone LIKE concat(concat('%',#{creatorPhone}),'%')
        </if>
        <if test="receiverName != null and receiverName != ''">
            AND oli.receiver LIKE concat(concat('%',#{receiverName}),'%')
        </if>
        <if test="receiverPhone != null and receiverPhone != ''">
            AND oli.receiver_phone LIKE concat(concat('%',#{receiverPhone}),'%')
        </if>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findPendingShipmentOrderByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.vo.MaOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_phone meberNumber,
        obi.creator_name meberName,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        s.store_name storeName,
        obd.amount_payable orderPrice
        FROM
        ord_base_info AS obi
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
         obi.`status` = 'PENDING_SHIPMENT'
        AND obi.delivery_type = 'SELF_TAKE'
        AND obi.ord_no LIKE concat(concat('%',#{orderNumber}),'%')
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findMaOrderDetailByOrderNumber"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaOrderDetailResponse">
       SELECT
            obi.ord_no orderNumber,
            obi.`status` orderStatus,
            obi.creator_id creatorId,
            obi.create_time createTime,
            obi.creator_name creatorName,
            obi.delivery_type deliveryType,
            obi.sales_consult_name sellerName,
            obi.customer_id customerId,
            obi.customer_name customerName,
            obi.remark orderRemarks,
            s.store_name storeName,
            oli.receiver receiverName,
            oli.receiver_phone receiverPhone,
            oli.is_owner_receiving isOwnerReceiving,
            oli.shipping_address shippingAddress,
            obd.collection_amount collectionAmount
        FROM
            ord_base_info AS obi
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN ord_billing_details AS obd ON obi.ord_no = obd.ord_no
        LEFT JOIN st_store AS s ON s.store_id = obi.store_id
        WHERE
            obi.ord_no = #{orderNumber}
    </select>

    <select id="findMaCompanyOrderDetailByOrderNumber"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaCompanyOrderDetailResponse">
        SELECT
            obi.ord_no orderNumber,
            obi.`status` orderStatus,
            obi.create_time createTime,
            obi.store_code companyCode,
            s.store_name companyName,
            obi.creator_id creatorId,
            obi.creator_name creatorName,
            obi.audit_no auditNumber,
            obi.delivery_type deliveryType,
            oli.receiver receiverName,
            oli.receiver_phone receiverPhone,
            oli.shipping_address shippingAddress,
            oli.is_owner_receiving isOwnerReceiving,
            obi.remark orderRemarks
        FROM
            ord_base_info AS obi
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN st_store AS s ON s.store_code = obi.store_code
        WHERE
            obi.ord_no = #{orderNumber}
    </select>

    <select id="getMaOrderBillingDetailByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaOrderBillingDetailResponse">
        SELECT
        total_goods_price totalGoodsPrice,
        member_discount memberDiscount,
        promotion_discount promotionDiscount,
        freight freight,
        lebi_cash_discount lebiCashDiscount,
        cash_coupon_discount cashCouponDiscount,
        st_subvention subvention,
        amount_payable amountPayable,
        arrearage arrearage,
        order_amount_subtotal orderAmountSubtotal,
        product_coupon_discount productCouponDiscount,
        emp_credit_money empCreditMoney,
        IFNULL(upstairs_fee, 0) upstairs_fee
        FROM
        ord_billing_details
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getMaOrderBillingPaymentDetailByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaOrderBillingPaymentDetailResponse">
        SELECT
        pay_time payTime,
        pay_type paymentType,
        amount amount
        FROM
        ord_billing_payment_details
        WHERE
        ord_no = #{orderNumber}
    </select>

    <select id="getDeliveryInfoByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaOrderDeliveryInfoResponse">
        SELECT
            oli.delivery_time deliveryTime,
            oli.delivery_clerk_name deliveryClerkName,
            oli.warehouse warehouse,
            odid.task_no shipmentNumber
        FROM
            ord_base_info AS obi
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN ord_delivery_info_details AS odid ON odid.order_no = obi.ord_no
        AND odid.logistic_status = obi.delivery_status
        WHERE
            obi.ord_no = #{orderNumber}
    </select>


    <select id="findSelfTakeOrderList"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaSelfTakeOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        obi.status status,
        obi.creator_identity_type creatorIdentityType,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN st_store AS s ON s.store_code = obi.store_code
        INNER JOIN ord_billing_details obd ON obi.oid=obd.oid
        WHERE
        obi.order_subject_type = 'STORE'
        AND
        obi.delivery_type= 'SELF_TAKE'
        AND
        obi.status !='UNPAID'
        AND
        obi.status !='CANCELED'
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findSelfTakeOrderListByScreen" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaSelfTakeOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        obi.status status,
        obi.creator_identity_type creatorIdentityType,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN st_store AS s ON s.store_code = obi.store_code
        INNER JOIN ord_billing_details obd ON obi.oid=obd.oid
        WHERE
        obi.order_subject_type = 'STORE'
        AND
        obi.delivery_type= 'SELF_TAKE'
        AND
        obi.status !='UNPAID'
        AND
        obi.status !='CANCELED'
        <choose>
            <when test=" null!= status and 1==status">
                AND
            obi.status !='PENDING_RECEIVE'
            AND
            obi.status !='CANCELING'
        </when>
            <when test=" null!= status and 0==status">
                AND
                (obi.status ='PENDING_RECEIVE'
                OR
                obi.status ='CANCELING')
            </when>
        </choose>
        <choose>
            <when test=" null!= isPayUp and 1==isPayUp">
                AND
                obd.is_pay_up =TRUE
            </when>
            <when test=" null!= isPayUp and 0==isPayUp">
                AND
                obd.is_pay_up =FALSE
            </when>
        </choose>
        <if test=" null!= storeId and -1!=storeId ">
            AND
            s.store_id =#{storeId}
        </if>
        <if test=" null!= cityId and -1!=cityId ">
            AND
            obi.city_id =#{cityId}
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>


    <select id="findSelfTakeOrderListByInfo"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaSelfTakeOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        obi.status status,
        obi.creator_identity_type creatorIdentityType,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN st_store AS s ON s.store_code = obi.store_code
        INNER JOIN ord_billing_details obd ON obi.oid=obd.oid
        WHERE
        obi.order_subject_type = 'STORE'
        AND
        obi.delivery_type= 'SELF_TAKE'
        AND
        obi.status !='UNPAID'
        AND
        obi.status !='CANCELED'
        AND
        obi.ord_no  LIKE CONCAT('%',#{info},'%')
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="findSelfTakeOrderListByCondition"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.request.management.MaOrderVORequest"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaSelfTakeOrderVO">
        SELECT
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        obi.status status,
        obi.creator_identity_type creatorIdentityType,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN st_store AS s ON s.store_code = obi.store_code
        INNER JOIN ord_billing_details obd ON obi.oid=obd.oid
        LEFT JOIN ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        WHERE
        obi.order_subject_type = 'STORE'
        AND
        obi.delivery_type= 'SELF_TAKE'
        AND
        obi.status !='UNPAID'
        AND
        obi.status !='CANCELED'
        <if test="beginTime != null and beginTime != ''">
            AND obi.create_time &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND obi.effective_end_time &lt;= #{endTime}
        </if>
        <if test="memberName != null and memberName != ''">
            AND obi.customer_name LIKE concat(concat('%',#{memberName}),'%')
        </if>
        <if test="shippingAddress != null and shippingAddress != ''">
            AND obi.shipping_address LIKE concat(concat('%',#{shippingAddress}),'%')
        </if>
        <if test="sellerName != null and sellerName != ''">
            AND obi.sales_consult_name LIKE concat(concat('%',#{sellerName}),'%')
        </if>
        <if test="memberPhone != null and memberPhone != ''">
            AND obi.customer_phone LIKE concat(concat('%',#{memberPhone}),'%')
        </if>
        <if test="receiverName != null and receiverName != ''">
            AND oli.receiver LIKE concat(concat('%',#{receiverName}),'%')
        </if>
        <if test="receiverPhone != null and receiverPhone != ''">
            AND obi.receiver_phone LIKE concat(concat('%',#{receiverPhone}),'%')
        </if>
        ORDER BY
        obi.create_time DESC
    </select>

    <select id="getOrderInfoByOrderNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaOrderTempInfo">
        SELECT
            oid id,
            ord_no orderNumber,
            pick_up_code,
            store_id,
            store_code,
            city_id,
            city_name,
            creator_identity_type,
            sob_id,
            create_time,
            status,
            customer_id,
            sales_consult_id,
            delivery_type,
            store_structure_code,
            sales_manager_id,
            sales_manager_store_id
        FROM ord_base_info obi
        WHERE obi.ord_no = #{orderNo}
    </select>


    <select id="findOrderGoodsList"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaOrderGoodsInfo">
        SELECT
        ogi.gid gid,
        ogi.sku  sku,
        ogi.sku_name  skuName,
        ogi.order_qty orderQty,
        ogi.return_price returnPrice,
        si.last_update_time
        FROM ord_goods_info ogi
        LEFT  JOIN st_inventory si ON ogi.gid = si.gid
        WHERE ogi.ord_no = #{orderNo}
        AND
        si.store_id =#{storeId}
    </select>


    <update id="updateOrderStatus" parameterType="java.lang.String">
        UPDATE ord_base_info
        SET
        status = #{status}
        WHERE ord_no = #{orderNo}
    </update>


    <update id="updateOrderReceivablesStatus"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaOrderAmount">
        UPDATE ord_billing_details
        <set>
            is_pay_up = 1,
            arrearage = 0,
            <if test="date != null">
                manage_receipt_time= #{date},
            </if>
            <if test="payUpTime != null">
                pay_up_time = #{payUpTime},
            </if>
            <if test="cashAmount != null">
                store_cash = #{cashAmount},
            </if>
            <if test="otherAmount != null">
                store_other_money = #{otherAmount},
            </if>
            <if test="posAmount != null">
                store_pos_money = #{posAmount},
            </if>
            <if test="serialNumber != null">
                store_pos_number = #{serialNumber},
            </if>
        </set>
        WHERE ord_no = #{orderNumber}
    </update>



    <insert id="saveOrderShipping" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderShipping">
        INSERT
        ord_shipping(oid,ord_no,shipping_no,shipping_time)
        VALUES
        (#{oid},#{ordNo},#{shippingNo},#{shippingTime})
    </insert>

    <select id="getShippingTime" parameterType="java.lang.String"
            resultType="java.lang.String">
        SELECT
        os.shipping_time
        FROM ord_shipping os
        WHERE os.ord_no = #{orderNumber}
        ORDER  BY  id DESC
        LIMIT 1
    </select>

    <select id="isPayUp" parameterType="java.lang.String"
            resultType="java.lang.Boolean">
        SELECT
        obd.is_pay_up
        FROM ord_billing_details obd
        WHERE obd.ord_no = #{orderNo}
    </select>

    <insert id="saveOrderBillingPaymentDetails"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaOrderBillingPaymentDetails">
        INSERT INTO ord_billing_payment_details (oid, ord_no, create_time, pay_time, pay_type, pay_type_desc, payment_subject_type,
                                                 payment_subject_type_desc, amount, reply_code, receipt_number, payment_subject_id, remarks)
        VALUES
            (#{oid}, #{ordNo}, #{createTime}, #{payTime}, #{payType}, #{payTypeDesc}, #{paymentSubjectType},
                         #{paymentSubjectTypeDesc},
                         #{amount}, #{replyCode}, #{receiptNumber},#{paymentSubjectId},#{remarks})
    </insert>


    <insert id="saveAppToEbsOrderReceiveInf"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.management.webservice.ebs.MaOrderReceiveInf">
        INSERT INTO inter_ate_order_receive_inf (deliver_type_title, header_id, order_number, receive_date, sob_id, error_msg, send_flag,send_time,init_date)
        VALUES
        (#{deliverTypeTitle}, #{headerId}, #{orderNumber}, #{receiveDate}, #{sobId}, #{errorMsg}, #{sendFlag},
        #{sendTime}, #{initDate})
    </insert>

    <select id="queryOrderReceiveInf" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.webservice.ebs.MaOrderReceiveInf">
     SELECT
     id,
     deliver_type_title,
     header_id,
     order_number,
     receive_date,
     sob_id,
     init_date
     FROM
     inter_ate_order_receive_inf
     WHERE
     order_number = #{orderNumber}
     ORDER BY id DESC
     limit 1
    </select>


    <select id="findArrearsAndAgencyOrderList"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaAgencyAndArrearsOrderVO">
        SELECT
        oaa.id,
        obi.ord_no orderNumber,
        oaa.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        oaa.status arrearsAuditStatus,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN
        ord_arrears_audit oaa ON obi.ord_no =oaa.ord_no
        LEFT JOIN
        st_store AS s ON s.store_code = obi.store_code
        LEFT JOIN
        ord_billing_details obd ON obi.ord_no =obd.ord_no
        WHERE
        1=1
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        oaa.create_time DESC
    </select>


    <select id="findMaAgencyAndArrearsOrderListByScreen" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaAgencyAndArrearsOrderVO">
        SELECT
        oaa.id,
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        oaa.status arrearsAuditStatus,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN
        ord_arrears_audit oaa ON obi.ord_no =oaa.ord_no
        LEFT JOIN
        st_store AS s ON s.store_code = obi.store_code
        LEFT JOIN
        ord_billing_details obd ON obi.ord_no =obd.ord_no
        WHERE
        1=1
        <choose>
            <when test=" null!= status and 2==status">
                AND
                oaa.status ='AUDIT_PASSED'

            </when>
            <when test=" null!= status and 1==status">
                AND
                oaa.status ='AUDIT_NO'
            </when>
            <when test=" null!= status and 0==status">
                AND
                oaa.status ='AUDITING'
            </when>
        </choose>
        <choose>
            <when test=" null!= isPayUp and 1==isPayUp">
                AND
                obd.is_pay_up =TRUE
            </when>
            <when test=" null!= isPayUp and 0==isPayUp">
                AND
                obd.is_pay_up =FALSE
            </when>
        </choose>
        <if test=" null!= storeId and -1!=storeId ">
            AND
            s.store_id =#{storeId}
        </if>
        <if test=" null!= cityId and -1!=cityId ">
            AND
            obi.city_id =#{cityId}
        </if>
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>


    <select id="findMaAgencyAndArrearsOrderListByInfo"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.order.MaAgencyAndArrearsOrderVO">
    SELECT
        oaa.id,
        obi.ord_no orderNumber,
        obi.create_time createTime,
        obi.creator_name creatorName,
        obi.customer_name customerName,
        s.store_name storeName,
        oaa.status arrearsAuditStatus,
        obd.is_pay_up isPayUp
        FROM
        ord_base_info AS obi
        INNER JOIN
        ord_arrears_audit oaa ON obi.ord_no =oaa.ord_no
        LEFT JOIN
        st_store AS s ON s.store_code = obi.store_code
        LEFT JOIN
        ord_billing_details obd ON obi.ord_no =obd.ord_no
        WHERE
        obi.ord_no LIKE concat(concat('%',#{info}),'%')
        AND obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>


    <update id="auditOrderStatus" >
        UPDATE ord_arrears_audit
        SET
        status = #{status},
        update_time = now()
        WHERE ord_no = #{orderNumber}
        AND
        id =#{auditId}
    </update>


    <select id="querySellerIdByOrderNumber" parameterType="java.lang.String"
            resultType="java.lang.Long">
        SELECT
             oaa.seller_id
        FROM ord_arrears_audit oaa
        WHERE oaa.ord_no = #{orderNumber}
        ORDER BY
        create_time
        DESC
        LIMIT 1
    </select>


    <select id="queryRepaymentAmount" parameterType="java.lang.String"
            resultType="java.lang.Double">
        SELECT oaa.order_money - oaa.real_money
        FROM ord_arrears_audit oaa
        WHERE oaa.ord_no = #{orderNumber}
        ORDER BY
        create_time
        DESC
        LIMIT 1
    </select>


    <select id="getArrearsAuditInfo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaOrderArrearsAudit">
        SELECT
        id,
        user_id,
        ord_no               orderNumber,
        customer_name,
        customer_phone,
        seller_id,
        seller_name,
        seller_phone,
        distribution_address distributionAddress,
        distribution_time    distributionTime,
        agency_money,
        order_money,
        real_money,
        payment_method,
        status,
        cash_money,
        pos_money,
        alipay_money,
        wechat_money,
        remarks,
        create_time,
        update_time,
        whether_repayments   whetherRepayments,
        repayment_time       repaymentTime,
        picture
        FROM ord_arrears_audit
        WHERE ord_no = #{orderNumber}
        ORDER BY
        create_time
        DESC
        LIMIT 1
    </select>


    <select id="getArrearsAuditInfoById" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaOrderArrearsAudit">
        SELECT
        id,
        user_id,
        ord_no               orderNumber,
        customer_name,
        customer_phone,
        seller_id,
        seller_name,
        seller_phone,
        distribution_address distributionAddress,
        distribution_time    distributionTime,
        agency_money,
        order_money,
        real_money,
        payment_method,
        status,
        cash_money,
        pos_money,
        alipay_money,
        wechat_money,
        remarks,
        create_time,
        update_time,
        whether_repayments   whetherRepayments,
        repayment_time       repaymentTime,
        picture
        FROM ord_arrears_audit
        WHERE id = #{id}
    </select>


    <select id="scanningUnpaidOrder" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
       SELECT
            oid id,
            ord_no orderNumber,
            order_type orderType,
            create_time createTime,
            effective_end_time effectiveEndTime,
            `status`,
            delivery_status deliveryStatus,
            pick_up_code pickUpCode,
            delivery_type deliveryType,
            order_subject_type orderSubjectType,
            creator_identity_type creatorIdentityType,
            creator_id creatorId,
            creator_name creatorName,
            creator_phone creatorPhone,
            store_id storeId,
            store_code storeCode,
            store_structure_code storeStructureCode,
            sales_consult_id salesConsultId,
            sales_consult_name salesConsultName,
            sales_consult_phone salesConsultPhone,
            customer_id customerId,
            customer_name customerName,
            customer_phone customerPhone,
            customer_type customerType,
            total_goods_price totalGoodsPrice,
            is_evaluated isEvaluated,
            audit_no auditNo,
            remark remark,
            city_id cityId,
            city_name cityName,
            sob_id sobId,
            store_org_id storeOrgId,
            sales_number salesNumber
        FROM
            ord_base_info
        WHERE
            `status` = 'UNPAID'
        AND create_time >= #{findDate}
    </select>


    <select id="findPaymentDataByOrderNo" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.order.MaPaymentData">
        SELECT
        total_fee,
        create_time,
        online_pay_type,
        payment_type
        FROM payment_data
        WHERE ord_no = #{orderNumber}
        AND
        trade_status='TRADE_SUCCESS'
        ORDER BY id DESC
    </select>


    <update id="updateOrderArrearsAudit">
        UPDATE ord_arrears_audit
        SET whether_repayments = 1,
        repayment_time = #{repaymentTime}
        WHERE
        ord_no = #{orderNumber}
        AND `status` = 'AUDIT_PASSED'
    </update>




    <select id="findFitOrderVOPageInfo" resultType="cn.com.leyizhuang.app.foundation.vo.FitOrderVO">
        SELECT
        por.ord_no orderNumber,
        por.create_time createTime,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        por.payhelper_amount payhelperAmount,
        por.is_pay_over isPayOver,
        ss.store_name storeName
        FROM
        payhelper_ord_relation por
        LEFT JOIN  ord_base_info obi ON por.ord_no = obi.ord_no
        LEFT  JOIN  st_store ss on obi.store_id = ss.store_id
        WHERE
         obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>


    <select id="findFitOrderListByScreen" resultType="cn.com.leyizhuang.app.foundation.vo.FitOrderVO">
        SELECT
        por.ord_no orderNumber,
        por.create_time createTime,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        por.payhelper_amount payhelperAmount,
        por.is_pay_over isPayOver,
        ss.store_name storeName
        FROM
        payhelper_ord_relation por
        LEFT JOIN  ord_base_info obi ON por.ord_no = obi.ord_no
        LEFT  JOIN  st_store ss on obi.store_id = ss.store_id
        WHERE
        1=1
        <if test=" null!= storeId and -1!=storeId ">
            AND
            ss.store_id =#{storeId}
        </if>
        <if test=" null!= cityId and -1!=cityId ">
            AND
            obi.city_id =#{cityId}
        </if>
        AND
        obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>


    <select id="findFitOrderListByInfo" resultType="cn.com.leyizhuang.app.foundation.vo.FitOrderVO">
        SELECT
        por.ord_no orderNumber,
        por.create_time createTime,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        por.payhelper_amount payhelperAmount,
        por.is_pay_over isPayOver,
        ss.store_name storeName
        FROM
        payhelper_ord_relation por
        LEFT JOIN  ord_base_info obi ON por.ord_no = obi.ord_no
        LEFT  JOIN  st_store ss on obi.store_id = ss.store_id
        WHERE
        1=1
        <if test=" null!= info and ''!=info ">
            AND
            por.ord_no LIKE concat(concat('%',#{info}),'%')
        </if>
        AND
        obi.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY
        obi.create_time DESC
    </select>


    <select id="findFitOrderByCondition"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.request.management.MaCompanyOrderVORequest"
            resultType="cn.com.leyizhuang.app.foundation.vo.FitOrderVO">
        SELECT
        por.ord_no orderNumber,
        por.create_time createTime,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        por.payhelper_amount payhelperAmount,
        por.is_pay_over isPayOver,
        ss.store_name storeName
        FROM
        payhelper_ord_relation por
        LEFT JOIN  ord_base_info obi ON por.ord_no = obi.ord_no
        LEFT JOIN   ord_logistics_info AS oli ON obi.ord_no = oli.ord_no
        LEFT JOIN  st_store ss on obi.store_id = ss.store_id
        WHERE
        obi.order_subject_type = 'FIT'
        <if test="cityId != null and cityId != -1">
            AND obi.city_id = #{cityId}
        </if>
        <if test="storeId != null and storeId != -1">
            AND obi.store_id = #{storeId}
        </if>
        <if test="beginTime != null and beginTime != ''">
            AND obi.create_time &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND obi.create_time &lt;= #{endTime}
        </if>
        <if test="creatorName != null and creatorName != ''">
            AND obi.creator_name LIKE concat(concat('%',#{creatorName}),'%')
        </if>
        <if test="shippingAddress != null and shippingAddress != ''">
            AND oli.shipping_address LIKE concat(concat('%',#{shippingAddress}),'%')
        </if>
        <if test="creatorPhone != null and creatorPhone != ''">
            AND obi.creator_phone LIKE concat(concat('%',#{creatorPhone}),'%')
        </if>
        <if test="receiverName != null and receiverName != ''">
            AND oli.receiver LIKE concat(concat('%',#{receiverName}),'%')
        </if>
        <if test="receiverPhone != null and receiverPhone != ''">
            AND oli.receiver_phone LIKE concat(concat('%',#{receiverPhone}),'%')
        </if>
        <if test="list != null">
            AND ss.store_id IN
            <foreach collection="list" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        ORDER BY
        obi.create_time DESC
    </select>



    <select id="findFitOrderByOrderNumber" resultType="cn.com.leyizhuang.app.foundation.vo.DetailFitOrderVO">
        SELECT
        por.ord_no orderNumber,
        por.create_time createTime,
        obi.`status` 'status',
        obi.delivery_type deliveryType,
        por.payhelper_amount payhelperAmount,
        por.is_pay_over isPayOver,
        ss.store_name storeName,
        ee.name payhelper
        FROM
        payhelper_ord_relation por
        LEFT JOIN  ord_base_info obi ON por.ord_no = obi.ord_no
        LEFT  JOIN  st_store ss on obi.store_id = ss.store_id
        LEFT  JOIN  emp_employee ee on ee.emp_id=por.payhelper_id
        WHERE
        1=1
        <if test=" null!= ordNumber and ''!=ordNumber ">
            AND
            por.ord_no =#{ordNumber}
        </if>
    </select>

    <select id="findMaOrderGoodsVOListByEmpIdAndGoodsSkus" resultType="cn.com.leyizhuang.app.foundation.vo.OrderGoodsVO">
        SELECT
        g.gid,
        g.sku,
        g.sku_name,
        gp.retail_price,
        gp.vip_price,
        gp.wholesale_price,
        g.company_flag,
        g.cover_image_uri,
        gp.price_line_id price_item_id
        FROM emp_employee e
        INNER JOIN gds_goods_price gp ON e.store_id = gp.store_id
        AND gp.price_type = 'COMMON'
        INNER JOIN gds_goods g ON gp.gid = g.gid
        where e.emp_id = #{userId}
        AND gp.start_time &lt; NOW()
        AND (gp.end_time IS NULL OR gp.end_time &gt; NOW())
        AND g.sku in
        <foreach collection="goodsSkuSet" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </select>
</mapper>