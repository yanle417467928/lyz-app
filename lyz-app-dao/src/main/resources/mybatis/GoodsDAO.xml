<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.GoodsDAO">
    <resultMap id="goodsResult" type="cn.com.leyizhuang.app.foundation.pojo.GoodsDO">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="CREATOR_ID" property="creatorId"/>
        <result column="CREATOR_TYPE" property="creatorType"/>
        <result column="CREATE_TIME" property="createTime"/>
        <result column="MODIFIER_ID" property="modifierId"/>
        <result column="MODIFIER_TYPE" property="modifierType"/>
        <result column="MODIFY_TIME" property="modifyTime"/>
        <result column="GOODS_NAME" property="goodsName"/>
        <result column="GOODS_CODE" property="goodsCode"/>
        <result column="IS_GIFT" property="isGift"/>
        <result column="TITLE" property="title"/>
        <result column="SUB_TITLE" property="subTitle"/>
        <result column="COVER_IMAGE_URI" property="coverImageUri"/>
        <result column="ROTATION_IMAGE_URI" property="rotationImageUri"/>
        <result column="DETAIL" property="detail"/>
        <result column="IS_ON_SALE" property="isOnSale"/>
        <result column="IS_RECOMMEND_INDEX" property="isRecommendIndex"/>
        <result column="IS_RECOMMEND_TYPE" property="isRecommendType"/>
        <result column="IS_HOT" property="isHot"/>
        <result column="IS_NEW" property="isNew"/>
        <result column="IS_SPECIAL_PRICE" property="isSpecialPrice"/>
        <result column="CATEGORY_ID" property="categoryId"/>
        <result column="CATEGORY_TITLE" property="categoryTitle"/>
        <result column="CATEGORY_ID_TREE" property="categoryIdTree"/>
        <result column="MARKET_PRICE" property="marketPrice"/>
        <result column="SALE_PRICE" property="salePrice"/>
        <result column="LEFT_NUMBER" property="leftNumber"/>
        <result column="PRICE_UNIT" property="priceUnit"/>
        <result column="ONSALE_TIME" property="onSaleTime"/>
        <result column="CREATE_TIME" property="createTime"/>
        <result column="SORT_ID" property="sortId"/>
        <result column="BRAND_TITLE" property="brandTitle"/>
        <result column="BRAND_ID" property="brandId"/>
        <result column="PRODUCT_FLAG" property="productFlag"/>
        <result column="RETURN_PRICE" property="returnPrice"/>
        <result column="IS_COLOR_PACKAGE" property="isColorPackage"/>
        <result column="IS_COLORFUL" property="isColorful"/>
        <result column="COLOR_PACKAGE_SKU" property="colorPackageSku"/>
        <result column="INVENTORY_ITEM_ID" property="inventoryItemId"/>
        <result column="INV_CATEGORY_ID" property="invCategoryId"/>
        <result column="ITEM_TYPE_NAME" property="itemTypeName"/>
        <result column="ITEM_TYPE_CODE" property="itemTypeCode"/>
        <result column="INVENTORY_ITEM_STATUS" property="inventoryItemStatus"/>
        <result column="ITEM_BARCODE" property="itemBarcode"/>
        <result column="UNIT_NAME" property="unitName"/>
    </resultMap>

    <select id="queryList" resultMap="goodsResult">
        SELECT *
        FROM GOODS
        ORDER BY CREATE_TIME DESC
    </select>

    <select id="queryById" parameterType="java.lang.Long" resultMap="goodsResult">
        SELECT *
        FROM GOODS
        WHERE ID = #{id}
    </select>

    <delete id="batchRemove" parameterType="java.util.List">
        DELETE FROM GOODS WHERE ID IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <update id="modify" parameterType="cn.com.leyizhuang.app.foundation.pojo.GoodsDO">
        UPDATE GOODS
        <set>
            <if test="null != modifierId">
                MODIFIER_ID = #{modifierId},
            </if>
            <if test="null != modifierType">
                MODIFIER_TYPE = #{modifierType},
            </if>
            <if test="null != modifyTime">
                MODIFY_TIME = #{modifyTime},
            </if>
            <if test="null != goodsName">
                GOODS_NAME = #{goodsName},
            </if>
            <if test="null != goodsCode">
                GOODS_CODE = #{goodsCode},
            </if>
            <if test="null != title">
                TITLE = #{title},
            </if>
            <if test="null != isGift">
                IS_GIFT = #{isGift},
            </if>
            <if test="null != subTitle">
                SUB_TITLE = #{subTitle},
            </if>
            <if test="null != coverImageUri">
                COVER_IMAGE_URI = #{coverImageUri},
            </if>
            <if test="null != showPictures">
                SHOW_PICTURES = #{showPictures},
            </if>
            <if test="null != isOnSale">
                IS_ON_SALE = #{isOnSale},
            </if>
            <if test="null != categoryId">
                CATEGORY_ID = #{categoryId},
            </if>
            <if test="null != leftNumber">
                LEFT_NUMBER = #{leftNumber},
            </if>
            <if test="null != onSaleTime">
                ONSALE_TIME = #{onSaleTime},
            </if>
            <if test="null != brandId">
                BRAND_ID = #{brandId},
            </if>
            <if test="null != isColorPackage">
                IS_COLOR_PACKAGE = #{isColorPackage},
            </if>
            <if test="null != isColorful">
                IS_COLORFUL = #{isColorful},
            </if>
        </set>
        WHERE ID = #{id}
    </update>

    <select id="findGoodsListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.vo.GoodsVO">
        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            g.category_id,
            g.brand_id,
            g.type_id
        FROM
            app_customer c
            INNER JOIN goods_price p ON c.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
        WHERE
            c.id = #{userId}
            AND gc.parent_code = #{categoryCode}
    </select>

    <select id="findGoodsListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.vo.GoodsVO">
        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            g.category_id,
            g.brand_id,
            g.type_id
        FROM
            app_employee e
            INNER JOIN goods_price p ON e.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
        WHERE e.id = #{userId}
              AND gc.parent_code = #{categoryCode}
    </select>

    <select id="findGoodsCategoryListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            gc.id category_id,
            gc.category_name
        FROM
            app_customer c
            INNER JOIN goods_price p ON c.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
        WHERE
            c.id = #{userId}
            AND gc.parent_code = #{categoryCode}
        ORDER BY gc.sort_id
    </select>

    <select id="findGoodsCategoryListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            gc.id category_id,
            gc.category_name
        FROM
            app_employee e
            INNER JOIN goods_price p ON e.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
        WHERE
            e.id = #{userId}
            AND gc.parent_code = #{categoryCode}
        ORDER BY gc.sort_id
    </select>

    <select id="findGoodsBrandListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsBrandResponse">
        SELECT
            DISTINCT
            g.brand_id,
            g.brand_name
        FROM
            app_customer c
            INNER JOIN goods_price p ON c.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_brand b ON g.brand_id = b.id
        WHERE
            c.id = #{userId}
            AND gc.parent_code = #{categoryCode}
        ORDER BY b.sort_id
    </select>

    <select id="findGoodsBrandListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            g.brand_id,
            g.brand_name
        FROM
            app_employee e
            INNER JOIN goods_price p ON e.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_brand b ON g.brand_id = b.id
        WHERE
            e.id = #{userId}
            AND gc.parent_code = #{categoryCode}
        ORDER BY b.sort_id
    </select>

    <select id="findGoodsTypeListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsTypeResponse">
        SELECT
            DISTINCT
            t.id type_id,
            t.type_name
        FROM
            app_customer c
            INNER JOIN goods_price p ON c.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_type t ON g.type_id = t.id
        WHERE
            c.id = #{userId}
            AND gc.parent_code = #{categoryCode}
        ORDER BY t.sort_id
    </select>

    <select id="findGoodsTypeListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            t.id type_id,
            t.type_name
        FROM
            app_employee e
            INNER JOIN goods_price p ON e.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_type t ON g.type_id = t.id
        WHERE
            e.id = #{userId}
            AND gc.parent_code = #{categoryCode}
        ORDER BY t.sort_id
    </select>

    <select id="findGoodsListByIsHotAndCustomerIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            gc.category_code,
            b.brand_code,
            t.type_code
        FROM
            app_customer c
            INNER JOIN goods_price p ON c.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_type t ON g.type_id = t.id
            INNER JOIN goods_brand b ON g.brand_id = b.id
        WHERE
            c.id = #{userId}
            AND g.is_hot = 1
    </select>

    <select id="findGoodsListByIsHotAndEmployeeIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            gc.category_code,
            b.brand_code,
            t.type_code
        FROM
            app_employee e
            INNER JOIN goods_price p ON e.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_type t ON g.type_id = t.id
            INNER JOIN goods_brand b ON g.brand_id = b.id
        WHERE
            e.id = #{userId}
            AND g.is_hot = 1
    </select>

    <select id="findGoodsCollectListByCustomerIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            gc.category_code,
            b.brand_code,
            t.type_code
        FROM
            app_customer c
            INNER JOIN app_customer_collect acc ON acc.CUSTOMER_ID = c.id
            INNER JOIN goods g ON g.id = acc.GOODS_ID
            INNER JOIN goods_price p ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_brand b ON b.id = g.brand_id
            INNER JOIN goods_type t ON t.id = g.type_id
        WHERE
            c.id = #{userId}
    </select>

    <select id="findGoodsCollectListByEmployeeIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            gc.category_code,
            b.brand_code,
            t.type_code
        FROM
            app_employee e
            INNER JOIN app_employee_collect aec ON aec.EMPLOYEE_ID = e.id
            INNER JOIN goods g ON g.id = aec.GOODS_ID
            INNER JOIN goods_price p ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_brand b ON b.id = g.brand_id
            INNER JOIN goods_type t ON t.id = g.type_id
        WHERE
            e.id = #{userId}
    </select>

    <select id="findGoodsOftenListByCustomerIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">

        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            gc.category_code,
            b.brand_code,
            t.type_code
        FROM
            app_customer c
            INNER JOIN app_customer_goods acg ON acg.CUSTOMER_ID = c.id
            INNER JOIN goods g ON g.id = acg.GOODS_ID
            INNER JOIN goods_price p ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_brand b ON b.id = g.brand_id
            INNER JOIN goods_type t ON t.id = g.type_id
        WHERE
            c.id = #{userId}
    </select>

    <select id="findGoodsOftenListByEmployeeIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">

        SELECT
            g.cover_image_uri,
            g.goods_name goods_name,
            g.id,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            gc.category_code,
            b.brand_code,
            t.type_code
        FROM
            app_employee e
            INNER JOIN app_employee_goods aeg ON aeg.EMPLOYEE_ID = e.id
            INNER JOIN goods g ON g.id = aeg.GOODS_ID
            INNER JOIN goods_price p ON p.goods_id = g.id
            INNER JOIN goods_category gc ON g.category_id = gc.id
            INNER JOIN goods_brand b ON b.id = g.brand_id
            INNER JOIN goods_type t ON t.id = g.type_id
        WHERE
            e.id = #{userId}
    </select>

    <select id="findGoodsImageUriByGoodsCode" resultType="cn.com.leyizhuang.app.foundation.pojo.GoodsDO">
        SELECT
            COVER_IMAGE_URI,
            ROTATION_IMAGE_URI
        FROM
            goods
        WHERE
            goods_code = #{goodsCode}
    </select>

    <select id="searchByCustomerIdAndKeywords" resultType="UserGoodsResponse">
        SELECT
            g.id,
            g.goods_name goods_name,
            g.cover_image_uri,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            g.category_id,
            g.brand_id,
            g.type_id
        FROM
            app_customer c
            INNER JOIN goods_price p ON c.store_id = p.store_id
            INNER JOIN goods g ON p.goods_id = g.id
        WHERE
            c.id = #{userId}
            AND (
                g.goods_name LIKE concat('%',#{keywords},'%')
                OR g.goods_code LIKE concat('%',#{keywords},'%')
            )
    </select>

    <select id="searchByEmployeeIdAndKeywords" resultType="UserGoodsResponse">
        SELECT
            g.id,
            g.goods_name goods_name,
            g.cover_image_uri,
            g.goods_specification,
            g.goods_unit,
            p.member_price,
            p.retail_price,
            g.category_id,
            g.brand_id,
            g.type_id
        FROM
            app_employee e
        INNER JOIN goods_price p ON e.store_id = p.store_id
        INNER JOIN goods g ON p.goods_id = g.id
        WHERE
            e.id = #{userId}
        AND (
            g.goods_name LIKE concat('%',#{keywords},'%')
            OR g.goods_code LIKE concat('%',#{keywords},'%')
        )
    </select>

    <insert id="saveCollectGoodsByCustomerIdAndGoodsId">
        INSERT INTO app_customer_collect(
            CUSTOMER_ID, GOODS_ID)
        SELECT #{userId},#{goodsId}
        FROM dual
        WHERE NOT EXISTS (
          SELECT 'X'
          FROM app_customer_collect acc
          WHERE acc.CUSTOMER_ID = #{userId}
          AND acc.GOODS_ID = #{goodsId}
        )
    </insert>

    <insert id="saveCollectGoodsByEmployeeIdAndGoodsId">
        INSERT INTO app_employee_collect(
            EMPLOYEE_ID, GOODS_ID)
        SELECT #{userId},#{goodsId}
        FROM dual
        WHERE NOT EXISTS (
            SELECT 'X'
            FROM app_employee_collect aec
            WHERE aec.EMPLOYEE_ID = #{userId}
            AND aec.GOODS_ID = #{goodsId}
        )
    </insert>

    <delete id="deleteCollectGoodsByCustomerIdAndGoodsId">
        DELETE FROM app_customer_collect
        WHERE CUSTOMER_ID = #{userId}
        AND GOODS_ID = #{goodsId}
    </delete>

    <delete id="deleteCollectGoodsByEmployeeIdAndGoodsId">
        DELETE FROM app_employee_collect
        WHERE EMPLOYEE_ID = #{userId}
        AND GOODS_ID = #{goodsId}
    </delete>
</mapper>