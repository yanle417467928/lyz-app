<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.GoodsDAO">
    <resultMap id="goodsResult" type="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        <id column="gid" property="gid" jdbcType="BIGINT"/>
        <result column="create_time" property="createTime"/>
        <result column="brd_id" property="brdId"/>
        <result column="brand_name" property="brandName"/>
        <result column="cid" property="cid"/>
        <result column="category_name" property="categoryName"/>
        <result column="gtid" property="gtid"/>
        <result column="type_name" property="typeName"/>
        <result column="sku" property="sku"/>
        <result column="sku_name" property="skuName"/>
        <result column="cover_image_uri" property="coverImageUri"/>
        <result column="rotation_image_uri" property="rotationImageUri"/>
        <result column="goods_specification" property="goodsSpecification"/>
        <result column="goods_unit" property="goodsUnit"/>
        <result column="is_index_recommend" property="isIndexRecommend"/>
        <result column="is_hot" property="isHot"/>
        <result column="is_new" property="isNew"/>
        <result column="is_color_mixing" property="isColorMixing"/>
        <result column="sort_id" property="sortId"/>
        <result column="company_flag" property="companyFlag"/>
        <result column="materials_code" property="materialsCode"/>
        <result column="physical_classify" property="physicalClassify"/>
        <result column="materials_enable" property="materialsEnable"/>
        <result column="goods_detail" property="goodsDetial"/>
        <result column="search_keyword" property="searchKeyword"/>
        <result column="product_grade" property="productGrade"/>
        <result column="materials_name" property="materialsName"/>
    </resultMap>

    <select id="queryList" resultMap="goodsResult">
        SELECT *
        FROM gds_goods
        ORDER BY gid DESC
    </select>

    <select id="queryById" parameterType="java.lang.Long" resultMap="goodsResult">
        SELECT *
        FROM gds_goods
        WHERE gid = #{gid}
    </select>

    <select id="queryBySku" parameterType="java.lang.String" resultMap="goodsResult">
        SELECT *
        FROM gds_goods
        WHERE sku = #{sku}
    </select>

    <insert id="saveSynchronize" parameterType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        INSERT INTO gds_goods
        (create_time, brd_id, brand_name, cid, category_name, gtid, type_name, sku, sku_name, cover_image_uri,
         rotation_image_uri, goods_specification, goods_unit, is_index_recommend, is_hot, is_new, is_color_mixing,
         sort_id, company_flag, materials_code, physical_classify, materials_enable, goods_detail, search_keyword,
         product_grade, materials_name)
        VALUES
            (#{createTime}, #{brdId}, #{brdName}, #{cId}, #{categoryName}, #{gtid}, #{typeName}, #{sku}, #{skuName},
                            #{coverImageUri}, #{rotationImageUri}, #{goodsSpecification}, #{goodsUnit},
                                                                   #{isIndexRecommend}, #{isHot},
                                                                   #{isNew}, #{isColorMixing}, #{sortId},
                                                                   #{companyFlag}, #{materialsCode},
                                                                   #{goodsPhysicalClassify}, #{materialsEnable},
             #{goodsDetial}, #{searchKeyword}, #{productGrade}, #{materialsName})
    </insert>


    <update id="modifySynchronize" parameterType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        UPDATE gds_goods
        <set>
            <if test="null != createTime">
                create_time = #{createTime},
            </if>
            <if test="null != brdId">
                brd_id = #{brdId},
            </if>
            <if test="null != brdName">
                brand_name = #{brdName},
            </if>
            <if test="null != cId">
                cid = #{cId},
            </if>
            <if test="null != categoryName">
                category_name = #{categoryName},
            </if>
            <if test="null != gtid">
                gtid = #{gtid},
            </if>
            <if test="null != skuName">
                sku_name = #{skuName},
            </if>
            <if test="null != coverImageUri">
                coverImageUri = #{coverImageUri},
            </if>
            <if test="null != rotationImageUri">
                rotation_image_uri = #{rotationImageUri},
            </if>
            <if test="null != goodsSpecification">
                goods_specification = #{goodsSpecification},
            </if>
            <if test="null != goodsUnit">
                goods_unit = #{goodsUnit},
            </if>
            <if test="null != isIndexRecommend">
                is_index_recommend = #{isIndexRecommend},
            </if>
            <if test="null != isHot">
                is_hot = #{isHot},
            </if>
            <if test="null != isNew">
                is_new = #{isNew},
            </if>
            <if test="null != isColorMixing">
                is_color_mixing = #{isColorMixing},
            </if>
            <if test="null != sortId">
                sort_id = #{sortId},
            </if>
            <if test="null != companyFlag">
                company_flag = #{companyFlag},
            </if>
            <if test="null != materialsCode">
                materials_code = #{materialsCode},
            </if>
            <if test="null != goodsPhysicalClassify">
                physical_classify = #{goodsPhysicalClassify},
            </if>
            <if test="null != materialsEnable">
                materials_enable = #{materialsEnable},
            </if>
            <if test="null != goodsDetial">
                goods_detail = #{goodsDetial},
            </if>
            <if test="null != searchKeyword">
                search_keyword = #{searchKeyword},
            </if>
            <if test="null != productGrade">
                product_grade = #{productGrade},
            </if>
            <if test="null != materialsName">
                materials_name = #{materialsName},
            </if>
        </set>
        WHERE sku = #{sku}
    </update>

    <delete id="deleteSynchronize" parameterType="java.lang.String">
        DELETE FROM gds_goods
        WHERE sku = #{sku}
    </delete>

    <delete id="batchRemove" parameterType="java.util.List">
        DELETE FROM gds_goods WHERE gid IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <update id="modify" parameterType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        UPDATE gds_goods
        <set>
            <if test="null != brdId">
                brd_id = #{brdId},
            </if>
            <if test="null != brandName">
                brand_name = #{brandName},
            </if>
            <if test="null != cid">
                cid = #{cid},
            </if>
            <if test="null != categoryName">
                category_name = #{categoryName},
            </if>
            <if test="null != gtid">
                gtid = #{gtid},
            </if>
            <if test="null != typeName">
                type_name = #{typeName},
            </if>
            <if test="null != sku">
                sku = #{sku},
            </if>
            <if test="null != skuName">
                sku_name = #{skuName},
            </if>
            <if test="null != coverImageUri">
                COVER_IMAGE_URI = #{coverImageUri},
            </if>
            <if test="null != rotationImageUri">
                rotation_image_uri = #{rotationImageUri},
            </if>
            <if test="null != goodsSpecification">
                goods_specification = #{goodsSpecification},
            </if>
            <if test="null != goodsUnit">
                goods_unit = #{goodsUnit},
            </if>
            <if test="null != isIndexRecommend">
                is_index_recommend = #{isIndexRecommend},
            </if>
            <if test="null != isHot">
                is_hot = #{isHot},
            </if>
            <if test="null != isNew">
                is_new = #{isNew},
            </if>
            <if test="null != isColorMixing">
                is_color_mixing = #{isColorMixing},
            </if>
            <if test="null != createTime">
                create_time = #{createTime},
            </if>
            <if test="null != sortId">
                sort_id = #{sortId},
            </if>
        </set>
        WHERE ID = #{id}
    </update>
    <select id="findGoodsListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid      id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
    </select>

    <select id="findGoodsListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid      id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE e.emp_id = #{userId}
              AND gc.p_category_code = #{categoryCode}
              AND p.price_type = 'COMMON'
    </select>

    <select id="findGoodsCategoryListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            gc.cid category_id,
            gc.category_name
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
        ORDER BY gc.sort_id
    </select>

    <select id="findGoodsCategoryListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            gc.cid category_id,
            gc.category_name
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
            e.emp_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
        ORDER BY gc.sort_id
    </select>

    <select id="findGoodsBrandListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsBrandResponse">
        SELECT
            DISTINCT
            g.brd_id     brand_id,
            g.brand_name brand_name
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_brand b ON g.brd_id = b.brd_id
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
        ORDER BY b.sort_id
    </select>

    <select id="findGoodsBrandListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsBrandResponse">
        SELECT
            DISTINCT
            g.brd_id     brand_id,
            g.brand_name brand_name
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_brand b ON g.brd_id = b.brd_id
        WHERE
            e.emp_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
        ORDER BY b.sort_id
    </select>

    <select id="findGoodsTypeListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsTypeResponse">
        SELECT
            DISTINCT
            t.gtid type_id,
            t.type_name
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_type t ON g.gtid = t.gtid
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
        ORDER BY t.sort_id
    </select>

    <select id="findGoodsTypeListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsTypeResponse">
        SELECT
            DISTINCT
            t.gtid type_id,
            t.type_name
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_type t ON g.gtid = t.gtid
        WHERE
            e.emp_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
            AND p.price_type = 'COMMON'
        ORDER BY t.sort_id
    </select>

    <select id="findGoodsListByIsHotAndCustomerIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid      id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id,
            m.qty      materialQty
        FROM
            cus_customer c
            LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
            LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
                AND p.start_time &lt; NOW()
                AND (p.end_time IS NULL OR p.end_time &gt; NOW())
                AND (rc.rank_code = p.price_type
                OR p.price_type = 'COMMON')
            INNER JOIN gds_goods g ON p.gid = g.gid
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId}
        WHERE
            c.cus_id = #{userId}
            AND g.is_hot = 1
    </select>

    <select id="findGoodsListByIsHotAndEmployeeIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid      id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id,
            m.qty      materialQty
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId} AND m.identity_type = e.identity_type
        WHERE
            e.emp_id = #{userId}
            AND g.is_hot = 1
            AND p.price_type = 'COMMON'
    </select>

    <select id="findGoodsCollectListByUserIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">

        <if test="null != type and type.toString() == 'CUSTOMER'">
            SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id,
            m.qty materialQty
            FROM
            gds_goods_collect acc
            INNER JOIN cus_customer c ON c.cus_id = acc.user_id
            INNER JOIN gds_goods g ON g.gid = acc.gid
            INNER JOIN gds_goods_price p ON p.gid = g.gid AND c.store_id = p.store_id
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId}
            AND p.start_time &lt; NOW()
            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            WHERE
            acc.user_id = #{userId}
            AND acc.identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppIdentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        </if>

        <if test="null != type and type.toString() != 'CUSTOMER'">
            SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id,
            m.qty materialQty
            FROM
            gds_goods_collect acc
            INNER JOIN emp_employee e ON e.emp_id = acc.user_id
            INNER JOIN gds_goods g ON g.gid = acc.gid
            INNER JOIN gds_goods_price p ON p.gid = g.gid AND e.store_id = p.store_id
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId} AND m.identity_type = e.identity_type
            AND p.start_time &lt; NOW()
            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            WHERE
            acc.user_id = #{userId}
            AND acc.identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppIdentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        </if>

    </select>

    <select id="findGoodsOftenListByUserIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">

        SELECT
            DISTINCT
            g.gid      id,
            g.cover_image_uri,
            g.sku_name goods_name,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id,
            m.qty      materialQty
        FROM
            gds_goods_often_buy acg
            INNER JOIN gds_goods g ON g.gid = acg.gid
            LEFT JOIN cus_customer c ON c.cus_id = acg.user_id
            LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
            LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
            INNER JOIN gds_goods_price p ON p.gid = g.gid
                AND p.start_time &lt; NOW()
                AND (p.end_time IS NULL OR p.end_time &gt; NOW())
                AND (rc.rank_code = p.price_type
                OR p.price_type = 'COMMON')
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId} AND m.identity_type = acg.identity_type
        WHERE
            acg.user_id = #{userId}
            AND acg.identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppIdentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    </select>

    <select id="findGoodsImageUriByGoodsId" resultType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        SELECT
            COVER_IMAGE_URI,
            ROTATION_IMAGE_URI,
            goods_detail goodsDetial
        FROM
            gds_goods
        WHERE
            gid = #{goodsId}
    </select>

    <select id="searchByCustomerIdAndKeywords" resultType="UserGoodsResponse">
        SELECT
            g.gid      id,
            g.sku_name goods_name,
            g.cover_image_uri,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id,
            m.qty      materialQty
        FROM
            cus_customer c
            LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
            LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
                AND p.start_time &lt; NOW()
                AND (p.end_time IS NULL OR p.end_time &gt; NOW())
                AND (rc.rank_code = p.price_type
                OR p.price_type = 'COMMON')
            INNER JOIN gds_goods g ON p.gid = g.gid
            LEFT JOIN material_list AS m ON m.gid = p.gid AND m.user_id = #{userId}
        WHERE
            c.cus_id = #{userId}
            AND (
                g.sku_name LIKE concat('%', #{keywords}, '%')
                OR g.sku LIKE concat('%', #{keywords}, '%')
            )
    </select>

    <select id="searchByEmployeeIdAndKeywords" resultType="UserGoodsResponse">
        SELECT
            g.gid      id,
            g.sku_name goods_name,
            g.cover_image_uri,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid      category_id,
            g.brd_id   brand_id,
            g.gtid     type_id,
            m.qty      materialQty
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
                                            AND p.start_time &lt; NOW()
                                            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            INNER JOIN gds_goods g ON p.gid = g.gid
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId} AND m.identity_type = e.identity_type
        WHERE
            e.emp_id = #{userId}
            AND (
                g.sku_name LIKE concat('%', #{keywords}, '%')
                OR g.sku LIKE concat('%', #{keywords}, '%')
            )
            AND p.price_type = 'COMMON'
    </select>

    <insert id="saveCollectGoodsByUserIdAndGoodsIdAndIdentityType">
        INSERT INTO gds_goods_collect (
            user_id, gid, identity_type)
            SELECT
                #{userId},
                #{goodsId},
                #{type,
    javaType=cn.com.leyizhuang.app.core.constant.AppIdentityType,
    typeHandler=org.apache.ibatis.type.EnumTypeHandler}
            FROM dual
            WHERE NOT EXISTS(
                    SELECT 'X'
                    FROM gds_goods_collect acc
                    WHERE acc.user_id = #{userId}
                          AND acc.gid = #{goodsId}
                          AND acc.identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppIdentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
            )
    </insert>

    <delete id="deleteCollectGoodsByUserIdAndGoodsIdAndIdentityType">
        DELETE FROM gds_goods_collect
        WHERE user_id = #{userId}
              AND gid = #{goodsId}
              AND identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppIdentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    </delete>

    <select id="findGoodsDetailByGoodsId"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsDetailResponse">
        <if test="null != type and type.toString() == 'CUSTOMER'">
            SELECT DISTINCT g.*, IF(gc.id IS NULL,FALSE,TRUE) isCollect, p.retail_price price FROM
            (SELECT cus_id, #{type} as identity_type, store_id FROM cus_customer WHERE cus_id = #{userId}) c
            LEFT JOIN (SELECT * FROM gds_goods_collect WHERE gid = #{goodsId} and user_id = #{userId} and identity_type
            = #{type}) gc on gc.user_id = c.cus_id and gc.identity_type = c.identity_type
            LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
            LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
            LEFT JOIN gds_goods_price p on p.store_id = c.store_id AND p.gid = #{goodsId} AND p.start_time &lt; NOW()
            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            AND (rc.rank_code = p.price_type OR p.price_type = 'COMMON'),
            (SELECT gid id, sku_name skuName, goods_specification goodsSpecification, goods_unit goodsUnit FROM
            gds_goods WHERE gid = #{goodsId}) g
            WHERE
            g.id = p.gid;
        </if>
        <if test="null != type and type.toString() != 'CUSTOMER'">
            SELECT DISTINCT g.*, IF(gc.id IS NULL,FALSE,TRUE) isCollect, p.retail_price price FROM
            (SELECT emp_id, identity_type, store_id FROM emp_employee WHERE emp_id = #{userId}) e
            LEFT JOIN (SELECT * FROM gds_goods_collect WHERE gid = #{goodsId} and user_id = #{userId} and identity_type
            = #{type}) gc on gc.user_id = e.emp_id and gc.identity_type = e.identity_type
            LEFT JOIN gds_goods_price p on p.store_id = e.store_id AND p.gid = #{goodsId} AND p.start_time &lt; NOW()
            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            AND p.price_type = 'COMMON',
            (SELECT gid id, sku_name skuName, goods_specification goodsSpecification, goods_unit goodsUnit FROM
            gds_goods WHERE gid = #{goodsId}) g
            WHERE
            g.id = p.gid;
        </if>
    </select>

    <select id="findGoodsById" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        SELECT
            gid,
            sku,
            sku_name,
            cover_image_uri,
            goods_specification,
            goods_unit,
            brd_id,
            company_flag
        FROM gds_goods
        WHERE gid = #{gid}
    </select>

    <select id="findGoodsPriceByProductCouponIdAndUserId" resultType="cn.com.leyizhuang.app.foundation.pojo.GoodsPrice">
        SELECT
            p.gid,
            p.retail_price,
            p.vip_price,
            p.wholesale_price
        FROM cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN cus_customer_product_coupon pcp ON pcp.cus_id = c.cus_id
        WHERE c.cus_id = #{cusId}
              AND pcp.id = #{pcId}
              AND p.start_time &lt; NOW()
              AND (p.end_time IS NULL OR p.end_time &gt; NOW())
              AND pcp.effective_start_time &lt; NOW()
              AND (pcp.effective_end_time IS NULL OR pcp.effective_end_time &gt; NOW())
              AND pcp.is_used = FALSE
              AND PCP.gid = P.gid
              AND pcp.quantity >= #{qty};
    </select>

    <select id="getGoodsPriceByCustomerAndGoodsId" resultType="cn.com.leyizhuang.app.foundation.pojo.GoodsPrice">
        SELECT p.gid, p.retail_price, p.vip_price, p.wholesale_price
        FROM cus_customer c
        LEFT JOIN gds_goods_price p ON c.store_id = p.store_id
        WHERE c.cus_id = #{userId}
        AND p.start_time &lt; NOW()
        AND (p.end_time IS NULL OR p.end_time &gt; NOW())
        AND p.gid IN
        <foreach collection="list" item="gid" open="(" close=")" separator=",">
            #{gid}
        </foreach>
    </select>

    <select id="getGoodsPriceByEmployeeAndGoodsId" resultType="cn.com.leyizhuang.app.foundation.pojo.GoodsPrice">
        SELECT p.gid, p.retail_price, p.vip_price, p.wholesale_price
        FROM emp_employee e
        LEFT JOIN gds_goods_price p ON e.store_id = p.store_id
        WHERE e.emp_id = #{userId}
        AND p.start_time &lt; NOW()
        AND (p.end_time IS NULL OR p.end_time &gt; NOW())
        AND p.gid IN
        <foreach collection="list" item="gid" index="index" open="(" close=")" separator=",">
            #{gid}
        </foreach>
    </select>

    <select id="findGoodsListByEmployeeIdAndGoodsIdList"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.OrderGoodsSimpleResponse">
        SELECT
        g.gid id,
        g.sku,
        g.sku_name goods_name,
        g.cover_image_uri,
        g.goods_specification,
        g.goods_unit,
        p.vip_price,
        p.retail_price,
        g.cid category_id,
        g.brd_id brand_id,
        g.gtid type_id,
        g.company_flag
        FROM
        emp_employee e
        INNER JOIN gds_goods_price p ON e.store_id = p.store_id
        AND p.start_time &lt; NOW()
        AND (p.end_time IS NULL OR p.end_time &gt; NOW())
        AND p.price_type = 'COMMON'
        INNER JOIN gds_goods g ON p.gid = g.gid
        WHERE
        e.emp_id = #{userId}
        AND p.gid IN
        <foreach collection="list" item="gid" index="index" open="(" close=")" separator=",">
            #{gid}
        </foreach>

    </select>
    <select id="findGoodsListByCustomerIdAndGoodsIdList"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.OrderGoodsSimpleResponse">
        SELECT
        g.gid id,
        g.sku_name goods_name,
        g.sku sku,
        g.cover_image_uri,
        g.goods_specification,
        g.goods_unit,
        p.vip_price,
        p.retail_price,
        g.cid category_id,
        g.brd_id brand_id,
        g.gtid type_id,
        g.company_flag
        FROM
        cus_customer c
        LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
        LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
        INNER JOIN gds_goods_price p ON c.store_id = p.store_id
        AND p.start_time &lt; NOW()
        AND (p.end_time IS NULL OR p.end_time &gt; NOW())
        AND (rc.rank_code = p.price_type OR p.price_type = 'COMMON')
        INNER JOIN gds_goods g ON p.gid = g.gid
        WHERE
        c.cus_id = #{userId}
        AND p.gid IN
        <foreach collection="list" item="gid" index="index" open="(" close=")" separator=",">
            #{gid}
        </foreach>

    </select>

    <select id="filterGoodsCustomer" resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
        g.cover_image_uri,
        g.sku_name goods_name,
        g.gid id,
        g.goods_specification,
        g.goods_unit,
        p.vip_price,
        p.retail_price,
        g.cid category_id,
        g.brd_id brand_id,
        g.gtid type_id,
        m.qty materialQty
        FROM
        cus_customer c
        INNER JOIN gds_goods_price p ON c.store_id = p.store_id AND p.start_time &lt; NOW()
        AND (p.end_time IS NULL OR p.end_time &gt; NOW())
        LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId}
        INNER JOIN gds_goods g ON p.gid = g.gid
        INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
        c.cus_id = #{userId}
        <if test="null != firstCategoryCode ">
            AND gc.p_category_code = #{firstCategoryCode}
        </if>
        <if test="null != secondCategoryId ">
            AND g.cid = #{secondCategoryId}
        </if>
        <if test="null != brandId ">
            AND g.brd_id = #{brandId}
        </if>
        <if test="null != typeId ">
            AND g.gtid = #{typeId}
        </if>
        <if test="null != specification and specification != ''">
            AND g.goods_specification = #{specification}
        </if>
        AND p.price_type = 'COMMON'
    </select>

    <select id="filterGoodsEmployee" resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
        g.cover_image_uri,
        g.sku_name goods_name,
        g.gid id,
        g.goods_specification,
        g.goods_unit,
        p.vip_price,
        p.retail_price,
        g.cid category_id,
        g.brd_id brand_id,
        g.gtid type_id,
        m.qty materialQty
        FROM
        emp_employee e
        INNER JOIN gds_goods_price p ON e.store_id = p.store_id
        LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId} AND m.identity_type = e.identity_type
        AND p.start_time &lt; NOW()
        AND (p.end_time IS NULL OR p.end_time &gt; NOW())
        INNER JOIN gds_goods g ON p.gid = g.gid
        INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
        e.emp_id = #{userId}
        <if test="null != firstCategoryCode ">
            AND gc.p_category_code = #{firstCategoryCode}
        </if>
        <if test="null != secondCategoryId ">
            AND g.cid = #{secondCategoryId}
        </if>
        <if test="null != brandId ">
            AND g.brd_id = #{brandId}
        </if>
        <if test="null != typeId ">
            AND g.gtid = #{typeId}
        </if>
        <if test="null != specification and specification != ''">
            AND g.goods_specification = #{specification}
        </if>
        AND p.price_type = 'COMMON'
    </select>

    <select id="existGoodsBrandByGoodsIdAndBrandName" resultType="java.lang.Boolean">
        SELECT EXISTS(
                SELECT 'X'
                FROM gds_goods
                WHERE gid = #{gId} AND brand_name LIKE concat('%', #{brandName}, '%'))
    </select>

    <select id="findCompanyFlagListById" resultType="java.lang.String">
        SELECT DISTINCT company_flag FROM gds_goods WHERE gid in
        <foreach collection="list" item="type" separator="," open="(" close=")">
            #{type}
        </foreach>
    </select>

    <select id="findOrderGoodsVOListByCustomerIdAndGoodsIds"
            resultType="cn.com.leyizhuang.app.foundation.vo.OrderGoodsVO">
        SELECT
        g.gid,
        g.sku,
        g.sku_name,
        g.cover_image_uri,
        gp.retail_price,
        gp.vip_price,
        gp.wholesale_price,
        g.company_flag,
        gp.price_line_id price_item_id
        FROM cus_customer c
        LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
        LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
        INNER JOIN gds_goods_price gp ON c.store_id = gp.store_id
        AND (rc.rank_code = gp.price_type
        OR gp.price_type = 'COMMON')
        INNER JOIN gds_goods g ON gp.gid = g.gid
        where c.cus_id = #{userId}
        AND gp.start_time &lt; NOW()
        AND (gp.end_time IS NULL OR gp.end_time &gt; NOW())
        AND g.gid in
        <foreach collection="goodsIdSet" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </select>

    <select id="screenGoodsGrid" resultType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        SELECT
        *
        FROM
        gds_goods g
        WHERE
        1=1
        <if test="null != brandCode ">
            AND g.brd_id = #{brandCode}
        </if>
        <if test="null != categoryCode ">
            AND g.physical_classify = #{categoryCode}
        </if>
        <if test="null != companyCode ">
            AND g.company_flag = #{companyCode}
        </if>
    </select>

    <select id="queryGoodsPageByInfo" resultType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        SELECT
        *
        FROM
        gds_goods g
        WHERE
        1=1
        <if test="null != queryGoodsInfo">
            AND
            (g.sku LIKE CONCAT('%' ,#{queryGoodsInfo},'%') OR g.sku_name LIKE CONCAT('%' ,#{queryGoodsInfo},'%'))
        </if>
    </select>


    <update id="updateGoods" parameterType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        UPDATE gds_goods
        <set>
            <if test="null != cid">
                cid = #{cid},
            </if>
            <if test="null != categoryName">
                category_name = #{categoryName},
            </if>
            <if test="null != skuName">
                sku_name = #{skuName},
            </if>
            <if test="null != coverImageUri">
                cover_image_uri = #{coverImageUri},
            </if>
            <if test="null != rotationImageUri">
                rotation_image_uri = #{rotationImageUri},
            </if>

            <if test="null != isIndexRecommend">
                is_index_recommend = #{isIndexRecommend},
            </if>
            <if test="null != isHot">
                is_hot = #{isHot},
            </if>
            <if test="null != isColorMixing">
                is_color_mixing = #{isColorMixing},
            </if>
            <if test="null != sortId">
                sort_id = #{sortId},
            </if>
            <if test="null != goodsDetial">
                goods_detail = #{goodsDetial},
            </if>
            <if test="null != searchKeyword">
                search_keyword = #{searchKeyword},
            </if>
            <if test="null != productGrade">
                product_grade = #{productGrade},
            </if>
        </set>
        WHERE sku = #{sku}
    </update>


    <select id="findOrderGoodsVOListByEmpIdAndGoodsIds" resultType="cn.com.leyizhuang.app.foundation.vo.OrderGoodsVO">
        SELECT
        g.gid,
        g.sku,
        g.sku_name,
        gp.retail_price,
        gp.vip_price,
        gp.wholesale_price,
        g.company_flag,
        g.cover_image_uri,
        gp.price_line_id price_item_id
        FROM emp_employee e
        INNER JOIN gds_goods_price gp ON e.store_id = gp.store_id
        AND gp.price_type = 'COMMON'
        INNER JOIN gds_goods g ON gp.gid = g.gid
        where e.emp_id = #{userId}
        AND gp.start_time &lt; NOW()
        AND (gp.end_time IS NULL OR gp.end_time &gt; NOW())
        AND g.gid in
        <foreach collection="goodsIdSet" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </select>


    <select id="isExistSkuName" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM gds_goods
                      WHERE sku_name = #{skuName}
                            AND gid != #{id}
        )
    </select>


    <select id="isExistSortId" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM gds_goods
                      WHERE sort_id = #{sortId}
                            AND gid != #{id}
        )
    </select>

    <select id="findMaStoreGoodsByStoreId"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.MaBuyProductCouponGoodsResponse">
        SELECT
            gg.gid,
            gg.sku,
            gg.sku_name,
            gg.goods_specification,
            gg.brand_name,
            gg.type_name,
            gg.company_flag,
            ggp.retail_price,
            ggp.vip_price
        FROM
            gds_goods AS gg
            INNER JOIN gds_goods_price AS ggp ON gg.gid = ggp.gid
        WHERE
            ggp.store_id = #{storeId}
        ORDER BY gid DESC
    </select>

    <select id="screenMaGoodsGrid"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.MaBuyProductCouponGoodsResponse">
        SELECT
        gg.gid,
        gg.sku,
        gg.sku_name,
        gg.goods_specification,
        gg.brand_name,
        gg.type_name,
        gg.company_flag,
        ggp.retail_price,
        ggp.vip_price
        FROM
        gds_goods AS gg
        INNER JOIN gds_goods_price AS ggp ON gg.gid = ggp.gid
        WHERE
        ggp.store_id = #{storeId}
        <if test="null != brandCode and -1 != brandCode">
            AND gg.brd_id = #{brandCode}
        </if>
        <if test="null != categoryCode and -1 != categoryCode">
            AND gg.physical_classify = #{categoryCode}
        </if>
        <if test="null != companyCode and -1 != companyCode">
            AND gg.company_flag = #{companyCode}
        </if>
        ORDER BY gid DESC
    </select>

    <select id="queryGoodsPageByStoreIdAndInfo"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.MaBuyProductCouponGoodsResponse">
        SELECT
        gg.gid,
        gg.sku,
        gg.sku_name,
        gg.goods_specification,
        gg.brand_name,
        gg.type_name,
        gg.company_flag,
        ggp.retail_price,
        ggp.vip_price
        FROM
        gds_goods AS gg
        INNER JOIN gds_goods_price AS ggp ON gg.gid = ggp.gid
        WHERE
        ggp.store_id = #{storeId}
        <if test="null != queryGoodsInfo">
            AND (gg.sku LIKE CONCAT('%' ,#{queryGoodsInfo},'%') OR gg.sku_name LIKE CONCAT('%' ,#{queryGoodsInfo},'%'))
        </if>
    </select>


    <select id="findGoodsListByCustomerIdAndIdentityTypeAndUserRank"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        <if test="null != identityType and identityType.toString() == 'CUSTOMER'">
            SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id,
            m.qty materialQty
            FROM
            cus_customer c
            LEFT JOIN cus_rank cr ON cr.cus_id = c.cus_id
            LEFT JOIN rank_classification rc ON cr.rank_id = rc.rank_id
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            AND rc.rank_code = p.price_type
            AND p.start_time &lt; NOW()
            AND (p.end_time IS NULL OR p.end_time &gt; NOW())
            LEFT JOIN material_list m ON m.gid = p.gid AND m.user_id = #{userId}
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            WHERE
            c.cus_id = #{userId}
        </if>
    </select>

    <select id="getGoodsBykeywordsAndCompanyAndBrandCodeAndCategoryCodeAndStoreId" resultType="cn.com.leyizhuang.app.foundation.pojo.goods.GoodsDO">
        SELECT
        g.*
        FROM
        gds_goods g
        RIGHT JOIN st_inventory st ON g.sku = st.sku
        WHERE
        st.store_id = #{storeId} and st.available_ity > 0
        <if test="null != brandCode ">
            AND g.brd_id = #{brandCode}
        </if>
        <if test="null != categoryCode ">
            AND g.physical_classify = #{categoryCode}
        </if>
        <if test="null != companyCode ">
            AND g.company_flag = #{companyCode}
        </if>
        <if test="keywords != null">
            AND  (g.sku_name LIKE concat('%', #{keywords}, '%')
            OR g.sku LIKE concat('%', #{keywords}, '%'))
        </if>
    </select>

</mapper>