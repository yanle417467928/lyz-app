<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.GoodsDAO">
    <resultMap id="goodsResult" type="cn.com.leyizhuang.app.foundation.pojo.GoodsDO">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="CREATOR_ID" property="creatorId"/>
        <result column="CREATOR_TYPE" property="creatorType"/>
        <result column="CREATE_TIME" property="createTime"/>
        <result column="MODIFIER_ID" property="modifierId"/>
        <result column="MODIFIER_TYPE" property="modifierType"/>
        <result column="MODIFY_TIME" property="modifyTime"/>
        <result column="GOODS_NAME" property="goodsName"/>
        <result column="GOODS_CODE" property="goodsCode"/>
        <result column="IS_GIFT" property="isGift"/>
        <result column="TITLE" property="title"/>
        <result column="SUB_TITLE" property="subTitle"/>
        <result column="COVER_IMAGE_URI" property="coverImageUri"/>
        <result column="ROTATION_IMAGE_URI" property="rotationImageUri"/>
        <result column="DETAIL" property="detail"/>
        <result column="IS_ON_SALE" property="isOnSale"/>
        <result column="IS_RECOMMEND_INDEX" property="isRecommendIndex"/>
        <result column="IS_RECOMMEND_TYPE" property="isRecommendType"/>
        <result column="IS_HOT" property="isHot"/>
        <result column="IS_NEW" property="isNew"/>
        <result column="IS_SPECIAL_PRICE" property="isSpecialPrice"/>
        <result column="CATEGORY_ID" property="categoryId"/>
        <result column="CATEGORY_TITLE" property="categoryTitle"/>
        <result column="CATEGORY_ID_TREE" property="categoryIdTree"/>
        <result column="MARKET_PRICE" property="marketPrice"/>
        <result column="SALE_PRICE" property="salePrice"/>
        <result column="LEFT_NUMBER" property="leftNumber"/>
        <result column="PRICE_UNIT" property="priceUnit"/>
        <result column="ONSALE_TIME" property="onSaleTime"/>
        <result column="CREATE_TIME" property="createTime"/>
        <result column="SORT_ID" property="sortId"/>
        <result column="BRAND_TITLE" property="brandTitle"/>
        <result column="BRAND_ID" property="brandId"/>
        <result column="PRODUCT_FLAG" property="productFlag"/>
        <result column="RETURN_PRICE" property="returnPrice"/>
        <result column="IS_COLOR_PACKAGE" property="isColorPackage"/>
        <result column="IS_COLORFUL" property="isColorful"/>
        <result column="COLOR_PACKAGE_SKU" property="colorPackageSku"/>
        <result column="INVENTORY_ITEM_ID" property="inventoryItemId"/>
        <result column="INV_CATEGORY_ID" property="invCategoryId"/>
        <result column="ITEM_TYPE_NAME" property="itemTypeName"/>
        <result column="ITEM_TYPE_CODE" property="itemTypeCode"/>
        <result column="INVENTORY_ITEM_STATUS" property="inventoryItemStatus"/>
        <result column="ITEM_BARCODE" property="itemBarcode"/>
        <result column="UNIT_NAME" property="unitName"/>
    </resultMap>

    <select id="queryList" resultMap="goodsResult">
        SELECT *
        FROM gds_goods
        ORDER BY create_time DESC
    </select>

    <select id="queryById" parameterType="java.lang.Long" resultMap="goodsResult">
        SELECT *
        FROM gds_goods
        WHERE gid = #{gid}
    </select>

    <delete id="batchRemove" parameterType="java.util.List">
        DELETE FROM gds_goods WHERE gid IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <update id="modify" parameterType="cn.com.leyizhuang.app.foundation.pojo.GoodsDO">
        UPDATE gds_goods
        <set>
            <if test="null != brdId">
                brd_id = #{brdId},
            </if>
            <if test="null != brandName">
                brand_name = #{brandName},
            </if>
            <if test="null != cid">
                cid = #{cid},
            </if>
            <if test="null != categoryName">
                category_name = #{categoryName},
            </if>
            <if test="null != gtid">
                gtid = #{gtid},
            </if>
            <if test="null != typeName">
                type_name = #{typeName},
            </if>
            <if test="null != sku">
                sku = #{sku},
            </if>
            <if test="null != skuName">
                sku_name = #{skuName},
            </if>
            <if test="null != coverImageUri">
                COVER_IMAGE_URI = #{coverImageUri},
            </if>
            <if test="null != rotationImageUri">
                rotation_image_uri = #{rotationImageUri},
            </if>
            <if test="null != goodsSpecification">
                goods_specification = #{goodsSpecification},
            </if>
            <if test="null != goodsUnit">
                goods_unit = #{goodsUnit},
            </if>
            <if test="null != isIndexRecommend">
                is_index_recommend = #{isIndexRecommend},
            </if>
            <if test="null != isHot">
                is_hot = #{isHot},
            </if>
            <if test="null != isNew">
                is_new = #{isNew},
            </if>
            <if test="null != isColorMixing">
                is_color_mixing = #{isColorMixing},
            </if>
            <if test="null != createTime">
                create_time = #{createTime},
            </if>
            <if test="null != sortId">
                sort_id = #{sortId},
            </if>
        </set>
        WHERE ID = #{id}
    </update>

    <select id="findGoodsListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid id,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
    </select>

    <select id="findGoodsListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE e.emp_id = #{userId}
              AND gc.p_category_code = #{categoryCode}
    </select>

    <select id="findGoodsCategoryListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            gc.cid category_id,
            gc.category_name
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
        ORDER BY gc.sort_id
    </select>

    <select id="findGoodsCategoryListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            gc.cid category_id,
            gc.category_name
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
        WHERE
            e.emp_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
        ORDER BY gc.sort_id
    </select>

    <select id="findGoodsBrandListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsBrandResponse">
        SELECT
            DISTINCT
            g.brd_id brand_id,
            g.brand_name
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_brand b ON g.brd_id = b.brd_id
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
        ORDER BY b.sort_id
    </select>

    <select id="findGoodsBrandListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            g.brd_id brand_id,
            g.brand_name brand_name
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_brand b ON g.brd_id = b.brd_id
        WHERE
            e.emp_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
        ORDER BY b.sort_id
    </select>

    <select id="findGoodsTypeListByCategoryCodeAndCustomerIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsTypeResponse">
        SELECT
            DISTINCT
            t.gtid type_id,
            t.type_name
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_type t ON g.gtid = t.gtid
        WHERE
            c.cus_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
        ORDER BY t.sort_id
    </select>

    <select id="findGoodsTypeListByCategoryCodeAndEmployeeIdAndIdentityType"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.GoodsCategoryResponse">
        SELECT
            DISTINCT
            t.gtid type_id,
            t.type_name
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
            INNER JOIN gds_goods_category gc ON g.cid = gc.cid
            INNER JOIN gds_goods_type t ON g.gtid = t.gtid
        WHERE
            e.emp_id = #{userId}
            AND gc.p_category_code = #{categoryCode}
        ORDER BY t.sort_id
    </select>

    <select id="findGoodsListByIsHotAndCustomerIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid ,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
        WHERE
            c.cus_id = #{userId}
            AND g.is_hot = 1
    </select>

    <select id="findGoodsListByIsHotAndEmployeeIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id
        FROM
            emp_employee e
            INNER JOIN gds_goods_price p ON e.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
        WHERE
            e.emp_id = #{userId}
            AND g.is_hot = 1
    </select>

    <select id="findGoodsCollectListByUserIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">
        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id
        FROM
            gds_goods_collect acc
            INNER JOIN gds_goods g ON g.gid = acc.gid
            INNER JOIN gds_goods_price p ON p.gid = g.gid
        WHERE
            acc.user_id = #{userId}
        AND acc.identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppidentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    </select>

    <select id="findGoodsOftenListByUserIdAndIdentityType" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.UserGoodsResponse">

        SELECT
            g.cover_image_uri,
            g.sku_name goods_name,
            g.gid,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid category_id,
            g.brd_id brand_id,
            g.gtid type_id
        FROM
            gds_goods_often_buy acg
            INNER JOIN gds_goods g ON g.gid = acg.gid
            INNER JOIN gds_goods_price p ON p.gid = g.gid
        WHERE
            acg.user_id = #{userId}
        AND acg.identityType = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppidentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    </select>

    <select id="findGoodsImageUriByGoodsCode" resultType="cn.com.leyizhuang.app.foundation.pojo.GoodsDO">
        SELECT
            COVER_IMAGE_URI,
            ROTATION_IMAGE_URI
        FROM
            goods
        WHERE
            goods_code = #{goodsCode}
    </select>

    <select id="searchByCustomerIdAndKeywords" resultType="UserGoodsResponse">
        SELECT
            g.gid ,
            g.sku_name goods_name,
            g.cover_image_uri,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid second_category_code,
            g.brd_id goods_brand_code,
            g.gtid goods_type_code
        FROM
            cus_customer c
            INNER JOIN gds_goods_price p ON c.store_id = p.store_id
            INNER JOIN gds_goods g ON p.gid = g.gid
        WHERE
            c.cus_id = #{userId}
            AND (
                g.sku_name LIKE concat('%',#{keywords},'%')
                OR g.sku LIKE concat('%',#{keywords},'%')
            )
    </select>

    <select id="searchByEmployeeIdAndKeywords" resultType="UserGoodsResponse">
        SELECT
            g.gid ,
            g.sku_name goods_name,
            g.cover_image_uri,
            g.goods_specification,
            g.goods_unit,
            p.vip_price,
            p.retail_price,
            g.cid second_category_code,
            g.brd_id goods_brand_code,
            g.gtid goods_type_code
        FROM
            emp_employee e
        INNER JOIN gds_goods_price p ON e.store_id = p.store_id
        INNER JOIN gds_goods g ON p.gid = g.gid
        WHERE
            e.id = #{userId}
        AND (
            g.sku_name LIKE concat('%',#{keywords},'%')
            OR g.sku LIKE concat('%',#{keywords},'%')
        )
    </select>

    <insert id="saveCollectGoodsByUserIdAndGoodsIdAndIdentityType">
        INSERT INTO gds_goods_collect(
            user_id, gid,identity_type)
        SELECT #{userId},#{goodsId},#{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppidentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        FROM dual
        WHERE NOT EXISTS (
          SELECT 'X'
          FROM gds_goods_collect acc
          WHERE acc.user_id = #{userId}
          AND acc.gid = #{goodsId}
          AND acc.identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppidentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        )
    </insert>

    <delete id="deleteCollectGoodsByUserIdAndGoodsIdAndIdentityType">
        DELETE FROM gds_goods_collect
        WHERE user_id = #{userId}
        AND gid = #{goodsId}
        AND identity_type = #{type,
            javaType=cn.com.leyizhuang.app.core.constant.AppidentityType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    </delete>

</mapper>