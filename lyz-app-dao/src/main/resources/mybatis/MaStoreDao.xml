<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.MaStoreDAO">

    <resultMap id="storeDetailVOResultMap" type="StoreDetailVO">
        <id property="storeId" column="store_id" jdbcType="BIGINT"/>
        <result property="storeName" column="store_name"/>
        <result property="storeCode" column="store_code"/>
        <result property="storeType" column="store_type"/>
        <result property="enable" column="enable"/>
        <result property="creatorType" column="creator_type"/>
        <result property="createTime" column="create_time"/>
        <result property="modifierType" column="modifier_type"/>
        <result property="modifyTime" column="modify_time"/>
        <result property="phone" column="phone"/>
        <result property="isDefault" column="is_default"/>
        <result property="province" column="province"/>
        <result property="city" column="city"/>
        <result property="area" column="area"/>
        <result property="storeOrgId" column="store_org_id"/>
        <result property="detailedAddress" column="detailed_address"/>
        <result property="isSelfDelivery" column="is_self_delivery"/>
        <association property="cityCode" javaType="SimpleCityParam">
            <id property="cityId" column="city_id"/>
            <result property="name" column="name"/>
        </association>
    </resultMap>

    <resultMap id="storeVOResultMap" type="StoreVO">
        <id property="storeId" column="store_id" jdbcType="BIGINT"/>
        <result property="storeName" column="store_name"/>
        <result property="storeCode" column="store_code"/>
        <result property="storeType" column="store_type"/>
        <result property="enable" column="enable"/>
        <result property="enable" column="enable"/>
        <result property="storeOrgId" column="store_org_id"/>
        <association property="cityCode" javaType="SimpleCityParam">
            <id property="cityId" column="city_id"/>
            <result property="name" column="name"/>
        </association>
    </resultMap>


    <resultMap id="storeDOResultMap" type="StoreDO">
        <id property="storeId" column="store_id" jdbcType="BIGINT"/>
        <result property="storeName" column="store_name"/>
        <result property="storeCode" column="store_code"/>
        <result property="storeType" column="store_type"/>
        <result property="enable" column="enable"/>
        <result property="creatorType" column="creator_type"/>
        <result property="createTime" column="create_time"/>
        <result property="modifierType" column="modifier_type"/>
        <result property="modifyTime" column="modify_time"/>
        <result property="phone" column="phone"/>
        <result property="isDefault" column="is_default"/>
        <result property="province" column="province"/>
        <result property="city" column="city"/>
        <result property="area" column="area"/>
        <result property="detailedAddress" column="detailed_address"/>
        <result property="isSelfDelivery" column="is_self_delivery"/>
        <result property="salesManager" column="sales_manager"/>
        <association property="cityCode" javaType="SimpleCityParam">
            <id property="cityId" column="city_id"/>
            <result property="name" column="name"/>
        </association>
    </resultMap>


    <resultMap id="decorativeCompanyResultMap" type="DecorativeCompanyInfo">
        <id property="id" column="store_id" jdbcType="BIGINT"/>
        <result property="storeName" column="store_name"/>
        <result property="storeCode" column="store_code"/>
        <result property="enable" column="enable"/>
        <!--        <result property="credit" column="credit"/>
                <result property="sponsorship" column="sponsorship"/>-->
        <association property="cityCode" javaType="SimpleCityParam">
            <id property="cityId" column="city_id"/>
            <result property="name" column="name"/>
        </association>
        <association property="credit" javaType="DecorativeCompanyCredit">
            <id property="cid" column="cid"/>
            <result property="credit" column="credit"/>
            <result property="creditLastUpdateTime" column="credit_Last_update_ime"/>
        </association>
        <association property="sponsorship" javaType="DecorativeCompanySubvention">
            <id property="sid" column="sid"/>
            <result property="sponsorship" column="sponsorship"/>
            <result property="sponsorshipLastUpdateTime" column="sponsorship_last_update_time"/>
        </association>
    </resultMap>


    <select id="findAllVO" resultMap="storeVOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        s.store_org_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE
         s.store_type!="ZS"
        ORDER BY
        create_time
        DESC
    </select>


    <select id="findStoresVOById" parameterType="java.lang.Long" resultMap="storeDetailVOResultMap">
        SELECT
        s.*,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        where s.store_id=#{storeId}
    </select>

    <select id="findStoresListByCityId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.SimpleStoreParam">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        LEFT JOIN city c on s.city_code = c.code
        WHERE c.city_id = #{cityId}
         AND
         s.store_type!="ZS"
    </select>

    <select id="findAllStoresListByCityId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.SimpleStoreParam">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        LEFT JOIN city c on s.city_code = c.code
        WHERE c.city_id = #{cityId}
    </select>

    <select id="findStoresList" resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.SimpleStoreParam">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        WHERE
         s.store_type!="ZS"
    </select>


    <select id="findAllStorelist" resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.SimpleStoreParam">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
    </select>


    <select id="queryStoreListByCityId" parameterType="java.lang.Long" resultMap="storeVOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        s.store_org_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE c.city_id= #{cityId}
            AND
         s.store_type!="ZS"
    </select>


    <select id="findStoresListByCondition" resultMap="storeVOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        s.store_org_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE
        1=1
        <if test="null != cityId">
            AND
            c.city_id= #{cityId}
        </if>
        <if test="null != enabled">
            AND
            s.enable=#{enabled}
        </if>
        AND
        s.store_type!="ZS"
    </select>

    <select id="findStoresListByStoreInfo" parameterType="java.lang.String" resultMap="storeVOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        s.store_org_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE s.store_name LIKE CONCAT('%',#{queryStoreInfo},'%') OR s.store_code LIKE CONCAT('%',#{queryStoreInfo},'%')
        AND
         s.store_type!="ZS"
    </select>

    <update id="update">
        UPDATE
        st_store
        <set>
            <if test="null != isSelfDelivery">
                is_self_delivery = #{isSelfDelivery},
            </if>
        </set>
        WHERE store_id = #{storeId}
    </update>

    <select id="queryDecorativeCompanyPageVO" resultMap="storeDOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_id,
        c.name,
        s.create_time
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE
        s.store_type="ZS"
        ORDER BY
        s.create_time
        DESC
    </select>


    <select id="queryDecorativeCompanyVOList"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.decorativeCompany.SimpleDecorativeCompany">
        SELECT
        s.store_name,
        s.store_id as id
        FROM
        st_store s
        WHERE
        s.store_type="ZS"
        ORDER BY
        s.create_time
        DESC
    </select>

    <select id="findDecorativeByCondition" resultMap="storeDOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE
        s.store_type="ZS"
        <if test="null != cityId">
            AND
            c.city_id= #{cityId}
        </if>
        <if test="null != enabled">
            AND
            s.enable=#{enabled}
        </if>
        ORDER BY
        s.create_time
        DESC
    </select>

    <select id="findDecorativeByInfo" parameterType="java.lang.String" resultMap="storeDOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE
        s.store_type="ZS"
        AND
        (s.store_name LIKE CONCAT('%',#{queryDecorativeInfo},'%') OR s.store_code LIKE CONCAT('%',#{queryDecorativeInfo},'%'))
         ORDER BY
         s.create_time
         DESC
    </select>

    <select id="findDecorativeById" parameterType="java.lang.Long" resultMap="storeDOResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        s.create_time,
        c.name,
        s.sales_manager
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE s.store_id=#{storeId}
        AND
         s.store_type="ZS"
    </select>

    <select id="findDecorativeCreditList" resultMap="decorativeCompanyResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        c.name,
        scm.credit_limit_available AS credit,
        ss.balance AS sponsorship
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        LEFT JOIN st_credit_money scm on s.store_id=scm.store_id
        LEFT JOIN st_subvention ss on s.store_id=ss.store_id
        WHERE
        s.store_type="ZS"
        ORDER BY
         s.create_time
         DESC
    </select>


    <select id="findDecorativeCreditById" parameterType="java.lang.Long" resultMap="decorativeCompanyResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        c.name,
        scm.id as cid,
        ss.id as sid,
        scm.credit_limit_available AS credit ,
        scm.last_update_time AS credit_Last_update_ime ,
        ss.balance AS sponsorship,
        ss.last_update_time AS sponsorship_last_update_time
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        LEFT JOIN st_credit_money scm on s.store_id=scm.store_id
        LEFT JOIN st_subvention ss on s.store_id=ss.store_id
        WHERE
        s.store_id =#{decorativeCompanyId}
        AND
        s.store_type="ZS"
    </select>

    <select id="findDecorativeCreditByInfo" parameterType="java.lang.String" resultMap="decorativeCompanyResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        c.name,
        scm.credit_limit_available AS credit,
        ss.balance AS sponsorship
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        LEFT JOIN st_credit_money scm on s.store_id=scm.store_id
        LEFT JOIN st_subvention ss on s.store_id=ss.store_id
        WHERE
        s.store_type="ZS"
        AND
        (s.store_name LIKE CONCAT('%',#{queryDecorativeCreditInfo},'%') OR s.store_code LIKE CONCAT('%',#{queryDecorativeCreditInfo},'%'))
        ORDER BY
        s.create_time
        DESC
    </select>


    <select id="findDecorativeCreditByCondition" resultMap="decorativeCompanyResultMap">
        SELECT
        s.store_code,
        s.store_name,
        s.enable,
        s.store_type,
        s.store_id,
        c.name,
        scm.credit_limit_available AS credit,
        ss.balance AS sponsorship
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        LEFT JOIN st_credit_money scm on s.store_id=scm.store_id
        LEFT JOIN st_subvention ss on s.store_id=ss.store_id
        WHERE
        s.store_type="ZS"
        <if test="null != cityId">
            AND
            c.city_id= #{cityId}
        </if>
        <if test="null != enabled">
            AND
            s.enable=#{enabled}
        </if>
        ORDER BY
        s.create_time
        DESC
    </select>

    <select id="findCompanyStoresListByCityId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.store.StoreVO">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        LEFT JOIN city c on s.city_code = c.code
        WHERE c.city_id = #{cityId}
        AND
        s.store_type = 'ZS'
    </select>

    <select id="findDecorativeCompanyList" resultType="cn.com.leyizhuang.app.foundation.vo.management.store.StoreVO">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        WHERE
        s.store_type = 'ZS'
    </select>

    <select id="findSelfDeliveryStoresListByCityId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.store.StoreVO">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        LEFT JOIN city c on s.city_code = c.code
        WHERE c.city_id = #{cityId}
        AND
        s.is_self_delivery = TRUE
    </select>

    <select id="findSelfDeliveryStoresList" resultType="cn.com.leyizhuang.app.foundation.vo.management.store.StoreVO">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        WHERE
        s.is_self_delivery = TRUE
    </select>

    <select id="findAllStorePredeposit"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.store.StorePreDepositVO">
        SELECT
        sp.id, sp.balance, s.store_name, s.store_id, s.store_code, c.name city, s.store_type
        FROM st_store s
        LEFT JOIN st_pre_deposit sp on sp.store_id = s.store_id
        LEFT JOIN city c ON c.code = s.city_code
        WHERE
        (1 = 1)
        <if test="null != cityId and cityId != -1">
            AND c.city_id = #{cityId}
        </if>
        <if test="null != storeType and storeType != '-1'">
            AND s.store_type = #{storeType}
        </if>
        <if test="null != keywords and keywords != ''">
            AND (s.store_code LIKE concat(concat('%',#{keywords}),'%')
            OR s.store_name LIKE concat(concat('%',#{keywords}),'%'))
        </if>
        AND s.store_id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ORDER BY s.create_time DESC
    </select>

    <select id="queryStorePredepositByStoreId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.vo.management.store.StorePreDepositVO">
         SELECT
        sp.id, sp.balance, s.store_name, s.store_id, s.store_code, c.name city, s.store_type,sp.last_update_time
        FROM st_store s
        LEFT JOIN st_pre_deposit sp on sp.store_id = s.store_id
        LEFT JOIN city c ON c.code = s.city_code
        WHERE s.store_id = #{storeId}
    </select>

    <select id="findByStoreId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.StorePreDeposit">
        SELECT *
        FROM st_pre_deposit
        WHERE store_id = #{storeId}
    </select>

    <insert id="savePreDeposit" parameterType="cn.com.leyizhuang.app.foundation.pojo.StorePreDeposit">
        INSERT INTO st_pre_deposit (store_id, balance, last_update_time, create_time) VALUES (#{storeId}, #{balance}, #{lastUpdateTime}, #{createTime})
    </insert>

    <update id="updateDepositByStoreId">
        UPDATE st_pre_deposit
        SET balance = balance + #{money},
        last_update_time = #{lastUpdateTime}
        WHERE store_id = #{storeId}
        <if test="null != oldUpdateTime">
            AND last_update_time = #{oldUpdateTime}
        </if>
    </update>


    <select id="findStoreByStoreCode" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.MaStoreInfo">
        SELECT *
        FROM st_store
        WHERE store_code = #{storeCode}
    </select>


    <update id="updateStPreDepositByUserIdAndVersion">
        UPDATE st_pre_deposit
        SET
        balance = #{money}
        WHERE
        store_id = #{userId}
        AND last_update_time = #{version}
    </update>


    <insert id="saveStorePreDepositLog" parameterType="cn.com.leyizhuang.app.foundation.pojo.StPreDepositLogDO">
        INSERT INTO st_pre_deposit_log
        (create_time, change_money, remarks, change_type, store_id, operator_id, operator_type,
        operator_ip, order_number, balance, detail_reason, transfer_time, merchant_order_number)
        VALUES
        (#{createTime}, #{changeMoney}, #{remarks}, #{changeType}, #{storeId}, #{operatorId}, #{operatorType},
        #{operatorIp}, #{orderNumber}, #{balance}, #{detailReason}, #{transferTime}, #{merchantOrderNumber})
    </insert>

    <select id="findAllStoreVO" resultMap="storeVOResultMap" >
        SELECT
        s.store_code,
        s.store_name,
        s.store_type,
        s.store_id,
        c.name
        FROM
        st_store s
        LEFT JOIN city c ON s.city_code = c.code
        WHERE
        s.enable IS TRUE
        <if test="null != cityId and cityId != -1">
            AND c.city_id = #{cityId}
        </if>
        <if test="null != storeType and storeType != '-1'">
            AND s.store_type = #{storeType}
        </if>
        <if test="null != keywords and keywords != ''">
            AND (s.store_code LIKE concat(concat('%',#{keywords}),'%')
            OR s.store_name LIKE concat(concat('%',#{keywords}),'%'))
        </if>
        ORDER BY
        s.create_time
        DESC
    </select>

    <select id="findStoresListByCityIdAndStoreId" resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.SimpleStoreParam">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        LEFT JOIN city c on s.city_code = c.code
        WHERE (1 = 1)
        <if test="null != cityId and cityId != -1">
          AND c.city_id = #{cityId}
        </if>
        AND s.store_id in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="findStoresListByStoreId" resultType="cn.com.leyizhuang.app.foundation.pojo.management.store.SimpleStoreParam">
        SELECT
        s.store_id,
        s.store_name
        FROM
        st_store s
        WHERE
        s.store_id in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="findAppStoreByStoreId" parameterType="java.lang.Long" resultType="cn.com.leyizhuang.app.foundation.pojo.AppStore">
        SELECT city_id, storeId, storeType, storeName FROM st_store WHERE store_id = #{storeId}
    </select>

</mapper>