<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.transferdao.TransferDAO">

    <select id="findNewOrderNumber" resultType="cn.com.leyizhuang.app.foundation.pojo.order.OrderBaseInfo">
        SELECT
            ord_no orderNumber,
            oid    id
        FROM ord_base_info
    </select>

    <select id="findOwnMoneyRecordByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdOwnMoneyRecord">
        SELECT
            owned,
            payed,
            money,
            pos,
            create_time,
            ispassed,
            is_payed
        FROM td_own_money_record_copy
        WHERE order_number = #{orderNumber}
    </select>

    <select id="findOrderByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdOrder">
        SELECT
            real_user_real_name,
            real_user_username,
            seller_real_name,
            seller_username,
            shipping_address
        FROM td_order_copy
        WHERE main_order_number = #{orderNumber}
    </select>

    <insert id="insertArrearsAudit" parameterType="cn.com.leyizhuang.app.foundation.pojo.order.OrderArrearsAuditDO">
        INSERT INTO ord_arrears_audit
        (user_id, customer_name, customer_phone, seller_name, seller_phone, ord_no, agency_money, order_money,
         real_money, cash_money, pos_money, alipay_money, wechat_money, payment_method, distribution_address,
         distribution_time, remarks, status, create_time, seller_id, picture, whether_repayments, repayment_time)
        VALUES
            (#{userId}, #{customerName}, #{customerPhone}, #{sellerName}, #{sellerphone}, #{orderNumber},
                        #{agencyMoney}, #{orderMoney},
                        #{realMoney}, #{cashMoney}, #{posMoney}, #{alipayMoney}, #{wechatMoney}, #{paymentMethod},
                                                                 #{distributionAddress},
                                                                 #{distributionTime}, #{remarks}, #{status},
                                                                 #{createTime}, #{sellerId}, #{picture},
             #{whetherRepayments}, #{repaymentTime})
    </insert>

    <select id="findEmployeeByMobile" parameterType="java.lang.String" resultType="java.lang.Long">
        SELECT emp_id
        FROM emp_employee
        WHERE mobile = #{phone}
        GROUP BY mobile
    </select>

    <select id="findOrderDataByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdOrderData">
        SELECT *
        FROM td_order_data_copy
        WHERE main_order_number = #{orderNumber}
        GROUP BY main_order_number
    </select>

    <select id="existArrearsAudit" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT EXISTS(SELECT id
                      FROM ord_arrears_audit
                      WHERE ord_no = #{orderNumber})
    </select>

    <select id="findDeliveryInfoByOrderNumber" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT *
        FROM (SELECT
                  id,
                  op_user,
                  sub_order_number
              FROM td_delivery_info_detail
              WHERE sub_order_number = #{orderNumber}
              ORDER BY id DESC) t
        GROUP BY t.sub_order_number
    </select>

    <select id="findDeliveryInfoByClerkNo" parameterType="java.lang.String" resultType="java.lang.Long">
        SELECT emp_id
        FROM emp_employee
        WHERE delivery_clerk_no = #{clerkNo}
        GROUP BY emp_id
    </select>


    <select id="getTdOrderGoods" resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdOrderGoods">
        SELECT *
        FROM td_order_goods
    </select>

    <select id="queryDeliveryTimeSeqBySize" parameterType="java.lang.Integer"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdDeliveryInfoDetails">
        SELECT *
        FROM td_order_delivery_time_seq_detail
        WHERE operation_time &gt; '2017-10-01 00:00:00'
        LIMIT #{size}, 1000;
    </select>

    <select id="queryDeliveryInfoDetailByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdDeliveryInfoDetails">
        SELECT
            driver,
            task_no,
            wh_no
        FROM td_delivery_info
        WHERE begin_dt &gt; '2017-10-01 00:00:00'
              AND order_number = #{orderNo}
    </select>

    <select id="queryTdOrderListBySize" parameterType="java.lang.Integer"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdDeliveryInfoDetails">
        SELECT
            id,
            diy_site_code,
            main_order_number,
            pay_time
        FROM td_order_copy
        WHERE pay_time &gt; '2017-10-01 00:00:00'
        LIMIT #{size}, 1000;
    </select>

    <select id="queryOrderGoodsListByOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdDeliveryInfoDetails">
        SELECT
            sku,
            jx_dif,
            quantity,
            dif_total
        FROM td_order_goods_copy
        WHERE td_order_id = #{id}
    </select>

    <select id="getTransferStoreMainOrderNumber" resultType="java.lang.String">
        SELECT main_order_number
        FROM td_order_copy
        GROUP BY main_order_number;
    </select>

    <select id="getMainOrderInfoByMainOrderNumber" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.datatransfer.TdOrder">
        SELECT
            main_order_number,
            order_time,
            pay_time,
            status_id,
            deliver_type_title,
            is_seller_order,
            user_id,
            username,
            seller_id,
            diy_site_code,
            seller_real_name,
            seller_username,
            real_user_real_name,
            real_user_username,
            remark,
            city,
            paper_sales_number,
            sum(total_goods_price) total_goods_price
        FROM
            td_order_copy
        WHERE main_order_number = #{mainOrderNumber}
        GROUP BY main_order_number
    </select>

    <select id="findFitEmployeeInfoById" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.AppEmployee">
        SELECT
            e.emp_id,
            e.`name`,
            e.mobile
        FROM
            fit_employee_copy c
            INNER JOIN emp_employee e ON c.mobile = e.mobile
        WHERE c.id = #{userId}
    </select>

    <select id="findStoreEmployeeById" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.AppEmployee">
        SELECT
            e.emp_id,
            e.`name`,
            e.mobile
        FROM
            td_user_copy c
            INNER JOIN emp_employee e ON c.username = e.mobile
        WHERE c.id = #{sellerId}
    </select>

    <select id="findCustomerById" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.AppCustomer">
        SELECT
            e.cus_id,
            e.`name`,
            e.mobile
        FROM
            td_user_copy c
            INNER JOIN cus_customer e ON c.username = e.mobile
        WHERE c.id = #{userId}
    </select>
</mapper>