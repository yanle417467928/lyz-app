<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.AppCustomerDAO">

    <insert id="save" parameterType="AppCustomer" useGeneratedKeys="true"
            keyColumn="cus_id" keyProperty="cusId">
        INSERT INTO cus_customer
        (store_id, name, mobile, birthday, status, sex, open_id,
         pic_url, nick_name, city_id, sales_consult_id, create_time, light, is_cash_on_delivery, create_type, customer_type,
         last_sign_time, binding_time, last_consumption_time, customer_profession, customer_profession_desc
        )
        VALUES
            (
                #{storeId}, #{name}, #{mobile}, #{birthday}, #{status},
                            #{sex,
                              javaType=cn.com.leyizhuang.app.core.constant.SexType,
                              typeHandler=org.apache.ibatis.type.EnumTypeHandler},
                            #{openId}, #{picUrl}, #{nickName}, #{cityId}, #{salesConsultId},
                #{createTime}, #{light,
              javaType =cn.com.leyizhuang.app.core.constant.AppCustomerLightStatus,
              typeHandler=org.apache.ibatis.type.EnumTypeHandler},
                #{isCashOnDelivery}, #{createType,javaType =cn.com.leyizhuang.app.core.constant.AppCustomerCreateType,
              typeHandler=org.apache.ibatis.type.EnumTypeHandler},
                #{customerType,javaType =cn.com.leyizhuang.app.core.constant.AppCustomerType,
              typeHandler=org.apache.ibatis.type.EnumTypeHandler},
                #{lastSignTime}, #{bindingTime}, #{lastConsumptionTime}, #{customerProfession},
                #{customerProfessionDesc}
            )
    </insert>

    <select id="findByMobile" parameterType="java.lang.String" resultType="AppCustomer">
        SELECT *
        FROM cus_customer
        WHERE mobile = #{mobile}
    </select>

    <update id="update" parameterType="AppCustomer">
        UPDATE cus_customer
        <set>
            <if test="null != cityId">
                city_id = #{cityId},
            </if>
            <if test="null != storeId">
                store_id = #{storeId},
            </if>
            <if test="null != name">
                name = #{name},
            </if>
            <if test="null != mobile">
                mobile = #{mobile},
            </if>
            <if test="null != birthday">
                birthday = #{birthday},
            </if>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != sex">
                sex = #{sex,
                    javaType=cn.com.leyizhuang.app.core.constant.SexType,
                    typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            </if>
            <if test="null != openId">
                open_id = #{openId},
            </if>
            <if test="null != picUrl">
                pic_url = #{picUrl},
            </if>
            <if test="null != nickName">
                nick_name = #{nickName},
            </if>

            <if test="null != salesConsultId">
                sales_consult_id = #{salesConsultId},
            </if>

            <if test="null != isCashOnDelivery">
                is_cash_on_delivery = #{isCashOnDelivery},
            </if>
            <if test="null != customerType">
                customer_type = #{customerType,
                javaType =cn.com.leyizhuang.app.core.constant.AppCustomerType,
                   typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            </if>
            <if test="null != light">
                light = #{light,
                  javaType =cn.com.leyizhuang.app.core.constant.AppCustomerLightStatus,
                   typeHandler=org.apache.ibatis.type.EnumTypeHandler
                },
            </if>
            <if test="null != lastSignTime">
                last_sign_time = #{lastSignTime},
            </if>
            <if test="null != bindingTime">
                binding_time = #{bindingTime},
            </if>
            <if test="null != lastConsumptionTime">
                last_consumption_time = #{lastConsumptionTime},
            </if>
            <if test="null != customerProfession">
                customer_profession = #{customerProfession},
            </if>
            <if test="null != customerProfessionDesc">
                customer_profession_desc = #{customerProfessionDesc},
            </if>
        </set>
        WHERE cus_id = #{cusId}
    </update>

    <select id="findById" parameterType="java.lang.Long" resultType="AppCustomer">
        SELECT
            cus_id,
            city_id,
            store_id,
            name,
            mobile,
            birthday,
            status,
            sex,
            open_id,
            pic_url,
            nick_name,
            sales_consult_id,
            create_time,
            light,
            create_type,
            customer_type,
            last_sign_time,
            consecutive_sign_days,
            binding_time,
            last_consumption_time,
            customer_profession,
            customer_profession_desc
        FROM cus_customer
        WHERE cus_id = #{cusId}
    </select>

    <select id="findByOpenId" parameterType="java.lang.String" resultType="AppCustomer">
        SELECT *
        FROM cus_customer
        WHERE open_id = #{openId}
    </select>

    <select id="findCashCouponByCustomerId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.CashCouponResponse">
        SELECT
            cc.ccid id,
            c.denomination,
            c.effective_start_time,
            c.effective_end_time,
            c.description,
            c.title
        FROM
            cus_customer_cash_coupon cc
            INNER JOIN cp_cash_coupon c ON cc.ccid = c.ccid
        WHERE
            cc.cus_id = #{userId}
            AND cc.is_used IS FALSE
            AND cc.`status` IS TRUE
            AND c.effective_start_time &lt; now()
            AND c.effective_end_time &gt; now()
    </select>

    <select id="findProductCouponByCustomerId" parameterType="java.lang.Long" resultType="ProductCouponResponse">
        SELECT
            g.gid           goods_id,
            g.sku_name      goods_name,
            g.sku           goods_code,
            g.goods_specification,
            g.goods_unit    goods_unit,
            sum(c.quantity) left_number,
            g.cover_image_uri
        FROM
            cus_customer_product_coupon c
            INNER JOIN gds_goods g ON c.gid = g.gid
        WHERE
            c.cus_id = #{userId}
            AND c.is_used IS FALSE
            AND effective_start_time &lt; NOW()
            AND (effective_end_time &gt; NOW() OR effective_end_time IS NULL)
        GROUP BY
            g.sku
    </select>

    <select id="findListBySalesConsultId" parameterType="java.lang.Long"
            resultType="AppCustomer">
        SELECT
            c.cus_id,
            c.name,
            c.mobile,
            c.pic_url,
            c.light,
            c.customer_type,
            c.create_time,
            c.last_consumption_time,
            c.customer_profession,
            c.customer_profession_desc
        FROM cus_customer c
        WHERE sales_consult_id = #{userId}
    </select>

    <select id="searchBySalesConsultIdAndKeywords" resultType="AppCustomer">

        SELECT
            c.cus_id,
            c.name,
            c.mobile,
            c.pic_url,
            c.light,
            c.create_time,
            c.customer_profession_desc customerProfessionDesc
        FROM cus_customer c
        WHERE (c.sales_consult_id = #{userId} OR c.store_id IN (SELECT store_id
                                                                FROM st_store
                                                                WHERE is_default = TRUE AND
                                                                      city_id IN (SELECT DISTINCT city_id
                                                                                  FROM cus_customer
                                                                                  WHERE sales_consult_id = 1)))
              AND (
                  c.name LIKE concat('%', #{keywords}, '%')
                  OR c.mobile LIKE concat('%', #{keywords}, '%')
              )
    </select>

    <select id="findPreDepositBalanceByUserId" parameterType="java.lang.Long" resultType="java.lang.Double">
        SELECT balance
        FROM cus_pre_deposit
        WHERE cus_id = #{userId}
    </select>

    <select id="findLeBiQuantityByUserId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT quantity
        FROM cus_lb
        WHERE cus_id = #{userId}
    </select>

    <update id="updateLeBiQuantityByUserId">
        UPDATE
            cus_lb
        SET
            quantity = quantity + #{qty}
        WHERE
            cus_id = #{userId}
    </update>

    <update id="updateLeBiQuantityByUserIdAndQty">
        UPDATE
            cus_lb
        SET
            quantity = quantity - #{qty}
        WHERE
            cus_id = #{userId}
            AND last_update_time = #{version}
    </update>

    <update id="updateCustomerMobileByUserId">
        UPDATE
            cus_customer
        SET
            mobile = #{mobile}
        WHERE
            cus_id = #{userId}
    </update>
    <select id="findCustomerInfoByUserId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.CustomerHomePageResponse">
        SELECT
            c.pic_url,
            c.name,
            c.nick_name,
            c.mobile,
            c.light,
            e.name      guideName,
            e.mobile    guideMobile,
            pd.balance,
            lb.quantity lb,
            c.last_sign_time,
            c.city_id
        FROM cus_customer c
            LEFT JOIN emp_employee e ON e.emp_id = c.sales_consult_id
            LEFT JOIN cus_pre_deposit pd ON pd.cus_id = c.cus_id
            LEFT JOIN cus_lb lb ON lb.cus_id = c.cus_id
        WHERE
            c.cus_id = #{userId}
    </select>

    <select id="existsByCustomerId" parameterType="java.lang.Long" resultType="java.lang.Boolean">
        SELECT is_cash_on_delivery
        FROM cus_customer
        WHERE cus_id = #{userId}
    </select>

    <insert id="saveLeBi" parameterType="cn.com.leyizhuang.app.foundation.pojo.user.CustomerLeBi">
        INSERT INTO cus_lb (cus_id, quantity) VALUES (#{cusId}, #{quantity})
    </insert>

    <insert id="savePreDeposit" parameterType="cn.com.leyizhuang.app.foundation.pojo.user.CustomerPreDeposit">
        INSERT INTO cus_pre_deposit (cus_id, balance) VALUES (#{cusId}, #{balance})
    </insert>

    <update id="updateCustomerSignInfoByCustomerId">
        UPDATE cus_customer
        SET last_sign_time        = #{date},
            consecutive_sign_days = #{consecutiveSignDays}
        WHERE cus_id = #{cusId}
    </update>

    <update id="updateDepositByUserIdAndDeposit">
        UPDATE cus_pre_deposit
        SET balance = balance - #{deposit}
        WHERE
            cus_id = #{userId}
            AND last_update_time = #{version}
    </update>

    <update id="updateDepositByUserId">
        UPDATE cus_pre_deposit
        SET balance = balance + #{deposit}
        WHERE cus_id = #{userId}
    </update>

    <update id="updateDepositByUserIdAndLastUpdateTime">
        UPDATE cus_pre_deposit
        SET balance = balance + #{deposit},
        last_update_time = #{lastUpdateTime}
        WHERE cus_id = #{userId}
        <if test="null != oldLastUpdateTime">
            AND last_update_time = #{oldLastUpdateTime}
        </if>

    </update>

    <update id="updateLeBiByUserIdAndQuantity">
        UPDATE cus_lb
        SET quantity = quantity + #{qty}
        WHERE cus_id = #{userId}
    </update>

    <update id="updateProductCouponByUserIdAndProductCoupons">

        UPDATE cus_customer_product_coupon
        SET
            quantity = quantity - #{qty}
        WHERE
            quantity >= #{qty}
            AND
            gid = #{gid}
            AND
            cus_id = #{userId};
    </update>
    <update id="updateProductCouponByUserIdAndGoodsIdAndProductCoupons">

        UPDATE cus_customer_product_coupon
        SET
            quantity = quantity + #{qty}
        WHERE
            gid = #{gid}
            AND
            cus_id = #{userId};
    </update>

    <update id="updateCashCouponByUserIdAndCashCoupons">

        UPDATE cus_customer_cash_coupon
        SET
            qty = qty - #{qty}
        WHERE
            qty >= #{qty}
            AND
            ccid = #{gid}
            AND
            cus_id = #{userId};
    </update>

    <update id="updateCashCouponByUserIdAndGoodsIdAndCashCoupons">

        UPDATE cus_customer_cash_coupon
        SET
            qty = qty + #{qty}
        WHERE
            ccid = #{ccid}
            AND
            cus_id = #{userId};
    </update>

    <select id="findStoreSellerByCustomerId" resultType="cn.com.leyizhuang.app.foundation.pojo.user.AppCustomer">
        SELECT
            store_id,
            sales_consult_id,
            binding_time,
            create_time
        FROM cus_customer
        WHERE cus_id = #{userId};
    </select>

    <select id="findCashCouponByCcIdAndUserIdAndQty"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.CashCouponResponse">
        SELECT
            cccc.denomination,
            cccc.`condition`,
            cccc.title
        FROM
            cus_customer_cash_coupon cccc
        WHERE
            cccc.id = #{ccId}
            AND cccc.cus_id = #{cusId}
            AND cccc.qty >= #{qty}
            AND cccc.is_used = FALSE
            AND cccc.effective_start_time &lt; NOW()
            AND (
                cccc.effective_end_time IS NULL
                OR cccc.effective_end_time &gt; NOW()
            )
    </select>

    <select id="findCashCouponUseableByCustomerId"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.CashCouponResponse">
        SELECT
            ccp.id,
            ccp.denomination,
            ccp.effective_start_time,
            ccp.effective_end_time,
            ccp.descripttion,
            ccp.title
        FROM
            cus_customer_cash_coupon ccp
        WHERE
            ccp.cus_id = #{userId}
            AND ccp.is_used IS FALSE
            AND ccp.`status` IS TRUE
            AND ccp.effective_start_time &lt; now()
            AND ccp.effective_end_time &gt; now()
            AND ccp.`condition` &lt;= #{totalAmount}
    </select>

    <select id="findByCusId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.CustomerPreDeposit">
        SELECT *
        FROM cus_pre_deposit
        WHERE cus_id = #{cusId}
    </select>

    <select id="findProductCouponBySellerIdAndCustomerId" resultType=
            "cn.com.leyizhuang.app.foundation.pojo.response.ProductCouponResponse">
        SELECT
            g.gid           goods_id,
            g.sku_name      goods_name,
            g.sku           goods_code,
            g.goods_specification,
            g.goods_unit    goods_unit,
            sum(c.quantity) left_number,
            g.cover_image_uri
        FROM
            cus_customer_product_coupon c
            INNER JOIN gds_goods g ON c.gid = g.gid
        WHERE
            c.cus_id = #{cusId}
            AND c.seller_id = #{sellerId}
            AND c.is_used IS FALSE
            AND c.effective_start_time &lt; NOW()
            AND (c.effective_end_time &gt; NOW() OR c.effective_end_time IS NULL)
        GROUP BY
            g.sku
    </select>

    <select id="findProductCouponCustomerBySellerId"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.ProductCouponCustomer">
        SELECT DISTINCT
        c.cus_id,
        cc.name,
        cc.mobile
        FROM cus_customer_product_coupon c LEFT JOIN cus_customer cc ON cc.cus_id = c.cus_id
        WHERE c.seller_id = #{userId}
        AND c.is_used IS FALSE
        AND c.effective_start_time &lt; NOW()
        AND (c.effective_end_time &gt; NOW() OR c.effective_end_time IS NULL)
        <if test="keywords != null and keywords != ''">
            AND (cc.mobile LIKE CONCAT('%',#{keywords},'%') OR cc.name LIKE CONCAT('%',#{keywords},'%') )
        </if>
    </select>


    <select id="findCashCouponByCcid" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.CustomerCashCoupon">
        SELECT
            id,
            cus_id,
            ccid,
            qty,
            is_used,
            use_time,
            use_ord_no use_order_number,
            get_time,
            `condition`,
            denomination,
            effective_start_time,
            effective_end_time,
            descripttion,
            title,
            status,
            down_time
        FROM cus_customer_cash_coupon
        WHERE id = #{id};
    </select>

    <update id="updateCustomerCashCouponById">
        UPDATE cus_customer_cash_coupon
        SET is_used    = TRUE,
            use_time   = now(),
            use_ord_no = #{orderNumber}
        WHERE id = #{id}
              AND status = TRUE
              AND is_used = FALSE
              AND now() BETWEEN effective_start_time AND effective_end_time
    </update>

    <select id="findCustomerLebiByCustomerId" parameterType="java.lang.Long" resultType=
            "cn.com.leyizhuang.app.foundation.pojo.user.CustomerLeBi">
        SELECT
            id,
            create_time,
            cus_id,
            quantity,
            last_update_time
        FROM cus_lb
        WHERE cus_id = #{customerId}
    </select>

    <insert id="addCustomerCashCouponChangeLog"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.CustomerCashCouponChangeLog">
        INSERT INTO cus_cash_coupon_change_log (cus_id, use_time, coupon_id, change_type, change_type_desc,
                                                operator_id, operator_type, operator_ip, remark)
        VALUES (#{cusId}, #{useTime}, #{couponId},
                #{changeType}, #{changeTypeDesc}, #{operatorId}, #{operatorType}, #{operatorIp}, #{remark})
    </insert>

    <insert id="addCustomerLeBiVariationLog"
            parameterType="cn.com.leyizhuang.app.foundation.pojo.CustomerLeBiVariationLog">
        INSERT INTO cus_lb_variation_log (cus_id, variation_time, le_bi_variation_type, variation_type_desc, variation_quantity,
                                          after_variation_quantity, order_num)
        VALUES (#{cusId}, #{variationTime}, #{leBiVariationType}, #{variationTypeDesc},
                #{variationQuantity}, #{afterVariationQuantity}, #{orderNum})
    </insert>

    <insert id="addCusPreDepositLog" parameterType="cn.com.leyizhuang.app.foundation.pojo.CusPreDepositLogDO">
        INSERT INTO cus_pre_deposit_log (create_time, change_money, remarks, change_type, change_type_desc, cus_id, operator_id, operator_type, operator_ip, order_number, balance,
                                         detail_reason, transfer_time, merchant_order_number)
        VALUES (#{createTime}, #{changeMoney}, #{remarks}, #{changeType}, #{changeTypeDesc}, #{cusId},
                               #{operatorId}, #{operatorType}, #{operatorIp}, #{orderNumber}, #{balance},
                #{detailReason}, #{transferTime}, #{merchantOrderNumber})
    </insert>

    <select id="findCashCouponAvailQtyByCustomerId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT sum(qty)
        FROM cus_customer_cash_coupon
        WHERE cus_id = #{userId}
              AND is_used IS FALSE
              AND status IS TRUE
              AND (now() BETWEEN effective_start_time AND effective_end_time)
        GROUP BY cus_id
    </select>

    <select id="findProductCouponAvailQtyByCustomerId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT sum(quantity)
        FROM cus_customer_product_coupon
        WHERE cus_id = #{userId}
              AND is_used IS FALSE
              AND effective_start_time &lt; NOW()
              AND (effective_end_time &gt; NOW() OR effective_end_time IS NULL)
        GROUP BY cus_id
    </select>

    <select id="countSignDaysByCusId" resultType="java.lang.Integer">
        SELECT COUNT(id)
        FROM cus_sign_log
        WHERE cus_id = #{cusId}
              AND (sign_time BETWEEN #{startDate} AND #{endDate})
    </select>

    <select id="countTotalSignDaysByCusId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(id)
        FROM cus_sign_log
        WHERE cus_id = #{cusId}
    </select>

    <select id="countSignAwardLebiQtyByCusId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT sum(award_lebi_qty)
        FROM cus_sign_log
        WHERE
            cus_id = #{cusId}
        GROUP BY cus_id
    </select>

    <select id="findCustomerSignDetailByCusId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.CustomerSignLogBrief">
        SELECT t.*
        FROM
            (
                SELECT
                    s.sign_time,
                    s.award_lebi_qty award,
                    s.description
                FROM
                    cus_sign_log s
                WHERE
                    s.cus_id = #{cusId}
                ORDER BY
                    s.sign_time DESC
            ) t
    </select>

    <insert id="saveSignLog" parameterType="cn.com.leyizhuang.app.foundation.pojo.user.CusSignLog">
        INSERT INTO cus_sign_log (cus_id, cus_name, sign_time, award_lebi_qty, description)
        VALUES (#{cusId}, #{cusName}, #{signTime}, #{awardLebiQty}, #{description})
    </insert>

    <select id="findCashCouponsByCcids" resultType="cn.com.leyizhuang.app.foundation.pojo.CustomerCashCoupon">
        SELECT
        cus_id,
        ccid,
        qty,
        get_time,
        is_used,
        use_time,
        use_ord_no,
        down_time,
        status,
        `condition`,
        denomination,
        effective_start_time,
        effective_end_time,
        descripttion,
        title
        FROM cus_customer_cash_coupon where ccid in
        <foreach collection="cashCouponList" item="ccid" index="index" open="(" close=")" separator=",">
            #{ccid}
        </foreach>
    </select>

    <select id="findProductCouponsByCustomerIdAndGoodsIdAndQty"
            resultType="cn.com.leyizhuang.app.foundation.pojo.CustomerProductCoupon">
        SELECT
            id,
            cus_id,
            seller_id,
            store_id,
            gid,
            quantity,
            get_type,
            get_time,
            get_ord_no,
            buy_price,
            effective_start_time,
            effective_end_time,
            is_used,
            use_time,
            use_ord_no
        FROM cus_customer_product_coupon
        WHERE cus_id = #{customerId}
              AND gid = #{id}
              AND status = TRUE
              AND is_used = FALSE
              AND effective_start_time &lt; NOW()
              AND (effective_end_time &gt; NOW() OR effective_end_time IS NULL)
        ORDER BY get_time
        LIMIT #{qty}
    </select>

    <update id="updateCustomerProductCouponById">
        UPDATE cus_customer_product_coupon
        SET is_used    = TRUE,
            use_time   = now(),
            use_ord_no = #{orderNumber}
        WHERE id = #{couponId}
              AND status = TRUE
              AND is_used = FALSE
              AND effective_start_time &lt; NOW()
              AND (effective_end_time &gt; NOW() OR effective_end_time IS NULL)
    </update>

    <select id="getCustomerProfessionListByStatus" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.CustomerProfession">
        SELECT
            id,
            title,
            description,
            create_time,
            status
        FROM cus_profession
        WHERE status = #{status}
    </select>

    <update id="updateDepositByUserIdAndVersion">
        UPDATE cus_pre_deposit
        SET balance = balance + #{deposit}
        WHERE cus_id = #{userId}
              AND last_update_time = #{version}
    </update>

    <select id="findCashCouponsByids" resultType="cn.com.leyizhuang.app.foundation.pojo.CustomerCashCoupon">
        SELECT
        cus_id,
        ccid,
        qty,
        get_time,
        is_used,
        use_time,
        use_ord_no,
        down_time,
        status,
        `condition`,
        denomination,
        effective_start_time,
        effective_end_time,
        descripttion,
        title
        FROM cus_customer_cash_coupon where id in
        <foreach collection="cashCouponList" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="findCustomerProfessionByTitle" parameterType="java.lang.String"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.CustomerProfession">
        SELECT
            id,
            title,
            description,
            create_time,
            status
        FROM cus_profession
        WHERE title = #{customerProfession}
    </select>

    <update id="unbindingCustomerWeChat" parameterType="java.lang.Long">
        UPDATE cus_customer
        SET open_id   = NULL,
            pic_url   = NULL,
            nick_name = NULL
        WHERE cus_id = #{userId}
    </update>

</mapper>