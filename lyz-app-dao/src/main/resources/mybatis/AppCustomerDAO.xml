<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.AppCustomerDAO">

    <insert id="save" parameterType="AppCustomer" useGeneratedKeys="true"
            keyColumn="cus_id" keyProperty="cusId">
        <selectKey keyProperty="cusId" order="AFTER" resultType="java.lang.Long">
            select LAST_INSERT_ID()
        </selectKey>
        INSERT INTO cus_customer (name, mobile, birthday, status, sex, open_id,
        pic_url, nick_name, city_id, sales_consult_id, create_time,light,is_cash_on_delivery,create_type,customer_type
        ) VALUES (
        #{name}, #{mobile}, #{birthday}, #{status},
        #{sex,
        javaType=cn.com.leyizhuang.app.core.constant.SexType,
        typeHandler=org.apache.ibatis.type.EnumTypeHandler},
        #{openId}, #{picUrl}, #{nickName}, #{cityId}, #{salesConsultId},
        #{createTime},#{light,
              javaType =cn.com.leyizhuang.app.core.constant.AppCustomerLightStatus,
              typeHandler=org.apache.ibatis.type.EnumTypeHandler},
        #{isCashOnDelivery},#{createType,javaType =cn.com.leyizhuang.app.core.constant.AppCustomerCreateType,
              typeHandler=org.apache.ibatis.type.EnumTypeHandler},
        #{customerType,javaType =cn.com.leyizhuang.app.core.constant.AppCustomerType,
              typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        )
    </insert>

    <select id="findByMobile" parameterType="java.lang.String" resultType="AppCustomer">
        SELECT *
        FROM cus_customer
        WHERE mobile = #{mobile}
    </select>

    <update id="update" parameterType="AppCustomer">
        UPDATE cus_customer
        <set>
            <if test="null != name">
                name = #{name},
            </if>
            <if test="null != mobile">
                mobile = #{mobile},
            </if>
            <if test="null != birthday">
                birthday = #{birthday},
            </if>
            <if test="null != status">
                status = #{status},
            </if>
            <if test="null != sex">
                sex = #{sex,
                    javaType=cn.com.leyizhuang.app.core.constant.SexType,
                    typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            </if>
            <if test="null != openId">
                open_id = #{openId},
            </if>
            <if test="null != picUrl">
                pic_url = #{picUrl},
            </if>
            <if test="null != nickName">
                nick_name = #{nickName},
            </if>
            <if test="null != cityId">
                city_id = #{cityId},
            </if>
            <if test="null != salesConsultId">
                sales_consult_id = #{salesConsultId},
            </if>
            <if test="null != storeId">
                store_id = #{storeId},
            </if>
            <if test="null != storeId">
                store_id = #{storeId},
            </if>
            <if test="null != isCashOnDelivery">
                is_cash_on_delivery = #{isCashOnDelivery},
            </if>
            <if test="null != customerType">
                customer_type = #{customerType,
                javaType =cn.com.leyizhuang.app.core.constant.AppCustomerType,
                   typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            </if>
            <if test="null != light">
                light = #{light,
                  javaType =cn.com.leyizhuang.app.core.constant.AppCustomerLightStatus,
                   typeHandler=org.apache.ibatis.type.EnumTypeHandler
                },
            </if>
        </set>
        WHERE cus_id = #{cusId}
    </update>

    <select id="findById" parameterType="java.lang.Long" resultType="AppCustomer">
        SELECT *
        FROM cus_customer
        WHERE cus_id = #{cusId}
    </select>

    <select id="findByOpenId" parameterType="java.lang.String" resultType="AppCustomer">
        SELECT *
        FROM cus_customer
        WHERE open_id = #{openId}
    </select>

    <select id="findCashCouponByCustomerId" parameterType="java.lang.Long" resultType="CashCouponResponse">
        SELECT
            c.denomination,
            c.effective_start_time,
            c.effective_end_time,
            c.description,
            c.title
        FROM
            cus_customer_cash_coupon cc
            INNER JOIN cp_cash_coupon c ON cc.ccid = c.ccid
        WHERE
            cc.cus_id = #{userId}
            AND cc.is_used IS FALSE
            AND cc.`status` IS TRUE
            AND c.effective_start_time &lt; now()
            AND c.effective_end_time &gt; now()
    </select>

    <select id="findProductCouponByCustomerId" parameterType="java.lang.Long" resultType="ProductCouponResponse">
        SELECT
            g.sku_name      goods_name,
            g.sku           goods_code,
            g.goods_specification,
            g.goods_unit    goods_unit,
            sum(c.quantity) left_number,
            g.cover_image_uri
        FROM
            cus_customer_product_coupon c
            INNER JOIN gds_goods g ON c.gid = g.gid
        WHERE
            c.cus_id = #{userId}
            AND c.is_used IS FALSE
            AND c.effective_start_time &lt; NOW()
            AND c.effective_end_time &gt; NOW()
        GROUP BY
            g.sku
    </select>

    <select id="findListBySalesConsultId" parameterType="java.lang.Long"
            resultType="AppCustomer">
        SELECT
            c.name,
            c.mobile,
            c.pic_url,
            c.light,
            c.create_time
        FROM cus_customer c
        WHERE sales_consult_id = #{userId}
    </select>

    <select id="searchBySalesConsultIdAndKeywords" resultType="AppCustomer">

        SELECT
            c.name,
            c.mobile,
            c.pic_url,
            c.light,
            c.create_time
        FROM cus_customer c
        WHERE c.sales_consult_id = #{userId}
              AND (
                  c.name LIKE concat('%', #{keywords}, '%')
                  OR c.mobile LIKE concat('%', #{keywords}, '%')
              )
    </select>

    <select id="findPreDepositBalanceByUserId" parameterType="java.lang.Long" resultType="java.lang.Double">
        SELECT balance
        FROM cus_pre_deposit
        WHERE cus_id = #{userId}
    </select>

    <select id="findLeBiQuantityByUserId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT quantity
        FROM cus_lb
        WHERE cus_id = #{userId}
    </select>

    <update id="updateLeBiQuantityByUserId" parameterType="java.lang.Long">
        UPDATE
            cus_lb
        SET
            quantity = quantity + 10
        WHERE
            cus_id = #{userId}
    </update>

    <update id="updateLeBiQuantityByUserIdAndQty">
        UPDATE
            cus_lb
        SET
            quantity = quantity - #{qty}
        WHERE
            cus_id = #{userId}
    </update>

    <update id="updateCustomerMobileByUserId">
        UPDATE
            cus_customer
        SET
            mobile = #{mobile}
        WHERE
            cus_id = #{userId}
    </update>
    <select id="findCustomerInfoByUserId" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.response.CustomerHomePageResponse">
        SELECT
            c.pic_url,
            c.name,
            c.nick_name,
            c.light,
            e.name      guideName,
            e.mobile    guideMobile,
            pd.balance,
            lb.quantity lb,
            c.last_sign_time
        FROM cus_customer c
            LEFT JOIN emp_employee e ON e.emp_id = c.sales_consult_id
            LEFT JOIN cus_pre_deposit pd ON pd.cus_id = c.cus_id
            LEFT JOIN cus_lb lb ON lb.cus_id = c.cus_id
        WHERE
            c.cus_id = #{userId}
    </select>

    <select id="existsByCustomerId" parameterType="java.lang.Long" resultType="java.lang.Boolean">
        SELECT is_cash_on_delivery
        FROM cus_customer
        WHERE cus_id = #{userId}
    </select>

    <insert id="saveLeBi" parameterType="cn.com.leyizhuang.app.foundation.pojo.CustomerLeBi">
        INSERT INTO cus_lb (cus_id, quantity) VALUES (#{cusId}, #{quantity})
    </insert>

    <insert id="savePreDeposit" parameterType="cn.com.leyizhuang.app.foundation.pojo.CustomerPreDeposit">
        INSERT INTO cus_pre_deposit (cus_id, balance) VALUES (#{cusId}, #{balance})
    </insert>

    <update id="updateLastSignTimeByCustomerId">
        UPDATE cus_customer
        SET last_sign_time = #{date}
        WHERE cus_id = #{cusId}
    </update>

</mapper>