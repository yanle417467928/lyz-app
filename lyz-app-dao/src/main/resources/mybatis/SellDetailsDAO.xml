<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.SellDetailsDAO">

    <insert id="addOneDetail" parameterType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsDO">
    insert into sell_details ( company_id, `year`,
      `month`, store_id, seller_id,seller_name,
      customer_phone, customer_name, number,
      goods_grade, sku, quantity,
      amount, single_rewards ,city_id,goods_line_id,create_time,customer_id,order_subject_type,creator_identity_type,
      creator_id,creator_name,company_flag,goods_line_type,sell_detals_flag,real_time)
    values ( #{companyId,jdbcType=BIGINT}, #{year,jdbcType=VARCHAR},
      #{month,jdbcType=VARCHAR}, #{storeId,jdbcType=BIGINT}, #{sellerId,jdbcType=BIGINT},#{sellerName},
      #{customerPhone,jdbcType=VARCHAR}, #{customerName,jdbcType=VARCHAR}, #{number,jdbcType=VARCHAR},
      #{goodsGrade,jdbcType=VARCHAR}, #{sku,jdbcType=VARCHAR}, #{quantity,jdbcType=INTEGER},
      #{amount,jdbcType=DECIMAL}, #{singleRewards,jdbcType=DECIMAL},#{cityId},#{goodsLineId},#{createTime},#{customerId},
      #{orderSubjectType},#{creatorIdentityType},#{creatorId},#{creatorName},#{companyFlag},#{goodsLineType},#{sellDetalsFlag},#{realTime})
    </insert>

    <insert id="addSellDetailsSingle" parameterType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsSingleDO" useGeneratedKeys="true" keyProperty="id">
        insert into sell_details_single (id, create_time, updata_time,
        seller_id, seller_name, target_qty,
        finish_qty, finish_chance, flag,
        structure_id, structure_code, structure_name,
        year, month)
        values (#{id,jdbcType=BIGINT}, #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP},
        #{sellerId,jdbcType=BIGINT}, #{sellerName,jdbcType=VARCHAR}, #{targetQty,jdbcType=INTEGER},
        #{finishQty,jdbcType=INTEGER}, #{finishChance,jdbcType=DECIMAL}, #{flag,jdbcType=VARCHAR},
        #{structureId,jdbcType=BIGINT}, #{structureCode,jdbcType=VARCHAR}, #{structureName,jdbcType=VARCHAR},
        #{year,jdbcType=INTEGER}, #{month,jdbcType=INTEGER})
    </insert>

    <insert id="addSellDetailsWeekFinish" parameterType="cn.com.leyizhuang.app.foundation.pojo.response.SellDetailsWeekFinishResponse" >
        insert into sell_details_week_finish (id, head_id, week,
        start_time, end_time, finish_qty
        )
        values (#{id,jdbcType=INTEGER}, #{headId,jdbcType=INTEGER}, #{week,jdbcType=INTEGER},
        #{startDate,jdbcType=TIMESTAMP}, #{endDate,jdbcType=TIMESTAMP}, #{finishQty,jdbcType=INTEGER}
        )
    </insert>

    <insert id="addEmpPerformanceStatisticErrorLog" parameterType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsStatisticErrorLog" >
        insert into sell_details_statistic_error_log (id, create_time, seller_id,
        is_dispose, flag, error_msg
        )
        values (#{id,jdbcType=BIGINT}, #{createTime,jdbcType=TIMESTAMP}, #{sellerId,jdbcType=BIGINT},
        #{isDispose,jdbcType=BIT}, #{flag,jdbcType=VARCHAR}, #{errorMsg,jdbcType=LONGVARCHAR}
        )
    </insert>

    <update id="update" parameterType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsDO" >
        update sell_details
        <set >
            <if test="companyId != null" >
                company_id = #{companyId,jdbcType=BIGINT},
            </if>
            <if test="year != null" >
                `year` = #{year,jdbcType=INTEGER},
            </if>
            <if test="month != null" >
                `month` = #{month,jdbcType=INTEGER},
            </if>
            <if test="createTime != null" >
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="realTime != null">
                real_time = #{realTime},
            </if>
            <if test="cityId != null" >
                city_id = #{cityId,jdbcType=BIGINT},
            </if>
            <if test="storeId != null" >
                store_id = #{storeId,jdbcType=BIGINT},
            </if>
            <if test="sellerId != null" >
                seller_id = #{sellerId,jdbcType=BIGINT},
            </if>
            <if test="sellerName != null" >
                seller_name = #{sellerName,jdbcType=VARCHAR},
            </if>
            <if test="customerId != null" >
                customer_id = #{customerId,jdbcType=BIGINT},
            </if>
            <if test="customerPhone != null" >
                customer_phone = #{customerPhone,jdbcType=VARCHAR},
            </if>
            <if test="customerName != null" >
                customer_name = #{customerName,jdbcType=VARCHAR},
            </if>
            <if test="number != null" >
                `number` = #{number,jdbcType=VARCHAR},
            </if>
            <if test="goodsGrade != null" >
                goods_grade = #{goodsGrade,jdbcType=VARCHAR},
            </if>
            <if test="sku != null" >
                sku = #{sku,jdbcType=VARCHAR},
            </if>
            <if test="quantity != null" >
                quantity = #{quantity,jdbcType=INTEGER},
            </if>
            <if test="amount != null" >
                amount = #{amount,jdbcType=DECIMAL},
            </if>
            <if test="singleRewards != null" >
                single_rewards = #{singleRewards,jdbcType=DECIMAL},
            </if>
            <if test="goodsLineId != null" >
                goods_line_id = #{goodsLineId,jdbcType=BIGINT},
            </if>
            <if test="sellDetalsFlag != null" >
                sell_detals_flag = #{sellDetalsFlag,jdbcType=INTEGER},
            </if>
            <if test="orderSubjectType != null" >
                order_subject_type = #{orderSubjectType,jdbcType=VARCHAR},
            </if>
            <if test="creatorIdentityType != null" >
                creator_identity_type = #{creatorIdentityType,jdbcType=VARCHAR},
            </if>
            <if test="creatorId != null" >
                creator_id = #{creatorId,jdbcType=BIGINT},
            </if>
            <if test="creatorName != null" >
                creator_name = #{creatorName,jdbcType=VARCHAR},
            </if>
            <if test="companyFlag != null" >
                company_flag = #{companyFlag,jdbcType=VARCHAR},
            </if>
            <if test="goodsLineType != null" >
                goods_line_type = #{goodsLineType,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <update id="updateSellDetailsSingle" parameterType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsSingleDO" >
        update sell_details_single
        <set >

            <if test="updateTime != null" >
                updata_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="sellerName != null" >
                seller_name = #{sellerName,jdbcType=VARCHAR},
            </if>
            <if test="finishQty != null" >
                finish_qty = #{finishQty,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <update id="updateSellDetailsWeekFinish" parameterType="cn.com.leyizhuang.app.foundation.pojo.response.SellDetailsWeekFinishResponse" >
        update sell_details_week_finish
        <set >

            <if test="startDate != null" >
                start_time = #{startDate,jdbcType=TIMESTAMP},
            </if>
            <if test="endDate != null" >
                end_time = #{endDate,jdbcType=TIMESTAMP},
            </if>
            <if test="finishQty != null" >
                finish_qty = #{finishQty,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="queryOneMonthSellDetails" resultType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsDO">
      select * from sell_details where
      `year` = #{year} and `month` = #{month} and company_flag = 'HR'
    </select>

    <select id="getNotPayUpSellDetails" resultType="java.lang.Long">
        SELECT  sd.id from sell_details sd LEFT JOIN ord_billing_details obd on sd.number = obd.ord_no
        where obd.is_pay_up = 0 and sd.sell_detals_flag = 0
    </select>

    <select id="getProductSellDetails" resultType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsDO">
        SELECT * from sell_details where goods_line_type = 'PRODUCT_COUPON' and amount = 0
    </select>

    <delete id="deleteSellDetailsByIdList" parameterType="java.lang.Long">
        DELETE FROM  sell_details where id IN
        <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>
    
    <delete id="deleteSellDetailsById" parameterType="java.lang.Long">
        DELETE FROM sell_details WHERE id = #{id}
    </delete>
    
    <select id="isExitByNumberAndGoodsLineId" resultType="java.lang.Boolean">
        SELECT EXISTS (
                select 1 from sell_details where `number` = #{number} and goods_line_id = #{lineId}
        )
    </select>

    <select id="getCustomerSellDetailsOrderByCreateTimeDescLimit4" resultType="java.lang.String">
        select DISTINCT `NUMBER` from sell_details
        where customer_id = #{cusId} and seller_id = #{sellerId} and `number` like CONCAT('%', '_XN', '%') and
              create_time > #{dateTime}
        ORDER BY create_time DESC
    </select>

    <select id="getCustomerIsDefaultStoreAndNoSellDetailsOrder" parameterType="java.lang.Long"
            resultType="cn.com.leyizhuang.app.foundation.pojo.user.AppCustomer">

        SELECT *
        FROM cus_customer
        WHERE
            store_id IN (SELECT store_id
                         FROM st_store
                         WHERE is_default = 1 AND city_id = (SELECT city_id
                                                             FROM emp_employee
                                                             WHERE emp_id = #{sellerId}))

            AND cus_id IN (SELECT DISTINCT customer_id
                           FROM sell_details
                           WHERE seller_id = #{sellerId} and `number` like CONCAT('%', '_XN', '%'))
    </select>

    <select id="getSellDetailsFrequencyBycusIdAndSellerIdAndCreateTime" resultType="java.lang.String">
        select DISTINCT `month` from sell_details
        where customer_id = #{cusId} and seller_id = #{sellerId} and `number` like CONCAT('%', '_XN', '%') and
              create_time > #{dateTime}
        GROUP BY NUMBER
        ORDER BY create_time DESC
    </select>

    <select id="recordeErrorLog" parameterType="cn.com.leyizhuang.app.foundation.pojo.SellDetailsErrorLogDO">
        INSERT INTO  sell_details_error_log (order_no,record_time,status,error_msg) VALUES (#{orderNo},#{recordTime},#{status},#{errorMsg})
    </select>

    <select id="statisticsSellDetailsSingle" resultType="cn.com.leyizhuang.app.foundation.pojo.response.SellDetailsResponse">
        SELECT
        seller_id id,
        seller_name `name`,
        target_qty targetQty,
        finish_qty finishQty,
        finish_chance finishChance,
        flag flag
        from sell_details_single
        where `year` = #{year} and `month` = #{month} and flag = #{flag} and seller_id = #{sellerId}
    </select>

    <select id="getWeekFinishDetails" resultType="cn.com.leyizhuang.app.foundation.pojo.response.SellDetailsWeekFinishResponse">
        SELECT * from sell_details_week_finish where head_id = #{headId} order by week
    </select>

    <select id="countGDTS" resultType="java.lang.Integer">
        SELECT
        SUM(quantity)
        FROM
            sell_details s
        INNER JOIN gds_goods_grade gg ON s.sku = gg.sku
        WHERE
            s.seller_id = #{sellerId}
        AND gg.structure_code = #{structureCode}
        AND gg.goods_grade = 2
        AND s.sell_detals_flag = #{flag}
        AND s.create_time &gt; #{startTime}
        AND s.create_time &lt; #{endTime}
    </select>

    <select id="countHYS" resultType="java.lang.Long">
        SELECT
        s.customer_id
        from sell_details s INNER JOIN gds_goods_grade gg ON s.sku = gg.sku
        RIGHT JOIN cus_customer c on  s.seller_id = c.sales_consult_id
        where s.seller_id = #{sellerId} and s.create_time > #{startTime} and gg.goods_grade = 2 and gg.structure_code = #{structureCode}
        GROUP BY s.customer_id HAVING SUM(s.quantity * s.amount) > 0;
    </select>

    <select id="countXKF" resultType="java.lang.Long">
        SELECT cid.customer_id from
        (SELECT * from sell_details where create_time &lt; #{firstDay} and create_time &gt; #{halfYearAgoDate}) sd RIGHT JOIN
        (SELECT customer_id FROM sell_details s
        INNER JOIN gds_goods_grade g on s.sku = g.sku
        where
        s.create_time &gt; #{startTime}
        AND s.seller_id = #{sellerId}
        and s.create_time &lt; #{endTime}
        and g.structure_code = #{structureCode}
        and g.goods_grade = 2
        GROUP BY customer_id HAVING SUM( s.amount * s.quantity ) &gt; 0) cid on sd.customer_id = cid.customer_id
        where sd.customer_id is NULL
        GROUP BY cid.customer_id

    </select>

    <select id="cusIdFiltration" resultType="java.lang.Long">

        SELECT c.cus_id from cus_customer c
        LEFT JOIN (SELECT * from emp_owned_high_cus where emp_id = #{empId}) eo on c.mobile = eo.cus_phone
        where
        eo.cus_phone is NULL
        AND c.cus_id in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="isExitSellDetailsSingle" resultType="java.lang.Long">

        SELECT  id from sell_details_single where `year` = #{year} and `month` = #{month} and seller_id = #{sellerId} and flag = #{flag}

    </select>

    <select id="isExitSellDetailsWeek" resultType="java.lang.Long">

        SELECT  id from sell_details_week_finish where head_id = #{headId} and week = #{week}

    </select>

    <select id="getFgsRank"  resultType="cn.com.leyizhuang.app.foundation.pojo.response.SellDetailsResponse">
        SELECT
        seller_id id,
        seller_name `name`,
        target_qty targetQty,
        finish_qty finishQty,
        finish_chance finishChance,
        flag flag
        from sell_details_single
        where `year` = #{year} and `month` = #{month} and flag = #{flag} and structure_code = #{structureCode}
        ORDER BY finishQty DESC
        limit 3
    </select>

    <select id="getJtRank"  resultType="cn.com.leyizhuang.app.foundation.pojo.response.SellDetailsResponse">
        SELECT
        seller_id id,
        seller_name `name`,
        target_qty targetQty,
        finish_qty finishQty,
        finish_chance finishChance,
        flag flag
        from sell_details_single
        where `year` = #{year} and `month` = #{month} and flag = #{flag}
        ORDER BY finishQty DESC
        limit 3
    </select>

    <update id="updateOrderRecordFlagFalse">
        UPDATE ord_base_info ob LEFT JOIN
        (
            SELECT
            sd.number
            FROM
                sell_details sd
            LEFT JOIN ord_billing_details obd ON sd.number = obd.ord_no
            WHERE
                obd.is_pay_up = 0
            AND sd.sell_detals_flag = 0
            GROUP BY sd.number
        ) a on a.number = ob.ord_no
        SET ob.is_record_sales = 0 where a.number is not NULL
    </update>
</mapper>