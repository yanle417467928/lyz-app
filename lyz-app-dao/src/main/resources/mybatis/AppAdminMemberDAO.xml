<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.leyizhuang.app.foundation.dao.AppAdminMemberDAO">

    <sql id="ALL_FIELDS">
        ID, CREATOR_ID, CREATOR_TYPE, CREATE_TIME, MODIFIER_ID, MODIFIER_TYPE, MODIFY_TIME,
        member_NAME, SEX, BIRTHDAY, STORE_ID, CONSULT_ID, AUTH_ID, HEAD_IMAGE_URI, EFFECTIVE_CONSUMPTION,
        EFFECTIVE_ORDER_COUNT, LAST_LOGIN_TIME, IS_LOGIN, REGISTRATION_TIME, REGISTRATION_TYPE, IDENTITY_TYPE,
    </sql>
    <resultMap id="memberAllFields" type="cn.com.leyizhuang.app.foundation.pojo.Member">
        <id column="ID" property="id"/>
        <result column="CREATOR_ID" property="creatorId"/>
        <result column="CREATOR_TYPE" property="creatorType"/>
        <result column="CREATE_TIME" property="createTime"/>
        <result column="MODIFIER_ID" property="modifierId"/>
        <result column="MODIFIER_TYPE" property="modifierType"/>
        <result column="MODIFY_TIME" property="modifyTime"/>
        <result column="member_NAME" property="memberName"/>
        <result column="SEX" property="sex"
                javaType="cn.com.leyizhuang.app.core.constant.SexType"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="BIRTHDAY" property="birthday"/>
        <result column="STORE_ID" property="storeId"/>
        <result column="CONSULT_ID" property="consultId"/>
        <result column="AUTH_ID" property="authId"/>
        <result column="HEAD_IMAGE_URI" property="headImageUri"/>
        <result column="EFFECTIVE_CONSUMPTION" property="effectiveConsumption"/>
        <result column="EFFECTIVE_ORDER_COUNT" property="effectiveOrderCount"/>
        <result column="LAST_LOGIN_TIME" property="lastLoginTime"/>
        <result column="IS_LOGIN" property="isLogin"/>
        <result column="REGISTRATION_TIME" property="registrationTime"/>
        <result column="REGISTRATION_TYPE" property="registrationType"
                javaType="cn.com.leyizhuang.app.core.constant.RegistrationType"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="IDENTITY_TYPE" property="identityType"
                javaType="cn.com.leyizhuang.app.core.constant.IdentityType"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
    </resultMap>

    <insert id="save" parameterType="cn.com.leyizhuang.app.foundation.pojo.Member" useGeneratedKeys="true"
            keyColumn="ID" keyProperty="id">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
            select LAST_INSERT_ID()
        </selectKey>
        INSERT INTO member (
        CREATOR_ID, CREATOR_TYPE, CREATE_TIME, MODIFIER_ID, MODIFIER_TYPE, MODIFY_TIME,
        member_NAME, SEX, BIRTHDAY, STORE_ID, CONSULT_ID, HEAD_IMAGE_URI, EFFECTIVE_CONSUMPTION,
        EFFECTIVE_ORDER_COUNT, LAST_LOGIN_TIME, IS_LOGIN, REGISTRATION_TIME, REGISTRATION_TYPE,IDENTITY_TYPE
        ) VALUES (
        #{creatorId}, #{creatorType}, #{createTime}, #{modifierId}, #{modifierType}, #{modifyTime},#{memberName},
        #{sex,
            javaType=cn.com.leyizhuang.app.core.constant.SexType,
            typeHandler=org.apache.ibatis.type.EnumTypeHandler
        },
        #{birthday}, #{storeId}, #{consultId},#{headImageUri}, #{effectiveConsumption},
        #{effectiveOrderCount},#{lastLoginTime},#{isLogin},#{registrationTime},
        #{registrationType,
          javaType=cn.com.leyizhuang.app.core.constant.RegistrationType,
          typeHandler=org.apache.ibatis.type.EnumTypeHandler
         },
        #{identityType,
        javaType=cn.com.leyizhuang.app.core.constant.IdentityType,
        typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        )
    </insert>

    <select id="queryMemberVOPage" resultType="AppAdminMemberVO">
        SELECT
            m.ID            ID,
            s.STORE_NAME    STORE_NAME,
            sc.CONSULT_NAME SALES_CONSULT_NAME,
            m.IDENTITY_TYPE IDENTITY_TYPE,
            m.member_NAME   NAME,
            m.BIRTHDAY      BIRTHDAY,
            ma.MOBILE       MOBILE,
            m.SEX           SEX,
            ma.STATUS       STATUS
        FROM member m LEFT JOIN st_store s ON m.STORE_ID = s.ID
            LEFT JOIN sales_consult sc ON m.CONSULT_ID = sc.ID
            LEFT JOIN member_auth ma ON m.id = ma.member_ID
    </select>

    <select id="queryMemberVOById" resultType="AppAdminMemberVO">
        SELECT
            m.ID            ID,
            m.STORE_ID      STORE,
            m.CONSULT_ID    SALES_CONSULT,
            s.STORE_NAME    STORE_NAME,
            sc.CONSULT_NAME SALES_CONSULT_NAME,
            m.IDENTITY_TYPE IDENTITY_TYPE,
            m.member_NAME   NAME,
            DATE_FORMAT(m.BIRTHDAY,'%Y-%m-%d') BIRTHDAY,
            ma.MOBILE       MOBILE,
            m.SEX           SEX,
            ma.STATUS       STATUS
        FROM member m LEFT JOIN st_store s ON m.STORE_ID = s.ID
            LEFT JOIN sales_consult sc ON m.CONSULT_ID = sc.ID
            LEFT JOIN member_auth ma ON m.id = ma.member_ID
        WHERE m.ID = #{id};
    </select>

    <delete id="remove" parameterType="java.lang.Long">
        DELETE FROM member
        WHERE ID = #{id}
    </delete>

    <delete id="batchRemove">
        DELETE FROM member WHERE ID IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <update id="modify" parameterType="cn.com.leyizhuang.app.foundation.pojo.Member">
        UPDATE member
        <set>
            <if test="null != modifierId">
                MODIFIER_ID = #{modifierId},
            </if>
            <if test="null != modifierType">
                MODIFIER_TYPE = #{modifierType},
            </if>
            <if test="null != modifyTime">
                MODIFY_TIME = #{modifyTime},
            </if>
            <if test="null != memberName">
                member_NAME = #{memberName},
            </if>
            <if test="null != sex">
                SEX = #{sex,
                javaType=cn.com.leyizhuang.app.core.constant.SexType,
                typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            </if>
            <if test="null != birthday">
                BIRTHDAY = #{birthday},
            </if>
            <if test="null != storeId">
                STORE_ID = #{storeId},
            </if>
            <if test="null != consultId">
                CONSULT_ID = #{consultId},
            </if>
            <if test="null != headImageUri">
                HEAD_IMAGE_URI = #{headImageUri},
            </if>
            <if test="null != effectiveConsumption">
                EFFECTIVE_CONSUMPTION = #{effectiveConsumption},
            </if>
            <if test="null != effectiveOrderCount">
                EFFECTIVE_ORDER_COUNT = #{effectiveOrderCount},
            </if>
            <if test="null != lastLoginTime">
                LAST_LOGIN_TIME = #{lastLoginTime},
            </if>
            <if test="null != isLogin">
                IS_LOGIN = #{isLogin},
            </if>
            <if test="null != registrationTime">
                REGISTRATION_TIME = #{registrationTime},
            </if>
            <if test="null != registrationType">
                REGISTRATION_TYPE = #{registrationType,
                javaType=cn.com.leyizhuang.app.core.constant.RegistrationType,
                typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            </if>
            <if test="null != identityType">
                IDENTITY_TYPE = #{identityType,
                javaType=cn.com.leyizhuang.app.core.constant.IdentityType,
                typeHandler=org.apache.ibatis.type.EnumTypeHandler}
            </if>
        </set>
        WHERE ID = #{id}
    </update>

    <select id="queryById" parameterType="java.lang.Long" resultMap="memberAllFields">
        SELECT
            m.*,
            auth.MOBILE   MOBILE,
            auth.EMAIL    EMAIL,
            auth.`STATUS` `STATUS`
        FROM
            member m
            LEFT JOIN member_AUTH auth ON auth.member_ID = m.ID
        WHERE
            m.ID = #{id};
    </select>
    <!--<select id="queryAuthById" parameterType="java.lang.Long" resultMap="memberAuth">
        SELECT
        member_ID,
        USER_NAME,
        PASSWORD,
        MOBILE,
        EMAIL,
        USABLE,
        UNUSABLE_END_TIME
        FROM  member_AUTH
        WHERE member_ID = #{id}

    </select>-->

    <select id="queryList" resultMap="memberAllFields">
        SELECT
            m.*,
            ma.MOBILE,
            ma.STATUS
        FROM member m LEFT JOIN member_auth ma
                ON m.id = ma.member_ID
    </select>


</mapper>